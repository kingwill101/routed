---
id: sse
title: Server-Sent Events
sidebar_position: 8
description: Stream real-time updates with Routed's SSE helper and SseEvent codec.
---

Server-Sent Events (SSE) provide a lightweight way to push server updates over a
long-lived HTTP response. Routed ships a dedicated helper that formats frames,
handles heartbeats, and automatically disables compression so intermediaries
stay happy.

## Sending events

Use `ctx.sse(Stream<SseEvent>)` inside a route handler. The helper sets the
correct headers, disables compression, and instantly primes the stream with a
`:ok` comment so clients unblock right away:

```dart title="routes.dart"
final counter = Stream.periodic(
  const Duration(seconds: 1),
  (tick) => SseEvent(
    id: '$tick',
    event: 'count',
    data: 'tick-$tick',
  ),
);

engine.get('/stream', (ctx) => ctx.sse(counter));
```

`SseEvent` mirrors the standard fields:

| Field      | Description                                                     |
|----------- |-----------------------------------------------------------------|
| `id`       | Optional event identifier; the browser sends it as `Last-Event-ID` on reconnect. |
| `event`    | Optional event type (e.g. `message`, `count`).                   |
| `data`     | Required payload; multi-line values are split into multiple `data:` lines. |
| `retry`    | Optional reconnect delay.                                       |

Need a custom codec? `SseCodec` converts between `SseEvent` objects and raw
frames so you can buffer events or persist them.

### What the helper configures

- Sets `Cache-Control: no-cache, no-transform` and `X-Accel-Buffering: no` to
  opt out of intermediary buffering.
- Writes a priming `:ok` comment and flushes immediately so `EventSource`
  transitions to the OPEN state without waiting for additional data.
- Disables output buffering (`response.bufferOutput = false`) so every frame is
  written and flushed as soon as it is available.
- Leaves compression off; chunk aggregation or gzip buffering defeats the
  point of heartbeats and low-latency pushes.

## Heartbeats and disconnects

Keep intermediaries from timing out idle connections by enabling the heartbeat
interval:

```dart
ctx.sse(
  queue.stream,
  heartbeat: const Duration(seconds: 10),
  heartbeatComment: 'still-alive',
);
```

When no events are flowing the helper writes `:still-alive` comment frames. The
stream cancels automatically if the client disconnects or the event stream emits
an error.

## Graceful shutdown

During a graceful shutdown the engine signals draining via the
`ShutdownController`. The SSE helper polls that signal and, when draining
begins, emits a `control` event (`event: control`, `data: close`, `retry: 0`)
before closing the connection. Clients that care about graceful shutdown can
listen for that event; others simply observe the socket close promptly instead
of waiting for the next heartbeat.

Because SSE handlers now participate in the engine's request tracking, draining
waits for them to finish and the shutdown controller no longer hangs on
long-lived streams. As soon as the helper closes the response the engine
notices the active request count drop to zero and finishes the shutdown cycle.

## Error handling

- The helper catches `HttpException`s thrown when the client disappears and
  closes the response gracefully.
- If the event stream emits an error, the connection shuts down cleanly after
  cancelling the heartbeat timer.
- Compression is explicitly disabled so proxies do not buffer heartbeat frames.

## Troubleshooting tips

- **No frames arriving?** Make sure you `await ctx.sse(...)` in the handler and
  that the event stream does not complete immediately. `curl -v -N` should show
  the leading `:ok` comment followed by `data:` frames.
- **Chrome reconnects repeatedly.** Supply an `id` on each event and the browser
  will resume from the last received frame.
- **High CPU due to timers.** Increase the `heartbeat` interval or set it to
  `Duration.zero` to disable heartbeats entirely.
- **Reverse proxy buffering output?** Confirm the platform honors
  `Cache-Control: no-transform` and `X-Accel-Buffering: no`. Some managed
  hosts require an explicit opt-out to stream responses.
