"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[4993],{3704:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"fundamentals/sse","title":"Server-Sent Events","description":"Stream real-time updates with Routed\'s SSE helper and SseEvent codec.","source":"@site/docs/routed/fundamentals/sse.mdx","sourceDirName":"fundamentals","slug":"/fundamentals/sse","permalink":"/docs/routed/fundamentals/sse","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/fundamentals/sse.mdx","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"id":"sse","title":"Server-Sent Events","sidebar_position":8,"description":"Stream real-time updates with Routed\'s SSE helper and SseEvent codec."},"sidebar":"routedSidebar","previous":{"title":"Graceful shutdown","permalink":"/docs/routed/fundamentals/graceful-shutdown"},"next":{"title":"Validation","permalink":"/docs/routed/fundamentals/validation"}}');var r=t(4848),i=t(8453);const o={id:"sse",title:"Server-Sent Events",sidebar_position:8,description:"Stream real-time updates with Routed's SSE helper and SseEvent codec."},d=void 0,a={},l=[{value:"Sending events",id:"sending-events",level:2},{value:"What the helper configures",id:"what-the-helper-configures",level:3},{value:"Heartbeats and disconnects",id:"heartbeats-and-disconnects",level:2},{value:"Graceful shutdown",id:"graceful-shutdown",level:2},{value:"Error handling",id:"error-handling",level:2},{value:"Troubleshooting tips",id:"troubleshooting-tips",level:2}];function c(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Server-Sent Events (SSE) provide a lightweight way to push server updates over a\nlong-lived HTTP response. Routed ships a dedicated helper that formats frames,\nhandles heartbeats, and automatically disables compression so intermediaries\nstay happy."}),"\n",(0,r.jsx)(n.h2,{id:"sending-events",children:"Sending events"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"ctx.sse(Stream<SseEvent>)"})," inside a route handler. The helper sets the\ncorrect headers, disables compression, and instantly primes the stream with a\n",(0,r.jsx)(n.code,{children:":ok"})," comment so clients unblock right away:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:'title="routes.dart"',children:"final counter = Stream.periodic(\n  const Duration(seconds: 1),\n  (tick) => SseEvent(\n    id: '$tick',\n    event: 'count',\n    data: 'tick-$tick',\n  ),\n);\n\nengine.get('/stream', (ctx) => ctx.sse(counter));\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"SseEvent"})," mirrors the standard fields:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Field"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"id"})}),(0,r.jsxs)(n.td,{children:["Optional event identifier; the browser sends it as ",(0,r.jsx)(n.code,{children:"Last-Event-ID"})," on reconnect."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"event"})}),(0,r.jsxs)(n.td,{children:["Optional event type (e.g. ",(0,r.jsx)(n.code,{children:"message"}),", ",(0,r.jsx)(n.code,{children:"count"}),")."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"data"})}),(0,r.jsxs)(n.td,{children:["Required payload; multi-line values are split into multiple ",(0,r.jsx)(n.code,{children:"data:"})," lines."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"retry"})}),(0,r.jsx)(n.td,{children:"Optional reconnect delay."})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["Need a custom codec? ",(0,r.jsx)(n.code,{children:"SseCodec"})," converts between ",(0,r.jsx)(n.code,{children:"SseEvent"})," objects and raw\nframes so you can buffer events or persist them."]}),"\n",(0,r.jsx)(n.h3,{id:"what-the-helper-configures",children:"What the helper configures"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Sets ",(0,r.jsx)(n.code,{children:"Cache-Control: no-cache, no-transform"})," and ",(0,r.jsx)(n.code,{children:"X-Accel-Buffering: no"})," to\nopt out of intermediary buffering."]}),"\n",(0,r.jsxs)(n.li,{children:["Writes a priming ",(0,r.jsx)(n.code,{children:":ok"})," comment and flushes immediately so ",(0,r.jsx)(n.code,{children:"EventSource"}),"\ntransitions to the OPEN state without waiting for additional data."]}),"\n",(0,r.jsxs)(n.li,{children:["Disables output buffering (",(0,r.jsx)(n.code,{children:"response.bufferOutput = false"}),") so every frame is\nwritten and flushed as soon as it is available."]}),"\n",(0,r.jsx)(n.li,{children:"Leaves compression off; chunk aggregation or gzip buffering defeats the\npoint of heartbeats and low-latency pushes."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"heartbeats-and-disconnects",children:"Heartbeats and disconnects"}),"\n",(0,r.jsx)(n.p,{children:"Keep intermediaries from timing out idle connections by enabling the heartbeat\ninterval:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"ctx.sse(\n  queue.stream,\n  heartbeat: const Duration(seconds: 10),\n  heartbeatComment: 'still-alive',\n);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["When no events are flowing the helper writes ",(0,r.jsx)(n.code,{children:":still-alive"})," comment frames. The\nstream cancels automatically if the client disconnects or the event stream emits\nan error."]}),"\n",(0,r.jsx)(n.h2,{id:"graceful-shutdown",children:"Graceful shutdown"}),"\n",(0,r.jsxs)(n.p,{children:["During a graceful shutdown the engine signals draining via the\n",(0,r.jsx)(n.code,{children:"ShutdownController"}),". The SSE helper polls that signal and, when draining\nbegins, emits a ",(0,r.jsx)(n.code,{children:"control"})," event (",(0,r.jsx)(n.code,{children:"event: control"}),", ",(0,r.jsx)(n.code,{children:"data: close"}),", ",(0,r.jsx)(n.code,{children:"retry: 0"}),")\nbefore closing the connection. Clients that care about graceful shutdown can\nlisten for that event; others simply observe the socket close promptly instead\nof waiting for the next heartbeat."]}),"\n",(0,r.jsx)(n.p,{children:"Because SSE handlers now participate in the engine's request tracking, draining\nwaits for them to finish and the shutdown controller no longer hangs on\nlong-lived streams. As soon as the helper closes the response the engine\nnotices the active request count drop to zero and finishes the shutdown cycle."}),"\n",(0,r.jsx)(n.h2,{id:"error-handling",children:"Error handling"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The helper catches ",(0,r.jsx)(n.code,{children:"HttpException"}),"s thrown when the client disappears and\ncloses the response gracefully."]}),"\n",(0,r.jsx)(n.li,{children:"If the event stream emits an error, the connection shuts down cleanly after\ncancelling the heartbeat timer."}),"\n",(0,r.jsx)(n.li,{children:"Compression is explicitly disabled so proxies do not buffer heartbeat frames."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting-tips",children:"Troubleshooting tips"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No frames arriving?"})," Make sure you ",(0,r.jsx)(n.code,{children:"await ctx.sse(...)"})," in the handler and\nthat the event stream does not complete immediately. ",(0,r.jsx)(n.code,{children:"curl -v -N"})," should show\nthe leading ",(0,r.jsx)(n.code,{children:":ok"})," comment followed by ",(0,r.jsx)(n.code,{children:"data:"})," frames."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Chrome reconnects repeatedly."})," Supply an ",(0,r.jsx)(n.code,{children:"id"})," on each event and the browser\nwill resume from the last received frame."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"High CPU due to timers."})," Increase the ",(0,r.jsx)(n.code,{children:"heartbeat"})," interval or set it to\n",(0,r.jsx)(n.code,{children:"Duration.zero"})," to disable heartbeats entirely."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reverse proxy buffering output?"})," Confirm the platform honors\n",(0,r.jsx)(n.code,{children:"Cache-Control: no-transform"})," and ",(0,r.jsx)(n.code,{children:"X-Accel-Buffering: no"}),". Some managed\nhosts require an explicit opt-out to stream responses."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>d});var s=t(6540);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);