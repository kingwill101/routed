"use strict";(self.webpackChunkrouted=self.webpackChunkrouted||[]).push([[5253],{8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>d});var i=s(6540);const t={},r=i.createContext(t);function a(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(r.Provider,{value:n},e.children)}},8989:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"routed/advanced/signals","title":"Signals","description":"React to Routed lifecycle changes using Django-style signal hooks","source":"@site/docs/routed/advanced/signals.mdx","sourceDirName":"routed/advanced","slug":"/routed/advanced/signals","permalink":"/docs/routed/advanced/signals","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/advanced/signals.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Signals","description":"React to Routed lifecycle changes using Django-style signal hooks","sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Driver Registries","permalink":"/docs/routed/advanced/driver-registries"},"next":{"title":"Rate limiting design notes","permalink":"/docs/routed/advanced/rate-limiting-design"}}');var t=s(4848),r=s(8453);const a={title:"Signals",description:"React to Routed lifecycle changes using Django-style signal hooks",sidebar_position:4},d="Signals",l={},o=[{value:"When to use signals",id:"when-to-use-signals",level:2},{value:"Anatomy of a signal",id:"anatomy-of-a-signal",level:2},{value:"Built-in request signals",id:"built-in-request-signals",level:2},{value:"Listening for failures",id:"listening-for-failures",level:2},{value:"Custom signals",id:"custom-signals",level:2},{value:"Guidelines and best practices",id:"guidelines-and-best-practices",level:2},{value:"Further reading",id:"further-reading",level:2}];function c(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"signals",children:"Signals"})}),"\n",(0,t.jsxs)(n.p,{children:["Signals provide a lightweight publish/subscribe layer on top of Routed's event bus. They are inspired by Django's\n[",(0,t.jsx)(n.code,{children:"django.dispatch"}),"] signals and let packages announce that \u201csomething happened\u201d without tightly coupling senders to\nlisteners. A signal owns the list of handlers, runs them in sequence, and forwards failures to the structured\n",(0,t.jsx)(n.code,{children:"UnhandledSignalError"})," event so problems do not go unnoticed."]}),"\n",(0,t.jsxs)(n.p,{children:["Routed exposes request lifecycle signals out of the box (",(0,t.jsx)(n.code,{children:"SignalHub.requests.*"}),"), and you can create your own signals\nwhen building reusable libraries."]}),"\n",(0,t.jsx)(n.h2,{id:"when-to-use-signals",children:"When to use signals"}),"\n",(0,t.jsx)(n.p,{children:"Prefer signals when:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["You need ",(0,t.jsx)(n.em,{children:"hook points"})," where multiple consumers can react to a lifecycle change."]}),"\n",(0,t.jsxs)(n.li,{children:["You want deterministic handler ordering (",(0,t.jsx)(n.code,{children:"connect"})," preserves registration order)."]}),"\n",(0,t.jsxs)(n.li,{children:["A failing handler should produce an ",(0,t.jsx)(n.code,{children:"UnhandledSignalError"})," that you can observe in tests or logs."]}),"\n",(0,t.jsxs)(n.li,{children:["You are writing a reusable package and want a narrow dependency surface (",(0,t.jsx)(n.code,{children:"connect"})," / ",(0,t.jsx)(n.code,{children:"disconnect"})," instead of raw\n",(0,t.jsx)(n.code,{children:"StreamSubscription"}),"s)."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Prefer the event bus directly when you need ",(0,t.jsx)(n.code,{children:"Stream"})," primitives such as ",(0,t.jsx)(n.code,{children:"pause"}),", ",(0,t.jsx)(n.code,{children:"resume"}),", or broadcast fan-out beyond\nordered handlers."]}),"\n",(0,t.jsx)(n.h2,{id:"anatomy-of-a-signal",children:"Anatomy of a signal"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Signal<T>"})," is a thin adapter around the ",(0,t.jsx)(n.code,{children:"EventManager"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Use ",(0,t.jsx)(n.code,{children:"connect"})," to register a handler. It returns a ",(0,t.jsx)(n.code,{children:"SignalSubscription"})," you can ",(0,t.jsx)(n.code,{children:"cancel()"})," later."]}),"\n",(0,t.jsxs)(n.li,{children:["Provide an optional ",(0,t.jsx)(n.code,{children:"key"})," (similar to Django's ",(0,t.jsx)(n.code,{children:"dispatch_uid"}),") to replace previous registrations and avoid\nduplicates."]}),"\n",(0,t.jsxs)(n.li,{children:["Provide an optional ",(0,t.jsx)(n.code,{children:"sender"})," to scope handlers to specific publishers."]}),"\n",(0,t.jsx)(n.li,{children:"Signals dispatch the same event instances that the engine publishes."}),"\n",(0,t.jsxs)(n.li,{children:["Exceptions thrown by handlers are caught, wrapped inside ",(0,t.jsx)(n.code,{children:"UnhandledSignalError"})," (which now carries ",(0,t.jsx)(n.code,{children:"key"})," and\n",(0,t.jsx)(n.code,{children:"sender"})," metadata), and published on the event bus."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"import 'package:routed/signals.dart';\n\nFuture<void> bootMetrics(Engine engine) async {\n  final hub = await engine.container.make<SignalHub>();\n\n  final subscription = hub.requests.routeMatched.connect(\n    (event) {\n      metrics.increment('routes.matched', tags: {\n        'route': event.route.name ?? event.route.path,\n      });\n    },\n    key: 'metrics.route_matched',\n  );\n\n  // Engine exposes the resolved [EngineRoute] instances after routes are built.\n  final dashboardRoute = engine.routes.firstWhere((route) => route.name == 'dashboard');\n  hub.requests.afterRouting.connect(\n    (event) {\n      metrics.increment('routes.completed', tags: {'route': 'dashboard'});\n    },\n    sender: dashboardRoute,\n    key: 'metrics.dashboard.after',\n  );\n\n  engine.onShutdown(() => subscription.cancel());\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Handlers run sequentially in the order they were connected. If a handler throws, the signal continues dispatching the\nremaining handlers after emitting ",(0,t.jsx)(n.code,{children:"UnhandledSignalError"}),". Request signals dispatch a ",(0,t.jsx)(n.code,{children:"RequestSignalSender"})," that wraps\nthe active ",(0,t.jsx)(n.code,{children:"EngineContext"})," and optional ",(0,t.jsx)(n.code,{children:"EngineRoute"}),", so you can scope handlers to the full request, a particular\nroute, or both."]}),"\n",(0,t.jsx)(n.h2,{id:"built-in-request-signals",children:"Built-in request signals"}),"\n",(0,t.jsxs)(n.p,{children:["The routing provider wires a ",(0,t.jsx)(n.code,{children:"SignalHub"})," into the container. Resolve it from any scope that can access the engine\ncontainer, or use ",(0,t.jsx)(n.code,{children:"AppZone.signals"})," inside request handlers and middleware."]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Signal"}),(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"When it fires"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"hub.requests.started"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RequestStartedEvent"})}),(0,t.jsx)(n.td,{children:"After the request context and container are initialised, before routing begins."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"hub.requests.routeMatched"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RouteMatchedEvent"})}),(0,t.jsx)(n.td,{children:"As soon as the router finds a matching route."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"hub.requests.routingError"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RoutingErrorEvent"})}),(0,t.jsx)(n.td,{children:"When a handler or middleware throws during request processing."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"hub.requests.afterRouting"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AfterRoutingEvent"})}),(0,t.jsx)(n.td,{children:"After the middleware/handler pipeline completes (success or failure)."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"hub.requests.finished"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RequestFinishedEvent"})}),(0,t.jsx)(n.td,{children:"After routing completes and the engine performs its final bookkeeping."})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"Inside request code you can avoid container access entirely:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"import 'package:routed/routed.dart';\n\nrouter.get('/checkout', (ctx) async {\n  final signals = AppZone.signals;\n\n  final cleanup = signals.requests.finished.connect(\n    (event) {\n      audit.log('checkout_complete', event.context.request.id);\n    },\n    sender: AppZone.context, // request-scoped\n    key: 'audit.checkout_finished',\n  );\n\n  try {\n    // ...\n  } finally {\n    await cleanup.cancel();\n  }\n\n  return ctx.json({'ok': true});\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"listening-for-failures",children:"Listening for failures"}),"\n",(0,t.jsx)(n.p,{children:"Attach a listener to the event bus when you want visibility into handler errors. The signal publishes immediately,\nallowing tests to await the error synchronously:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"final events = await engine.container.make<EventManager>();\n\nevents.on<UnhandledSignalError>().listen((event) {\n  logger.error(\n    'Signal ${event.name} (key=${event.key}) failed for sender ${event.sender}',\n    event.error,\n    event.stack,\n  );\n});\n"})}),"\n",(0,t.jsx)(n.p,{children:"Because the publish happens synchronously, you can await futures that complete in a handler and still detect failures\nwithout races."}),"\n",(0,t.jsx)(n.h2,{id:"custom-signals",children:"Custom signals"}),"\n",(0,t.jsxs)(n.p,{children:["You can create your own signals by instantiating ",(0,t.jsx)(n.code,{children:"Signal<T>"})," and calling ",(0,t.jsx)(n.code,{children:"dispatch"})," manually. This is useful when\nauthoring packages that want to expose hooks without leaking their internal event classes."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"final class MailSent extends Event {\n  MailSent(this.messageId);\n  final String messageId;\n}\n\nfinal Signal<MailSent> mailSent = Signal<MailSent>(\n  name: 'example.mail.sent',\n  manager: eventManager,\n);\n\nFuture<void> deliverMail(String to, String body) async {\n  final id = await provider.send(to: to, body: body);\n  await mailSent.dispatch(\n    MailSent(id),\n    sender: provider,\n  );\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Choose descriptive signal names (",(0,t.jsx)(n.code,{children:"vendor.domain.action"}),") so downstream packages can filter them. If you publish signals\nfrom a service provider, register them in ",(0,t.jsx)(n.code,{children:"boot"})," and clean up the handlers in ",(0,t.jsx)(n.code,{children:"cleanup"}),". When targeting the built-in\nrequest signals you can also scope to a specific route by registering with ",(0,t.jsx)(n.code,{children:"sender: engine.findRoute('dashboard')"})," (the\nsame ",(0,t.jsx)(n.code,{children:"EngineRoute"})," instance the router uses)."]}),"\n",(0,t.jsx)(n.h2,{id:"guidelines-and-best-practices",children:"Guidelines and best practices"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Connect early, disconnect reliably"})," \u2013 retain the function passed to ",(0,t.jsx)(n.code,{children:"connect"})," if you plan to disconnect later. For\nshort-lived handlers wrap them in ",(0,t.jsx)(n.code,{children:"try/finally"}),", or rely on the returned ",(0,t.jsx)(n.code,{children:"SignalSubscription"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Use keys to prevent duplicates"})," \u2013 supply a ",(0,t.jsx)(n.code,{children:"key"})," whenever you register a global handler so repeated bootstraps\noverwrite the previous handler instead of appending duplicates."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Scope to senders when possible"})," \u2013 filtering by sender keeps handlers tightly focused and reduces unexpected side\neffects. Handlers can provide an ",(0,t.jsx)(n.code,{children:"EngineContext"}),", an ",(0,t.jsx)(n.code,{children:"EngineRoute"}),", or a custom object when connecting."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Document payload shape"})," \u2013 signals reuse event classes; link to their definitions so consumers know available\ncontext."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Avoid side effects in error listeners"})," \u2013 ",(0,t.jsx)(n.code,{children:"UnhandledSignalError"})," handlers should log or emit metrics. Do not throw\nunless you intend to crash the process."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Unit test signal flows"})," \u2013 Integration tests can attach handlers to ",(0,t.jsx)(n.code,{children:"SignalHub"})," and assert order or error handling,\nas seen in ",(0,t.jsx)(n.code,{children:"packages/routed/test/events/signal_test.dart"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"further-reading",children:"Further reading"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"./events",children:(0,t.jsx)(n.code,{children:"Events"})})," \u2013 the lower-level event bus API that powers signals."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/routed/fundamentals/middleware",children:(0,t.jsx)(n.code,{children:"Request context"})})," \u2013 see how ",(0,t.jsx)(n.code,{children:"AppZone"})," exposes the signal hub."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"examples/signals.dart"})," \u2013 runnable sample that logs signal activity and error handling."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);