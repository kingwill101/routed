"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[7721],{8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var s=i(6540);const r={},t=s.createContext(r);function a(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(t.Provider,{value:n},e.children)}},8480:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"examples/session-auth","title":"Session Auth & Guards","description":"Session-backed login with remember-me tokens and declarative guards","source":"@site/docs/routed/examples/session-auth.mdx","sourceDirName":"examples","slug":"/examples/session-auth","permalink":"/docs/routed/examples/session-auth","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/examples/session-auth.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Session Auth & Guards","description":"Session-backed login with remember-me tokens and declarative guards","sidebar_position":2},"sidebar":"routedSidebar","previous":{"title":"REST API Skeleton","permalink":"/docs/routed/examples/rest-api"},"next":{"title":"Liquid Page Rendering","permalink":"/docs/routed/examples/liquid-page"}}');var r=i(4848),t=i(8453);const a={title:"Session Auth & Guards",description:"Session-backed login with remember-me tokens and declarative guards",sidebar_position:2},o="Session Auth & Guards",d={},l=[{value:"1. Configure the engine",id:"1-configure-the-engine",level:2},{value:"2. Register guards and gates",id:"2-register-guards-and-gates",level:2},{value:"3. Build routes",id:"3-build-routes",level:2},{value:"4. Configuration reference",id:"4-configuration-reference",level:2},{value:"5. Migration checklist",id:"5-migration-checklist",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"session-auth--guards",children:"Session Auth & Guards"})}),"\n",(0,r.jsx)(n.p,{children:"Session-backed auth in Routed combines three pieces:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SessionAuthService"})," keeps the principal in the session (with optional remember-me cookies)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GuardRegistry"})," provides coarse policies like \u201cauthenticated\u201d or \u201chas roles\u201d."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Haigate"})," adds Laravel-style gates for ability-level checks (",(0,r.jsx)(n.code,{children:"publish-post"}),", ",(0,r.jsx)(n.code,{children:"approve-expense"}),", \u2026)."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The snippet below shows them working together so you can drop the pattern into your app."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'dart:convert';\nimport 'dart:io';\n\nimport 'package:routed/routed.dart';\n\nconst _appKey =\n    'base64:MTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkwMTIzNDU2Nzg5MDEyMzQ1Ng==';\n\nfinal users = <String, Map<String, Object?>>{\n  'taylor': {\n    'password': 'password123',\n    'roles': ['admin'],\n    'name': 'Taylor',\n  },\n  'sasha': {\n    'password': 'password123',\n    'roles': ['support'],\n    'name': 'Sasha',\n  },\n};\n"})}),"\n",(0,r.jsx)(n.h2,{id:"1-configure-the-engine",children:"1. Configure the engine"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  config: EngineConfig(\n    security: const EngineSecurityFeatures(csrfProtection: false),\n  ),\n  options: [\n    withSessionConfig(\n      SessionConfig.cookie(\n        appKey: _appKey,\n        cookieName: 'example_session',\n      ),\n    ),\n  ],\n);\n\nengine.addGlobalMiddleware(SessionAuth.sessionAuthMiddleware());\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"withSessionConfig"})," enables cookie sessions so ",(0,r.jsx)(n.code,{children:"ctx.session"})," and ",(0,r.jsx)(n.code,{children:"SessionAuth"})," work."]}),"\n",(0,r.jsx)(n.li,{children:"The global middleware hydrates principals on every request and rotates remember tokens."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"2-register-guards-and-gates",children:"2. Register guards and gates"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"SessionAuth.configure(rememberStore: InMemoryRememberTokenStore());\n\nGuardRegistry.instance\n  ..register('authenticated', requireAuthenticated(realm: 'Example App'))\n  ..register('admin', requireRoles(['admin']))\n  ..register('support-any', requireRoles(['support', 'editor'], any: true));\n\nHaigate.register('reports.publish', (evaluation) {\n  final principal = evaluation.principal;\n  if (principal == null) return false;\n  return principal.hasRole('admin') || principal.hasRole('publisher');\n});\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Guards handle broad route policies; gates focus on individual abilities and receive the full context + principal."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"3-build-routes",children:"3. Build routes"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"engine.post('/login', (ctx) async {\n  final payload =\n      jsonDecode(await ctx.request.body()) as Map<String, Object?>;\n\n  final username = payload['username']?.toString() ?? '';\n  final password = payload['password']?.toString() ?? '';\n  final remember = payload['remember'] == true;\n\n  final record = users[username];\n  if (record == null || record['password'] != password) {\n    ctx.response\n      ..statusCode = HttpStatus.unauthorized\n      ..write('Invalid credentials');\n    return ctx.response;\n  }\n\n  final principal = AuthPrincipal(\n    id: username,\n    roles: List<String>.from(record['roles'] as List),\n    attributes: {'name': record['name']},\n  );\n\n  await SessionAuth.login(ctx, principal, rememberMe: remember);\n  return ctx.json({'id': principal.id, 'roles': principal.roles});\n});\n\nengine.get(\n  '/whoami',\n  (ctx) {\n    final principal = SessionAuth.current(ctx)!;\n    return ctx.json({\n      'id': principal.id,\n      'roles': principal.roles,\n      'attributes': principal.attributes,\n    });\n  },\n  middlewares: [guardMiddleware(['authenticated'])],\n);\n\nengine.get(\n  '/admin',\n  (ctx) => ctx.string('Welcome ${SessionAuth.current(ctx)!.id}'),\n  middlewares: [guardMiddleware(['authenticated', 'admin'])],\n);\n\nengine.post(\n  '/reports/publish',\n  (ctx) async {\n    await Haigate.authorize('reports.publish', ctx: ctx);\n    return ctx.string('published');\n  },\n  middlewares: [Haigate.middleware(['reports.publish'])],\n);\n\nengine.post('/logout', (ctx) async {\n  await SessionAuth.logout(ctx);\n  ctx.destroySession();\n  return ctx.json({'message': 'Signed out'});\n});\n\nawait engine.initialize();\nawait engine.serve(host: 'localhost', port: 8080);\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Guards short-circuit with their response (or ",(0,r.jsx)(n.code,{children:"403"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Gates work both imperatively (",(0,r.jsx)(n.code,{children:"Haigate.authorize"}),") and declaratively (",(0,r.jsx)(n.code,{children:"Haigate.middleware([...])"}),") so manifests stay tidy while handlers can still run custom logic before authorization."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"4-configuration-reference",children:"4. Configuration reference"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="config/http.yaml"',children:"auth:\n  session:\n    remember_me:\n      cookie: remember_token\n      duration: 45d\n\n  guards:\n    staff-any:\n      type: roles_any\n      roles: ['support', 'editor']\n\n  features:\n    haigate: { enabled: true }\n  gates:\n    defaults:\n      denied_status: 401\n      denied_message: Gate denied\n    abilities:\n      reports.publish:\n        roles: ['publisher']\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"auth.session.remember_me"})," houses cookie/timing defaults."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"auth.guards"})," mirrors imperative guard registration for manifest-driven setups."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"auth.features.haigate.enabled"})," toggles provider wiring; entries under ",(0,r.jsx)(n.code,{children:"auth.gates.abilities"})," become middleware IDs (",(0,r.jsx)(n.code,{children:"routed.auth.gate.reports.publish"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"5-migration-checklist",children:"5. Migration checklist"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Replace direct session reads/writes with ",(0,r.jsx)(n.code,{children:"SessionAuth.login"}),", ",(0,r.jsx)(n.code,{children:"SessionAuth.current"}),", and ",(0,r.jsx)(n.code,{children:"SessionAuth.logout"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Attach ",(0,r.jsx)(n.code,{children:"SessionAuth.sessionAuthMiddleware()"})," globally so every request hydrates the principal."]}),"\n",(0,r.jsx)(n.li,{children:"Move coarse checks into guards and register them once (or declare them in config)."}),"\n",(0,r.jsxs)(n.li,{children:["Add gates for per-action authorization and reference them through middleware or ",(0,r.jsx)(n.code,{children:"Haigate.authorize"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Provide a durable ",(0,r.jsx)(n.code,{children:"RememberTokenStore"})," implementation if remember-me must survive restarts (the in-memory default is for tests only)."]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);