"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[7228],{2390:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"uploads","title":"Uploads","description":"Configure safe file uploads and storage constraints","source":"@site/docs/routed/uploads.mdx","sourceDirName":".","slug":"/uploads","permalink":"/docs/routed/uploads","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/uploads.mdx","tags":[],"version":"current","sidebarPosition":22,"frontMatter":{"title":"Uploads","description":"Configure safe file uploads and storage constraints","sidebar_position":22},"sidebar":"routedSidebar","previous":{"title":"Storage","permalink":"/docs/routed/storage"},"next":{"title":"Docker Deployment Guide for Routed","permalink":"/docs/routed/docker"}}');var s=n(4848),d=n(8453);const t={title:"Uploads",description:"Configure safe file uploads and storage constraints",sidebar_position:22},r="Uploads",a={},c=[{value:"Configuration",id:"configuration",level:2},{value:"Configuration via Code",id:"configuration-via-code",level:3},{value:"Handling Uploads",id:"handling-uploads",level:2},{value:"Single File",id:"single-file",level:3},{value:"Multiple Files",id:"multiple-files",level:3},{value:"Accessing Form Fields",id:"accessing-form-fields",level:3},{value:"Context Extension Methods",id:"context-extension-methods",level:2},{value:"<code>MultipartFile</code>",id:"multipartfile",level:2},{value:"Enforcement Behavior",id:"enforcement-behavior",level:2},{value:"Validation Rules",id:"validation-rules",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Security Checklist",id:"security-checklist",level:2},{value:"Next Steps",id:"next-steps",level:2}];function o(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.header,{children:(0,s.jsx)(i.h1,{id:"uploads",children:"Uploads"})}),"\n",(0,s.jsx)(i.p,{children:"Routed handles file uploads via multipart form parsing with configurable size limits, extension whitelists, and disk quotas. Limits are enforced during streaming \u2014 oversized or disallowed files are rejected and cleaned up automatically."}),"\n",(0,s.jsx)(i.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-yaml",metastring:'title="config/uploads.yaml"',children:"uploads:\n  max_memory: 33554432       # 32 MB \u2014 max in-memory buffer for non-file fields\n  max_file_size: 10485760    # 10 MB \u2014 per-file size limit\n  max_disk_usage: 33554432   # 32 MB \u2014 aggregate disk quota per request\n  allowed_extensions:\n    - jpg\n    - jpeg\n    - png\n    - gif\n    - pdf\n  directory: uploads         # upload directory (falls back to temp dir if empty)\n  permissions: 750           # Unix file permissions for uploaded files\n"})}),"\n",(0,s.jsx)(i.h3,{id:"configuration-via-code",children:"Configuration via Code"}),"\n",(0,s.jsxs)(i.p,{children:["You can also configure uploads programmatically with ",(0,s.jsx)(i.code,{children:"withMultipart"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-dart",children:"final engine = await Engine.create(options: [\n  withMultipart(\n    maxMemory: 16 * 1024 * 1024,\n    maxFileSize: 5 * 1024 * 1024,\n    allowedExtensions: {'jpg', 'png', 'webp'},\n  ),\n]);\n"})}),"\n",(0,s.jsxs)(i.p,{children:["Or use ",(0,s.jsx)(i.code,{children:"configItems"})," on ",(0,s.jsx)(i.code,{children:"Engine.create"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-dart",children:"final engine = await Engine.create(configItems: {\n  'uploads.max_file_size': 5 * 1024 * 1024,\n  'uploads.allowed_extensions': ['jpg', 'png', 'webp'],\n});\n"})}),"\n",(0,s.jsx)(i.h2,{id:"handling-uploads",children:"Handling Uploads"}),"\n",(0,s.jsx)(i.h3,{id:"single-file",children:"Single File"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-dart",children:"engine.post('/avatar', (ctx) async {\n  final file = ctx.formFile('avatar');\n  if (file == null) {\n    return ctx.json({'error': 'No file uploaded'}, statusCode: 400);\n  }\n\n  await ctx.saveUploadedFile(file, 'uploads/${file.filename}');\n  return ctx.json({'saved': file.filename});\n});\n"})}),"\n",(0,s.jsx)(i.h3,{id:"multiple-files",children:"Multiple Files"}),"\n",(0,s.jsxs)(i.p,{children:["When a form contains multiple files with the same field name, ",(0,s.jsx)(i.code,{children:"multipartForm()"})," collects all of them:"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-dart",children:"engine.post('/gallery', (ctx) async {\n  final form = await ctx.multipartForm();\n  final files = form.files; // List<MultipartFile>\n\n  for (final file in files) {\n    await ctx.saveUploadedFile(file, 'uploads/gallery/${file.filename}');\n  }\n\n  return ctx.json({'uploaded': files.length});\n});\n"})}),"\n",(0,s.jsx)(i.h3,{id:"accessing-form-fields",children:"Accessing Form Fields"}),"\n",(0,s.jsx)(i.p,{children:"Multipart forms can contain both files and regular fields:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-dart",children:"engine.post('/profile', (ctx) async {\n  final form = await ctx.multipartForm();\n\n  // Regular form fields\n  final name = ctx.postForm('name');\n  final bio = ctx.postForm('bio');\n  final defaultRole = ctx.defaultPostForm('role', 'user');\n\n  // Array fields (e.g., multiple checkboxes)\n  final tags = ctx.postFormArray('tags'); // List<String>\n\n  // File upload\n  final avatar = ctx.formFile('avatar');\n\n  // ...\n});\n"})}),"\n",(0,s.jsx)(i.h2,{id:"context-extension-methods",children:"Context Extension Methods"}),"\n",(0,s.jsxs)(i.p,{children:["The ",(0,s.jsx)(i.code,{children:"MultipartFormMethods"})," extension on ",(0,s.jsx)(i.code,{children:"EngineContext"})," provides:"]}),"\n",(0,s.jsxs)(i.table,{children:[(0,s.jsx)(i.thead,{children:(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.th,{children:"Method"}),(0,s.jsx)(i.th,{children:"Return Type"}),(0,s.jsx)(i.th,{children:"Description"})]})}),(0,s.jsxs)(i.tbody,{children:[(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"multipartForm()"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"Future<MultipartForm>"})}),(0,s.jsx)(i.td,{children:"Parse and cache the full multipart form"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"formFile(name)"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"MultipartFile?"})}),(0,s.jsx)(i.td,{children:"Get a single uploaded file by field name"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"saveUploadedFile(file, dest)"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"Future<void>"})}),(0,s.jsx)(i.td,{children:"Copy an uploaded file to a destination path"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"postForm(key)"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"String?"})}),(0,s.jsx)(i.td,{children:"Get a single form field value"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"defaultPostForm(key, default)"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"String"})}),(0,s.jsx)(i.td,{children:"Get a form field with fallback"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"postFormArray(key)"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"List<String>"})}),(0,s.jsx)(i.td,{children:"Get all values for a repeated field"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"postFormMap(key)"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"Map<String, dynamic>"})}),(0,s.jsx)(i.td,{children:"Get the entire form data map"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"form()"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"Map<String, dynamic>"})}),(0,s.jsx)(i.td,{children:"Alias for all form data"})]})]})]}),"\n",(0,s.jsx)(i.h2,{id:"multipartfile",children:(0,s.jsx)(i.code,{children:"MultipartFile"})}),"\n",(0,s.jsxs)(i.p,{children:["Each uploaded file is represented as a ",(0,s.jsx)(i.code,{children:"MultipartFile"}),":"]}),"\n",(0,s.jsxs)(i.table,{children:[(0,s.jsx)(i.thead,{children:(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.th,{children:"Property"}),(0,s.jsx)(i.th,{children:"Type"}),(0,s.jsx)(i.th,{children:"Description"})]})}),(0,s.jsxs)(i.tbody,{children:[(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"name"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"String"})}),(0,s.jsx)(i.td,{children:"The form field name"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"filename"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"String"})}),(0,s.jsx)(i.td,{children:"The original file name (sanitized)"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"path"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"String"})}),(0,s.jsx)(i.td,{children:"Temporary file path on disk"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"size"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"int"})}),(0,s.jsx)(i.td,{children:"File size in bytes"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"contentType"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"String?"})}),(0,s.jsxs)(i.td,{children:["MIME type from the ",(0,s.jsx)(i.code,{children:"Content-Type"})," header"]})]})]})]}),"\n",(0,s.jsx)(i.h2,{id:"enforcement-behavior",children:"Enforcement Behavior"}),"\n",(0,s.jsx)(i.p,{children:"Limits are enforced during streaming, not after the upload completes:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Per-file size"})," (",(0,s.jsx)(i.code,{children:"max_file_size"}),") \u2014 the file is streamed to disk in chunks. If it exceeds the limit, writing stops, the partial file is deleted, and a ",(0,s.jsx)(i.code,{children:"FileTooLargeException"})," is raised."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Extension whitelist"})," (",(0,s.jsx)(i.code,{children:"allowed_extensions"}),") \u2014 checked before writing begins. Files with disallowed extensions are rejected with a ",(0,s.jsx)(i.code,{children:"FileExtensionNotAllowedException"}),"."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Aggregate disk quota"})," (",(0,s.jsx)(i.code,{children:"max_disk_usage"}),") \u2014 tracks cumulative bytes across all files in a single request. When exceeded, a ",(0,s.jsx)(i.code,{children:"FileQuotaExceededException"})," is raised and the file is cleaned up."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Filename sanitization"})," \u2014 filenames are sanitized to remove path traversal characters and special symbols. Each file gets a unique prefix (",(0,s.jsx)(i.code,{children:"upload_<microseconds>_<sanitizedName>"}),") to prevent collisions."]}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"On any failure during multipart parsing, all files created during that request are deleted and disk quota allocations are released."}),"\n",(0,s.jsx)(i.h2,{id:"validation-rules",children:"Validation Rules"}),"\n",(0,s.jsx)(i.p,{children:"You can validate uploaded files using the built-in validation rules:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-dart",children:"engine.post('/upload', (ctx) async {\n  await ctx.validate({\n    'document': 'file|max_file_size:5242880',          // 5 MB\n    'image': 'file|allowed_mime_types:image/jpeg,image/png',\n  });\n  // ...\n});\n"})}),"\n",(0,s.jsxs)(i.table,{children:[(0,s.jsx)(i.thead,{children:(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.th,{children:"Rule"}),(0,s.jsx)(i.th,{children:"Description"})]})}),(0,s.jsxs)(i.tbody,{children:[(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"file"})}),(0,s.jsxs)(i.td,{children:["Validates that the value is a ",(0,s.jsx)(i.code,{children:"MultipartFile"})]})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"max_file_size:bytes"})}),(0,s.jsxs)(i.td,{children:["Validates ",(0,s.jsx)(i.code,{children:"file.size <= bytes"})]})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"allowed_mime_types:type1,type2"})}),(0,s.jsxs)(i.td,{children:["Validates ",(0,s.jsx)(i.code,{children:"file.contentType"})," is in the list"]})]})]})]}),"\n",(0,s.jsx)(i.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(i.p,{children:"Upload violations throw specific exceptions you can catch in middleware or error handlers:"}),"\n",(0,s.jsxs)(i.table,{children:[(0,s.jsx)(i.thead,{children:(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.th,{children:"Exception"}),(0,s.jsx)(i.th,{children:"When"})]})}),(0,s.jsxs)(i.tbody,{children:[(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"FileTooLargeException"})}),(0,s.jsxs)(i.td,{children:["A single file exceeds ",(0,s.jsx)(i.code,{children:"max_file_size"})]})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"FileExtensionNotAllowedException"})}),(0,s.jsxs)(i.td,{children:["File extension not in ",(0,s.jsx)(i.code,{children:"allowed_extensions"})]})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"FileQuotaExceededException"})}),(0,s.jsxs)(i.td,{children:["Aggregate ",(0,s.jsx)(i.code,{children:"max_disk_usage"})," exceeded"]})]})]})]}),"\n",(0,s.jsx)(i.p,{children:"Each exception carries details (the limit that was exceeded, the disallowed extension, etc.) that you can use in error responses."}),"\n",(0,s.jsx)(i.h2,{id:"security-checklist",children:"Security Checklist"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["Set ",(0,s.jsx)(i.code,{children:"allowed_extensions"})," to a strict whitelist appropriate for your application"]}),"\n",(0,s.jsxs)(i.li,{children:["Keep ",(0,s.jsx)(i.code,{children:"max_file_size"})," and ",(0,s.jsx)(i.code,{children:"max_disk_usage"})," as low as your use case allows"]}),"\n",(0,s.jsxs)(i.li,{children:["Use ",(0,s.jsx)(i.code,{children:"uploads.directory"})," to isolate uploaded files from application code"]}),"\n",(0,s.jsx)(i.li,{children:"Never serve the upload directory directly \u2014 use a storage abstraction or CDN"}),"\n",(0,s.jsx)(i.li,{children:"Validate MIME types in addition to extensions for defense in depth"}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.a,{href:"/docs/routed/security/upload-hardening",children:"Security: Upload Hardening"})," \u2014 defense-in-depth strategies"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.a,{href:"/docs/routed/storage",children:"Storage"})," \u2014 storage drivers and disk abstraction"]}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,d.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>t,x:()=>r});var l=n(6540);const s={},d=l.createContext(s);function t(e){const i=l.useContext(d);return l.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),l.createElement(d.Provider,{value:i},e.children)}}}]);