"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[9940],{7180:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"fundamentals/compression","title":"Response compression","description":"Configure Routed\'s response compression middleware, override defaults, and validate behaviour.","source":"@site/docs/routed/fundamentals/compression.mdx","sourceDirName":"fundamentals","slug":"/fundamentals/compression","permalink":"/docs/routed/fundamentals/compression","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/fundamentals/compression.mdx","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"id":"compression","title":"Response compression","sidebar_position":8,"description":"Configure Routed\'s response compression middleware, override defaults, and validate behaviour."},"sidebar":"routedSidebar","previous":{"title":"Data Binding","permalink":"/docs/routed/fundamentals/binding"},"next":{"title":"Graceful shutdown","permalink":"/docs/routed/fundamentals/graceful-shutdown"}}');var o=s(4848),t=s(8453);const i={id:"compression",title:"Response compression",sidebar_position:8,description:"Configure Routed's response compression middleware, override defaults, and validate behaviour."},d=void 0,l={},a=[{value:"Enablement and defaults",id:"enablement-and-defaults",level:2},{value:"Per-route overrides",id:"per-route-overrides",level:2},{value:"Verifying behaviour locally",id:"verifying-behaviour-locally",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function c(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["Routed  ships gzip and Brotli response compression through the new\n",(0,o.jsx)(n.code,{children:"routed.compression"})," provider. The middleware automatically negotiates with the\nclient's ",(0,o.jsx)(n.code,{children:"Accept-Encoding"})," header, respects MIME / size allow-lists, and can be\nopted out per route when needed."]}),"\n",(0,o.jsx)(n.h2,{id:"enablement-and-defaults",children:"Enablement and defaults"}),"\n",(0,o.jsxs)(n.p,{children:["Compression is enabled by default when the engine bootstraps built-in\nproviders. The default configuration lives under the ",(0,o.jsx)(n.code,{children:"compression.*"})," namespace\nand can be overridden in ",(0,o.jsx)(n.code,{children:"config/http.yaml"})," (or any manifest override):"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title="config/http.yaml"',children:"compression:\n  enabled: true\n  min_length: 1024           # bytes before compression kicks in\n  algorithms: [br, gzip]     # priority order\n  mime_allow:\n    - text/*\n    - application/json\n    - application/javascript\n  mime_deny:\n    - image/*\n    - audio/*\n    - video/*\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Set ",(0,o.jsx)(n.code,{children:"compression.enabled"})," to ",(0,o.jsx)(n.code,{children:"false"})," to remove the middleware entirely."]}),"\n",(0,o.jsx)(n.h2,{id:"per-route-overrides",children:"Per-route overrides"}),"\n",(0,o.jsxs)(n.p,{children:["Handlers can opt out on demand by calling the helper exposed from\n",(0,o.jsx)(n.code,{children:"routed/middlewares.dart"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",metastring:'title="Disable compression for a specific route"',children:"import 'package:routed/middlewares.dart';\n\nengine.get('/stream', (ctx) {\n  disableCompression(ctx);\n  return ctx.stream(somePreCompressedStream);\n});\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Routes that return small payloads can also leave compression enabled\u2014the\nmiddleware tracks ",(0,o.jsx)(n.code,{children:"compression.min_length"})," and simply passes through the response\nwhen it falls below the threshold."]}),"\n",(0,o.jsx)(n.h2,{id:"verifying-behaviour-locally",children:"Verifying behaviour locally"}),"\n",(0,o.jsxs)(n.p,{children:["Use ",(0,o.jsx)(n.code,{children:"curl"})," (or any HTTP client) to confirm headers are present when the client\nadvertises support:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"curl --compressed -I http://127.0.0.1:8080/greet\n# ...\n# content-encoding: br\n# vary: Accept-Encoding\n"})}),"\n",(0,o.jsx)(n.p,{children:"For a quick health check during development, run the benchmark helper that ships\nin the repo:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"dart run tool/compression_benchmark.dart\n"})}),"\n",(0,o.jsx)(n.p,{children:"Sample output on a MacBook Pro (M1 Pro) shows why the default thresholds favour\ngzip for smaller payloads but keep Brotli enabled for larger responses:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"--- json_small ---\ninput_bytes=45\ngzip -> bytes=65 avg_us=33.44\nbrotli -> bytes=49 avg_us=546.60\n--- json_large ---\ninput_bytes=44000\ngzip -> bytes=168 avg_us=110.50\nbrotli -> bytes=40 avg_us=2169.45\n--- html_large ---\ninput_bytes=58500\ngzip -> bytes=247 avg_us=143.51\nbrotli -> bytes=50 avg_us=2766.77\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Gzip runs much faster for tiny payloads, while Brotli yields the best size\nreduction for larger documents. Adjust ",(0,o.jsx)(n.code,{children:"compression.min_length"})," or the algorithm\nlist if your workload trends heavily toward one side."]}),"\n",(0,o.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Unexpected MIME types"})," \u2013 add/remove entries in ",(0,o.jsx)(n.code,{children:"compression.mime_allow"}),"\nand ",(0,o.jsx)(n.code,{children:"compression.mime_deny"})," to match your application's content types."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Handlers return pre-compressed data"})," \u2013 call ",(0,o.jsx)(n.code,{children:"disableCompression(ctx)"})," or\nset the ",(0,o.jsx)(n.code,{children:"Content-Encoding"})," header early; the middleware will detect the header\nand avoid double-compressing."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Client still sees plain responses"})," \u2013 confirm the client sends\n",(0,o.jsx)(n.code,{children:"Accept-Encoding"})," and that your runtime (for example, a reverse proxy or test\nclient) does not transparently decompress responses."]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>d});var r=s(6540);const o={},t=r.createContext(o);function i(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);