"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[2860],{5899:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"fundamentals/http-semantics","title":"HTTP Semantics","description":"Content negotiation, conditional requests, and automatic OPTIONS responses","source":"@site/docs/routed/fundamentals/http-semantics.mdx","sourceDirName":"fundamentals","slug":"/fundamentals/http-semantics","permalink":"/docs/routed/fundamentals/http-semantics","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/fundamentals/http-semantics.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"HTTP Semantics","description":"Content negotiation, conditional requests, and automatic OPTIONS responses","sidebar_position":5},"sidebar":"routedSidebar","previous":{"title":"Context Data","permalink":"/docs/routed/fundamentals/context-data"},"next":{"title":"Headers","permalink":"/docs/routed/fundamentals/headers"}}');var s=t(4848),d=t(8453);const a={title:"HTTP Semantics",description:"Content negotiation, conditional requests, and automatic OPTIONS responses",sidebar_position:5},c=void 0,r={},o=[{value:"Content Negotiation",id:"content-negotiation",level:2},{value:"<code>ctx.negotiate</code>",id:"ctxnegotiate",level:3},{value:"<code>ctx.negotiateContentType</code>",id:"ctxnegotiatecontenttype",level:3},{value:"<code>ContentNegotiator.negotiate</code> (Advanced)",id:"contentnegotiatornegotiate-advanced",level:3},{value:"Convenience Getters",id:"convenience-getters",level:3},{value:"Conditional Requests",id:"conditional-requests",level:2},{value:"The Middleware",id:"the-middleware",level:3},{value:"ETag Generators",id:"etag-generators",level:3},{value:"<code>resolveDefaultEtag</code>",id:"resolvedefaultetag",level:3},{value:"ETag Strategy Configuration",id:"etag-strategy-configuration",level:3},{value:"<code>evaluateConditionals</code> (Advanced)",id:"evaluateconditionals-advanced",level:3},{value:"Automatic OPTIONS Responses",id:"automatic-options-responses",level:2},{value:"Routing Configuration Reference",id:"routing-configuration-reference",level:2}];function l(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Routed bundles helpers for negotiating response formats, honouring conditional request headers, and serving default ",(0,s.jsx)(n.code,{children:"OPTIONS"})," responses. These utilities keep handlers focused on business logic while emitting compliant HTTP behaviour out of the box."]}),"\n",(0,s.jsx)(n.h2,{id:"content-negotiation",children:"Content Negotiation"}),"\n",(0,s.jsx)(n.h3,{id:"ctxnegotiate",children:(0,s.jsx)(n.code,{children:"ctx.negotiate"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ContentNegotiator"})," parses ",(0,s.jsx)(n.code,{children:"Accept"})," headers and picks the best match from a list of supported media types. The ",(0,s.jsx)(n.code,{children:"ctx.negotiate"})," helper does the heavy lifting for typical handlers:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"engine.get('/profile', (ctx) async {\n  return await ctx.negotiate({\n    'application/json': () => ctx.json({'name': 'Alice'}),\n    'text/html': () => ctx.html('<h1>Alice</h1>'),\n    'text/plain': () => ctx.string('Alice'),\n  });\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ctx.negotiate"})," automatically:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Adds a ",(0,s.jsx)(n.code,{children:"Vary: Accept"})," header to the response"]}),"\n",(0,s.jsxs)(n.li,{children:["Honours quality factors (",(0,s.jsx)(n.code,{children:"q=0.8"}),", etc.) in the client's ",(0,s.jsx)(n.code,{children:"Accept"})," header"]}),"\n",(0,s.jsxs)(n.li,{children:["Falls back to the first supported type when no ",(0,s.jsx)(n.code,{children:"Accept"})," header is present"]}),"\n",(0,s.jsxs)(n.li,{children:["Responds with ",(0,s.jsx)(n.code,{children:"406 Not Acceptable"})," when no offer matches"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["You can override the fallback with ",(0,s.jsx)(n.code,{children:"defaultType"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"return await ctx.negotiate(\n  {\n    'application/json': () => ctx.json(data),\n    'text/html': () => ctx.html(rendered),\n  },\n  defaultType: 'text/html',\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"ctxnegotiatecontenttype",children:(0,s.jsx)(n.code,{children:"ctx.negotiateContentType"})}),"\n",(0,s.jsx)(n.p,{children:"For cases where you just need to know which type was selected without executing a callback:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final selected = ctx.negotiateContentType(\n  ['application/json', 'text/html'],\n  defaultType: 'application/json',\n);\n// selected is a NegotiatedMediaType with .value, .quality, .parameters\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"contentnegotiatornegotiate-advanced",children:[(0,s.jsx)(n.code,{children:"ContentNegotiator.negotiate"})," (Advanced)"]}),"\n",(0,s.jsx)(n.p,{children:"For full control, call the negotiator directly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final result = ContentNegotiator.negotiate(\n  ctx.header('Accept') ?? '*/*',\n  ['application/json', 'text/html', 'text/plain'],\n  defaultType: 'application/json',\n);\n\nif (result != null) {\n  print(result.value);      // \"application/json\"\n  print(result.quality);    // 1.0\n  print(result.parameters); // {}\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"The negotiator uses specificity scoring to break ties: concrete types beat wildcards, and more specific subtypes beat less specific ones. Among equal-specificity matches, the client's stated quality factor and declaration order determine the winner."}),"\n",(0,s.jsx)(n.h3,{id:"convenience-getters",children:"Convenience Getters"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"NegotiationContext"})," extension adds shorthand checks:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Property"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ctx.wantsJson"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"true"})," if the client prefers JSON (checks ",(0,s.jsx)(n.code,{children:"Accept"}),", ",(0,s.jsx)(n.code,{children:"X-Requested-With"}),", and ",(0,s.jsx)(n.code,{children:"Content-Type"}),")"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ctx.acceptsHtml"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"true"})," if ",(0,s.jsx)(n.code,{children:"Accept"})," includes ",(0,s.jsx)(n.code,{children:"text/html"})," or ",(0,s.jsx)(n.code,{children:"application/xhtml+xml"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ctx.accepts(mime)"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"true"})," if ",(0,s.jsx)(n.code,{children:"Accept"})," header contains the given MIME type"]})]})]})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"engine.post('/api/data', (ctx) async {\n  if (ctx.wantsJson) {\n    return ctx.json({'status': 'ok'});\n  }\n  return ctx.html('<p>OK</p>');\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"conditional-requests",children:"Conditional Requests"}),"\n",(0,s.jsx)(n.p,{children:"Conditional requests let clients cache resources and only fetch updates when the content has actually changed. Routed provides a middleware and standalone evaluation function."}),"\n",(0,s.jsx)(n.h3,{id:"the-middleware",children:"The Middleware"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"conditionalRequests"})," when a route can validate resources via ETags or last-modified timestamps:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"engine.get('/articles/{id}', (ctx) async {\n  final id = ctx.pathParam('id')!;\n  final article = await repo.fetch(id);\n  return ctx.json(article);\n}, middlewares: [\n  conditionalRequests(\n    etag: (ctx) {\n      final id = ctx.pathParam('id')!;\n      return generateStrongEtagFromString(repo.versionFor(id));\n    },\n    lastModified: (ctx) {\n      final id = ctx.pathParam('id')!;\n      return repo.lastUpdatedFor(id);\n    },\n  ),\n]);\n"})}),"\n",(0,s.jsx)(n.p,{children:"The middleware:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Resolves the ETag and/or last-modified timestamp via your callbacks"}),"\n",(0,s.jsxs)(n.li,{children:["Evaluates the conditional headers (",(0,s.jsx)(n.code,{children:"If-None-Match"}),", ",(0,s.jsx)(n.code,{children:"If-Match"}),", ",(0,s.jsx)(n.code,{children:"If-Modified-Since"}),", ",(0,s.jsx)(n.code,{children:"If-Unmodified-Since"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["Short-circuits with ",(0,s.jsx)(n.code,{children:"304 Not Modified"})," for safe requests (GET/HEAD) when the resource hasn't changed"]}),"\n",(0,s.jsxs)(n.li,{children:["Short-circuits with ",(0,s.jsx)(n.code,{children:"412 Precondition Failed"})," when preconditions are violated (e.g., ",(0,s.jsx)(n.code,{children:"If-Match"})," fails on an unsafe method)"]}),"\n",(0,s.jsxs)(n.li,{children:["If the request proceeds, applies ",(0,s.jsx)(n.code,{children:"ETag"})," and ",(0,s.jsx)(n.code,{children:"Last-Modified"})," headers to the response"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"etag-generators",children:"ETag Generators"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Output Format"}),(0,s.jsx)(n.th,{children:"Example"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"generateStrongEtag(bytes)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"<base64url-hash>"'})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"abc123..."'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"generateWeakEtag(bytes)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'W/"<base64url-hash>"'})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'W/"abc123..."'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"generateStrongEtagFromString(value)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"<base64url-hash>"'})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"def456..."'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"generateWeakEtagFromString(value)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'W/"<base64url-hash>"'})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'W/"def456..."'})})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["All generators default to SHA-256 but accept an optional ",(0,s.jsx)(n.code,{children:"algorithm"})," parameter (",(0,s.jsx)(n.code,{children:"sha256"}),", ",(0,s.jsx)(n.code,{children:"sha1"}),", ",(0,s.jsx)(n.code,{children:"md5"}),")."]}),"\n",(0,s.jsx)(n.h3,{id:"resolvedefaultetag",children:(0,s.jsx)(n.code,{children:"resolveDefaultEtag"})}),"\n",(0,s.jsx)(n.p,{children:"Maps a configured strategy to a generated ETag value:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final etag = resolveDefaultEtag(bodyBytes, ctx.engineConfig.etagStrategy);\n// Returns a strong ETag, weak ETag, or null depending on the strategy\n"})}),"\n",(0,s.jsx)(n.h3,{id:"etag-strategy-configuration",children:"ETag Strategy Configuration"}),"\n",(0,s.jsx)(n.p,{children:"Configure the default ETag behaviour in your YAML:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="config/routing.yaml"',children:"routing:\n  etag:\n    strategy: strong  # strong, weak, or disabled\n"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Strategy"}),(0,s.jsx)(n.th,{children:"Behavior"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"strong"})}),(0,s.jsx)(n.td,{children:"Generates a strong ETag with full byte-level validation"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"weak"})}),(0,s.jsx)(n.td,{children:"Generates a weak ETag (semantic equivalence)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"disabled"})}),(0,s.jsx)(n.td,{children:"No automatic ETag generation"})]})]})]}),"\n",(0,s.jsxs)(n.h3,{id:"evaluateconditionals-advanced",children:[(0,s.jsx)(n.code,{children:"evaluateConditionals"})," (Advanced)"]}),"\n",(0,s.jsx)(n.p,{children:"For standalone evaluation without middleware:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final outcome = evaluateConditionals(\n  method: ctx.method,\n  headers: ctx.headers,\n  etag: '\"abc123\"',\n  lastModified: DateTime.utc(2025, 1, 1),\n);\n\nswitch (outcome) {\n  case ConditionalOutcome.proceed:\n    // Serve the full response\n    break;\n  case ConditionalOutcome.notModified:\n    // Return 304\n    break;\n  case ConditionalOutcome.preconditionFailed:\n    // Return 412\n    break;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The evaluation follows ",(0,s.jsx)(n.a,{href:"https://httpwg.org/specs/rfc9110.html#conditional.requests",children:"RFC 9110 Section 13"})," precedence rules:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"If-Match"})," is checked first (strong comparison only)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"If-Unmodified-Since"})," is checked next"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"If-None-Match"})," (weak comparison allowed for GET/HEAD)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"If-Modified-Since"})," (only when ",(0,s.jsx)(n.code,{children:"If-None-Match"})," is absent and method is safe)"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"automatic-options-responses",children:"Automatic OPTIONS Responses"}),"\n",(0,s.jsxs)(n.p,{children:["When ",(0,s.jsx)(n.code,{children:"routing.default_options"})," is enabled (the default), Routed returns ",(0,s.jsx)(n.code,{children:"204 No Content"})," with a populated ",(0,s.jsx)(n.code,{children:"Allow"})," header whenever an ",(0,s.jsx)(n.code,{children:"OPTIONS"})," request hits a path that has handlers but no explicit ",(0,s.jsx)(n.code,{children:"OPTIONS"})," route. The response enumerates allowed methods, including implicit support for ",(0,s.jsx)(n.code,{children:"HEAD"})," and ",(0,s.jsx)(n.code,{children:"OPTIONS"})," themselves."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"405 Method Not Allowed"})," responses also include ",(0,s.jsx)(n.code,{children:"OPTIONS"})," in the ",(0,s.jsx)(n.code,{children:"Allow"})," header so clients can discover capabilities via CORS preflight or general probing."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="config/routing.yaml"',children:"routing:\n  default_options: true    # default\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Set to ",(0,s.jsx)(n.code,{children:"false"})," if you prefer to author every ",(0,s.jsx)(n.code,{children:"OPTIONS"})," handler manually or want middleware to take full control."]}),"\n",(0,s.jsx)(n.h2,{id:"routing-configuration-reference",children:"Routing Configuration Reference"}),"\n",(0,s.jsxs)(n.p,{children:["All HTTP semantics settings live under the ",(0,s.jsx)(n.code,{children:"routing"})," namespace:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="config/routing.yaml"',children:"routing:\n  redirect_trailing_slash: true   # Redirect /foo/ to /foo (or vice versa)\n  handle_method_not_allowed: true # Return 405 instead of 404 for wrong methods\n  default_options: true           # Auto-generate OPTIONS responses\n  etag:\n    strategy: strong              # strong, weak, or disabled\n"})})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var i=t(6540);const s={},d=i.createContext(s);function a(e){const n=i.useContext(d);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);