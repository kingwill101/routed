"use strict";(self.webpackChunkrouted=self.webpackChunkrouted||[]).push([[9139],{1778:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"routed/security/security","title":"Security Features","description":"Enable CSRF, CORS, security headers, and request limits","source":"@site/docs/routed/security/security.mdx","sourceDirName":"routed/security","slug":"/routed/security","permalink":"/docs/routed/security","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/security/security.mdx","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Security Features","description":"Enable CSRF, CORS, security headers, and request limits","sidebar_position":1,"slug":"/routed/security"},"sidebar":"tutorialSidebar","previous":{"title":"Liquid Templates","permalink":"/docs/routed/views/templates"},"next":{"title":"Proxy Support","permalink":"/docs/routed/security/proxy"}}');var s=i(4848),t=i(8453);const o={title:"Security Features",description:"Enable CSRF, CORS, security headers, and request limits",sidebar_position:1,slug:"/routed/security"},a="Security Features",l={},d=[{value:"Core Security Features",id:"core-security-features",level:2},{value:"Security Headers",id:"security-headers",level:3},{value:"Rate limiting",id:"rate-limiting",level:3},{value:"CSRF Protection",id:"csrf-protection",level:3},{value:"CORS Configuration",id:"cors-configuration",level:3},{value:"TLS &amp; HTTPS",id:"tls--https",level:2},{value:"Proxy and IP Resolution",id:"proxy-and-ip-resolution",level:2},{value:"Trusted Proxies",id:"trusted-proxies",level:3},{value:"Trusted Platforms",id:"trusted-platforms",level:3},{value:"Request Protection",id:"request-protection",level:2},{value:"Size Limits",id:"size-limits",level:3},{value:"Request Validation",id:"request-validation",level:3},{value:"Session Security",id:"session-security",level:2},{value:"Secure Session Configuration",id:"secure-session-configuration",level:3},{value:"Session Best Practices",id:"session-best-practices",level:3},{value:"Implementation Details",id:"implementation-details",level:2},{value:"Security Middleware Order",id:"security-middleware-order",level:3},{value:"IP Resolution Logic",id:"ip-resolution-logic",level:3},{value:"Security Feature Flags",id:"security-feature-flags",level:3},{value:"Best Practices",id:"best-practices",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"security-features",children:"Security Features"})}),"\n",(0,s.jsxs)(n.p,{children:["Secure your app with headers, CSRF, CORS, trusted proxies, request limits, and session hardening. For uploads and form parsing, see ",(0,s.jsx)(n.a,{href:"/docs/routed/fundamentals/requests#file-uploads",children:"Request Handling"})," and ",(0,s.jsx)(n.a,{href:"/docs/routed/fundamentals/validation",children:"Validation"}),". For end-to-end proxy setup, see ",(0,s.jsx)(n.a,{href:"/docs/routed/security/proxy",children:"Proxy Support"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"core-security-features",children:"Core Security Features"}),"\n",(0,s.jsx)(n.h3,{id:"security-headers",children:"Security Headers"}),"\n",(0,s.jsxs)(n.p,{children:["Configure defaults via ",(0,s.jsx)(n.code,{children:"config/http.yaml"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="config/http.yaml"',children:"security:\n  headers:\n    Content-Security-Policy: \"default-src 'self'\"\n    X-Frame-Options: DENY\n    X-Content-Type-Options: nosniff\n  max_request_size: 10485760   # 10 MB\n  trusted_proxies:\n    enabled: true\n    forward_client_ip: true\n    proxies: ['10.0.0.0/8', '::/0']\n    headers: ['X-Forwarded-For', 'X-Real-IP']\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"routed.security"})," provider validates these entries and applies them to ",(0,s.jsx)(n.code,{children:"EngineConfig.security"}),". Run ",(0,s.jsx)(n.code,{children:"dart run routed_cli provider:list --config"})," to confirm the active defaults and catch malformed overrides. If you enable a strict Content Security Policy (CSP), confirm your templates, inline scripts, and assets comply; see ",(0,s.jsx)(n.a,{href:"/docs/routed/views/",children:"Views & Templates"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"rate-limiting",children:"Rate limiting"}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/docs/routed/security/rate-limit",children:"Rate limiting"})," for configuring token-bucket policies. The limiter integrates with the cache subsystem, supports memory and Redis stores, and responds with ",(0,s.jsx)(n.code,{children:"429 Too Many Requests"})," plus ",(0,s.jsx)(n.code,{children:"Retry-After"})," headers."]}),"\n",(0,s.jsx)(n.p,{children:"Prefer code? Configure the engine directly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  config: EngineConfig(\n    features: EngineFeatures(\n      enableSecurityFeatures: true\n    ),\n    security: EngineSecurityFeatures(\n      // Content Security Policy\n      csp: \"default-src 'self'\",\n      \n      // HSTS configuration\n      hstsMaxAge: 31536000, // 1 year\n      \n      // Frame options\n      xFrameOptions: 'DENY',\n      \n      // Type sniffing protection\n      xContentTypeOptionsNoSniff: true,\n      \n      // Request size limit\n      maxRequestSize: 10 * 1024 * 1024 // 10MB\n    )\n  )\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"csrf-protection",children:"CSRF Protection"}),"\n",(0,s.jsxs)(n.p,{children:["Use the built-in token-based protection. Pair it with ",(0,s.jsx)(n.code,{children:"SameSite"})," and ",(0,s.jsx)(n.code,{children:"HttpOnly"})," cookies; see ",(0,s.jsx)(n.a,{href:"/docs/routed/state/sessions",children:"Sessions"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  config: EngineConfig(\n    security: EngineSecurityFeatures(\n      csrfProtection: true,\n      csrfCookieName: 'csrf_token'\n    )\n  )\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"cors-configuration",children:"CORS Configuration"}),"\n",(0,s.jsx)(n.p,{children:"Configure CORS via the manifest so defaults survive restarts:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="config/http.yaml"',children:"cors:\n  enabled: true\n  allowed_origins: ['https://example.com']\n  allowed_methods: ['GET', 'POST']\n  allowed_headers: ['Authorization', 'Content-Type']\n  allow_credentials: true\n  exposed_headers: ['X-Token']\n  max_age: 600\n"})}),"\n",(0,s.jsx)(n.p,{children:"Or set it directly on the engine:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  config: EngineConfig(\n    security: EngineSecurityFeatures(\n      cors: CorsConfig(\n        enabled: true,\n        allowedOrigins: ['https://example.com'],\n        allowedMethods: ['GET', 'POST'],\n        allowedHeaders: ['Authorization', 'Content-Type'],\n        allowCredentials: true,\n        exposedHeaders: ['X-Token'],\n        maxAge: 600,\n      ),\n    ),\n  ),\n);\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Validation: Security and CORS providers validate their inputs during boot. Non-boolean flags (for example ",(0,s.jsx)(n.code,{children:'security.csrf.enabled: "yes"'}),"), negative ",(0,s.jsx)(n.code,{children:"security.max_request_size"})," values, malformed trusted proxy lists, or non-string CORS origins/methods trigger a ",(0,s.jsx)(n.code,{children:"ProviderConfigException"})," with an explicit config path so you can fix the override before requests start flowing. Use ",(0,s.jsx)(n.code,{children:"dart run routed_cli provider:list --config"})," to inspect the merged security/CORS defaults."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"tls--https",children:"TLS & HTTPS"}),"\n",(0,s.jsxs)(n.p,{children:["Use the ",(0,s.jsx)(n.code,{children:"serveSecure"})," helper (",(0,s.jsx)(n.code,{children:"packages/routed/lib/src/engine/engine.dart:422"}),") to mount HTTPS endpoints with your certificate chain:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"import 'package:routed/routed.dart';\n\nFuture<void> main() async {\n  final engine = Engine(\n    config: EngineConfig(\n      features: const EngineFeatures(enableSecurityFeatures: true),\n    ),\n  )..get('/', (ctx) => ctx.string('secure'));\n\n  await engine.serveSecure(\n    address: '0.0.0.0',\n    port: 8443,\n    certificatePath: 'certs/server.crt',\n    keyPath: 'certs/server.key',\n    requestClientCertificate: false,\n  );\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"serveSecure"})," configures ALPN for HTTP/1.1 and shares the same routing pipeline as ",(0,s.jsx)(n.code,{children:"serve"}),". You can run the secure server alongside the standard ",(0,s.jsx)(n.code,{children:"serve()"})," instance if you need both HTTP and HTTPS listeners. An experimental ",(0,s.jsx)(n.code,{children:"processStream"})," helper is also available for advanced HTTP/2 integrations. In production, you can also terminate TLS at a reverse proxy or edge and forward to Routed; configure trusted proxies accordingly (see ",(0,s.jsx)(n.a,{href:"/docs/routed/security/proxy",children:"Proxy Support"}),")."]}),"\n",(0,s.jsx)(n.h2,{id:"proxy-and-ip-resolution",children:"Proxy and IP Resolution"}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/docs/routed/security/proxy",children:"Proxy Support"})," for end-to-end examples, ",(0,s.jsx)(n.a,{href:"/docs/routed/security/auth",children:"Authentication & Authorization"})," for JWT/IP filter usage, and ",(0,s.jsx)(n.a,{href:"/docs/routed/security/upload-hardening",children:"Security Uploads"})," for hardened multipart defaults."]}),"\n",(0,s.jsx)(n.h3,{id:"trusted-proxies",children:"Trusted Proxies"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  config: EngineConfig(\n    features: EngineFeatures(\n      enableProxySupport: true\n    ),\n    // Trust specific IPs/ranges\n    trustedProxies: [\n      '10.0.0.0/8',\n      '192.168.1.100'\n    ]\n  )\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"trusted-platforms",children:"Trusted Platforms"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  config: EngineConfig(\n    features: EngineFeatures(\n      enableTrustedPlatform: true\n    ),\n    // Use predefined platforms\n    trustedPlatform: EngineConfig.platformCloudflare // CF-Connecting-IP\n    // Or: platformGoogleAppEngine   // X-Appengine-Remote-Addr\n    // Or: platformFlyIO            // Fly-Client-IP\n  )\n);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"request-protection",children:"Request Protection"}),"\n",(0,s.jsx)(n.h3,{id:"size-limits",children:"Size Limits"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  config: EngineConfig(\n    security: EngineSecurityFeatures(\n      maxRequestSize: 5 * 1024 * 1024 // 5MB limit\n    ),\n    multipart: MultipartConfig(\n      maxFileSize: 2 * 1024 * 1024,    // 2MB per file\n      maxMemory: 32 * 1024 * 1024,     // 32MB total\n      allowedExtensions: {'.jpg', '.pdf'}\n    )\n  )\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"request-validation",children:"Request Validation"}),"\n",(0,s.jsxs)(n.p,{children:["Combine size limits with schema rules; see ",(0,s.jsx)(n.a,{href:"/docs/routed/fundamentals/validation",children:"Validation"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"router.post('/upload', (ctx) async {\n  await ctx.validate({\n    'file': 'required|file|max_file_size:5242880',\n    'type': 'required|in:image,document'\n  });\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"session-security",children:"Session Security"}),"\n",(0,s.jsx)(n.h3,{id:"secure-session-configuration",children:"Secure Session Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final config = SessionConfig.cookie(\n  appKey: 'your-secret-key',\n  cookieName: 'app_session',\n  maxAge: Duration(hours: 1)\n);\n\n// Or with more options\nfinal store = CookieStore(\n  codecs: [\n    SecureCookie(\n      key: SecureCookie.generateKey(),\n      useEncryption: true,  // AES-GCM encryption\n      useSigning: true      // HMAC signing\n    )\n  ],\n  defaultOptions: Options(\n    secure: true,      // HTTPS only\n    httpOnly: true,    // No JS access\n    sameSite: SameSite.strict // Strict same-site\n  )\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"session-best-practices",children:"Session Best Practices"}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/docs/routed/state/sessions",children:"Sessions"})," for a full guide."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"// Regenerate session ID after login\nctx.regenerateSession();\n\n// Clear sensitive data\nctx.removeSession('temp_password');\n\n// Destroy session on logout\nctx.destroySession();\n\n// Check session state\nif (ctx.sessionAge > maxSessionAge || \n    ctx.sessionIdleTime > maxIdleTime) {\n  ctx.destroySession();\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"implementation-details",children:"Implementation Details"}),"\n",(0,s.jsx)(n.h3,{id:"security-middleware-order",children:"Security Middleware Order"}),"\n",(0,s.jsx)(n.p,{children:"The security features are applied in this order:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Request size limits"}),"\n",(0,s.jsx)(n.li,{children:"CORS headers"}),"\n",(0,s.jsx)(n.li,{children:"Security headers"}),"\n",(0,s.jsx)(n.li,{children:"CSRF protection"}),"\n",(0,s.jsx)(n.li,{children:"Session handling"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"ip-resolution-logic",children:"IP Resolution Logic"}),"\n",(0,s.jsx)(n.p,{children:"Client IP resolution follows this order:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Trusted platform header if enabled"}),"\n",(0,s.jsx)(n.li,{children:"X-Forwarded-For from trusted proxies"}),"\n",(0,s.jsx)(n.li,{children:"Direct connection IP"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"security-feature-flags",children:"Security Feature Flags"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"EngineFeatures(\n  enableSecurityFeatures: true,   // Enable all security\n  enableProxySupport: false,      // Disable proxy trust\n  enableTrustedPlatform: false    // Disable platform headers\n)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Always enable security features in production"}),"\n",(0,s.jsx)(n.li,{children:"Use HTTPS-only, HttpOnly, and SameSite cookies"}),"\n",(0,s.jsx)(n.li,{children:"Set appropriate size limits"}),"\n",(0,s.jsxs)(n.li,{children:["Validate file uploads (see ",(0,s.jsx)(n.a,{href:"/docs/routed/security/upload-hardening",children:"Securing file uploads"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["Enable response compression where appropriate (",(0,s.jsx)(n.a,{href:"/docs/routed/fundamentals/compression",children:"guide"}),")"]}),"\n",(0,s.jsx)(n.li,{children:"Implement proper session management"}),"\n",(0,s.jsx)(n.li,{children:"Configure CORS carefully (prefer explicit origins/methods; avoid wildcard credentials)"}),"\n",(0,s.jsx)(n.li,{children:"Use CSP headers"}),"\n",(0,s.jsx)(n.li,{children:"Enable CSRF protection"}),"\n",(0,s.jsx)(n.li,{children:"Trust proxies selectively"}),"\n",(0,s.jsx)(n.li,{children:"Monitor security logs"}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>a});var r=i(6540);const s={},t=r.createContext(s);function o(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);