"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[4115],{389:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"state/caching","title":"Caching","description":"Cache responses and shared data with pluggable stores","source":"@site/docs/routed/state/caching.mdx","sourceDirName":"state","slug":"/state/caching","permalink":"/docs/routed/state/caching","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/state/caching.mdx","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Caching","description":"Cache responses and shared data with pluggable stores","sidebar_position":1},"sidebar":"routedSidebar","previous":{"title":"State & Persistence","permalink":"/docs/routed/state/"},"next":{"title":"Sessions","permalink":"/docs/routed/state/sessions"}}');var i=r(4848),c=r(8453);const a={title:"Caching",description:"Cache responses and shared data with pluggable stores",sidebar_position:1},s="Caching",o={},d=[{value:"Basic Cache Operations",id:"basic-cache-operations",level:2},{value:"Cache Duration",id:"cache-duration",level:2},{value:"Counter Operations",id:"counter-operations",level:2},{value:"Remember Pattern",id:"remember-pattern",level:2},{value:"Cache Stores",id:"cache-stores",level:2},{value:"Built-in drivers",id:"built-in-drivers",level:3},{value:"Custom stores and tagging",id:"custom-stores-and-tagging",level:2},{value:"Driver registry &amp; documentation",id:"driver-registry--documentation",level:3},{value:"Cache events",id:"cache-events",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"caching",children:"Caching"})}),"\n",(0,i.jsxs)(n.p,{children:["Routed provides a flexible, provider-driven caching system with multiple storage backends. Use it from handlers via ",(0,i.jsx)(n.code,{children:"EngineContext"})," (for example, ",(0,i.jsx)(n.code,{children:"ctx.cache"}),", ",(0,i.jsx)(n.code,{children:"ctx.getCache"}),", and remember helpers)."]}),"\n",(0,i.jsx)(n.h2,{id:"basic-cache-operations",children:"Basic Cache Operations"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"router.get('/data', (ctx) async {\n  // Get from cache\n  final value = await ctx.getCache('my-key');\n  \n  if (value != null) {\n    return ctx.json({'data': value, 'from_cache': true});\n  }\n  \n  // Store in cache for 60 seconds\n  final data = await expensiveOperation();\n  await ctx.cache('my-key', data, 60);\n  \n  return ctx.json({'data': data, 'from_cache': false});\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"cache-duration",children:"Cache Duration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"// Cache for 1 hour (TTL in seconds)\nawait ctx.cache('hourly-key', value, 3600);\n\n// Cache forever\nawait ctx.cacheForever('permanent-key', value);\n\n// Remove from cache\nawait ctx.removeCache('my-key');\n"})}),"\n",(0,i.jsx)(n.h2,{id:"counter-operations",children:"Counter Operations"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"// Increment cache value\nawait ctx.incrementCache('visits', 1);  // Add 1\nawait ctx.incrementCache('score', 5);   // Add 5\n\n// Decrement cache value\nawait ctx.decrementCache('stock', 1);   // Subtract 1\nawait ctx.decrementCache('points', 10); // Subtract 10\n"})}),"\n",(0,i.jsx)(n.h2,{id:"remember-pattern",children:"Remember Pattern"}),"\n",(0,i.jsx)(n.p,{children:"Cache computed values. The callback runs only on a cache miss; subsequent calls return the cached result until it expires:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"// Cache if not exists\nfinal value = await ctx.rememberCache(\n  'user-stats', \n  300,  // 5 minutes \n  () => computeUserStats()\n);\n\n// Remember forever\nfinal config = await ctx.rememberCacheForever(\n  'app-config',\n  () => loadAppConfig()\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"cache-stores",children:"Cache Stores"}),"\n",(0,i.jsxs)(n.p,{children:["Describe cache stores either in configuration files or imperatively. In ",(0,i.jsx)(n.code,{children:"config/http.yaml"})," define stores under ",(0,i.jsx)(n.code,{children:"cache.*"})," (see ",(0,i.jsx)(n.a,{href:"/docs/routed/fundamentals/configuration",children:"Configuration"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="config/http.yaml"',children:"cache:\n  default: file\n  prefix: cache:\n  stores:\n    array:\n      driver: array\n      serialize: false\n    file:\n      driver: file\n      path: storage/cache\n      lock_path: storage/cache/locks\n      permission: 600  # optional octal permissions\n    redis:\n      driver: redis\n      url: {{ env.REDIS_URL }}\n\napp:\n  cache_prefix: myapp\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"routed.cache"})," provider reads this section, registers the stores, and injects a ",(0,i.jsx)(n.code,{children:"CacheManager"})," instance. Toggle the default store or add new ones by editing the manifest and re-running ",(0,i.jsx)(n.code,{children:"provider:list --config"})," to confirm changes and surface validation errors."]}),"\n",(0,i.jsx)(n.h3,{id:"built-in-drivers",children:"Built-in drivers"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"array"}),": process-local, in-memory store. Great for tests and ephemeral caching. Set ",(0,i.jsx)(n.code,{children:"serialize: true"})," if you need values cloned (instead of shared by reference) and remember that locks are scoped to the current process."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"file"}),": persists entries to disk. Requires a ",(0,i.jsx)(n.code,{children:"path"}),", supports an optional ",(0,i.jsx)(n.code,{children:"lock_path"})," for coordinating file locks, and ",(0,i.jsx)(n.code,{children:"permission"})," (octal string or int) for new cache files."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"null"}),": keeps the cache API callable without persisting data. Useful for local development or disabling cache for specific environments."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"redis"}),": connects to a Redis instance. Configure with ",(0,i.jsx)(n.code,{children:"url"})," (or ",(0,i.jsx)(n.code,{children:"host"}),"/",(0,i.jsx)(n.code,{children:"port"}),"/",(0,i.jsx)(n.code,{children:"password"}),"/",(0,i.jsx)(n.code,{children:"db"}),") and reuse the same driver for rate limiting or session backends."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The file driver implements ",(0,i.jsx)(n.code,{children:"LockProvider"}),", so cache locks work out of the box. By default lock files live next to the cache entries; set ",(0,i.jsx)(n.code,{children:"lock_path"})," if you want them elsewhere."]}),"\n",(0,i.jsxs)(n.p,{children:["Prefer code? Construct a manager and pass it via ",(0,i.jsx)(n.code,{children:"withCacheManager"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"final cacheManager = CacheManager()\n  ..registerStore('array', {\n    'driver': 'array',\n    'serialize': false,\n  })\n  ..registerStore('file', {\n    'driver': 'file',\n    'path': 'cache',\n  });\n\nfinal engine = Engine(\n  options: [\n    withCacheManager(cacheManager),\n  ]\n);\n"})}),"\n",(0,i.jsx)(n.p,{children:"Using specific stores:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"// Use default store\nawait ctx.cache('key', value, 60);\n\n// Use specific store\nawait ctx.cache('key', value, 60, store: 'file');\n"})}),"\n",(0,i.jsx)(n.h2,{id:"custom-stores-and-tagging",children:"Custom stores and tagging"}),"\n",(0,i.jsxs)(n.p,{children:["Extend caching by registering your own store factories (see ",(0,i.jsx)(n.a,{href:"/docs/routed/fundamentals/contracts",children:"Contracts"}),"; ",(0,i.jsx)(n.code,{children:"packages/routed/lib/src/cache/cache_manager.dart:1"}),"):"]}),"\n",(0,i.jsxs)(n.p,{children:["Custom stores should implement the ",(0,i.jsx)(n.code,{children:"Store"})," contract (",(0,i.jsx)(n.code,{children:"packages/routed/lib/src/contracts/cache/store.dart"}),") or extend ",(0,i.jsx)(n.code,{children:"TaggableStore"})," if you want tag-aware invalidation (",(0,i.jsx)(n.code,{children:"packages/routed/lib/src/cache/taggable_store.dart:1"}),"). Once registered, access the store exactly like the built-in array and file drivers."]}),"\n",(0,i.jsxs)(n.p,{children:["Prefer configuration when possible: the ",(0,i.jsx)(n.code,{children:"routed.cache"})," provider ships default stores and validates the ",(0,i.jsx)(n.code,{children:"cache.*"})," manifest entries (for example, it rejects non-string ",(0,i.jsx)(n.code,{children:"cache.default"})," values or non-map store definitions with a ",(0,i.jsx)(n.code,{children:"ProviderConfigException"}),"). Run ",(0,i.jsx)(n.code,{children:"dart run routed provider:list --config"})," to review the current cache stores and make sure your overrides are well-formed."]}),"\n",(0,i.jsxs)(n.p,{children:["Set a global prefix for all cache keys with ",(0,i.jsx)(n.code,{children:"cache.prefix"}),". When omitted, the provider falls back to ",(0,i.jsx)(n.code,{children:"app.cache_prefix"})," so you can keep naming consistent with other frameworks. Clearing the prefix (for instance by setting it to ",(0,i.jsx)(n.code,{children:"null"}),") removes the namespace entirely."]}),"\n",(0,i.jsx)(n.h3,{id:"driver-registry--documentation",children:"Driver registry & documentation"}),"\n",(0,i.jsxs)(n.p,{children:["Built-in drivers (",(0,i.jsx)(n.code,{children:"array"}),", ",(0,i.jsx)(n.code,{children:"file"}),", ",(0,i.jsx)(n.code,{children:"null"}),") are now registered through the same registry API that application code uses. Call ",(0,i.jsx)(n.code,{children:"CacheManager.registerDriver"})," to publish additional drivers (before boot or inside a provider) and optionally supply a ",(0,i.jsx)(n.code,{children:"documentation"})," callback that returns ",(0,i.jsx)(n.code,{children:"ConfigDocEntry"})," items. The cache service provider merges those entries into ",(0,i.jsx)(n.code,{children:"provider:list --config"})," output and the docs below, so consumers can discover driver-specific options without reading source code."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"CacheManager.registerDriver(\n  'dropbox',\n  () => DropboxStoreFactory(),\n  documentation: (ctx) => <ConfigDocEntry>[\n    ConfigDocEntry(\n      path: ctx.path('token'),\n      type: 'string',\n      description: 'OAuth token used when talking to Dropbox.',\n    ),\n    ConfigDocEntry(\n      path: ctx.path('root'),\n      type: 'string',\n      description: 'Remote folder for cached files (defaults to /cache).',\n    ),\n  ],\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Any store registered via ",(0,i.jsx)(n.code,{children:"registerDriver"})," is available through configuration (",(0,i.jsx)(n.code,{children:"cache.stores.*.driver"}),") and shows up in the provider docs under ",(0,i.jsx)(n.code,{children:"cache.stores.*"}),". Use this hook to describe required credentials or optional flags for each driver you publish. See ",(0,i.jsx)(n.a,{href:"/docs/routed/advanced/driver-registries",children:"Driver Registries"})," for a deeper dive."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"routed provider:driver --type cache my_driver\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The CLI scaffolds a starter file in ",(0,i.jsx)(n.code,{children:"lib/drivers/cache/"}),", complete with a ",(0,i.jsx)(n.code,{children:"registerDriver"})," helper and documentation callback so you can focus on the store implementation."]}),"\n",(0,i.jsx)(n.p,{children:"Need a custom provider? Register one and add it to the manifest:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"class RedisCacheProvider extends ServiceProvider with ProvidesDefaultConfig {\n  @override\n  Map<String, dynamic> get defaultConfig => const {\n    'cache': {\n      'stores': {\n        'redis': {'driver': 'redis', 'url': '{{ env.REDIS_URL }}'},\n      },\n    },\n  };\n}\n\nProviderRegistry.instance.register(\n  'app.cache.redis',\n  factory: () => RedisCacheProvider(),\n  description: 'Redis cache integration',\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"cache-events",children:"Cache events"}),"\n",(0,i.jsxs)(n.p,{children:["The cache manager publishes lifecycle events through the ",(0,i.jsx)(n.code,{children:"EventManager"})," when you interact with the cache API (see ",(0,i.jsx)(n.a,{href:"/docs/routed/advanced/events",children:"Events"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CacheHitEvent"})," / ",(0,i.jsx)(n.code,{children:"CacheMissEvent"})," \u2013 emitted when keys are read."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CacheWriteEvent"})," \u2013 emitted after successful writes (",(0,i.jsx)(n.code,{children:"put"}),", ",(0,i.jsx)(n.code,{children:"remember"}),", increments, etc.). Includes the target store and optional TTL."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CacheForgetEvent"})," \u2013 emitted when entries are evicted (",(0,i.jsx)(n.code,{children:"forget"}),", ",(0,i.jsx)(n.code,{children:"pull"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Listen to them with:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"final events = await engine.make<EventManager>();\nevents.on<CacheHitEvent>().listen((event) {\n  logger.debug('cache hit', fields: {'store': event.store, 'key': event.key});\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Custom ",(0,i.jsx)(n.code,{children:"CacheManager"})," instances can participate by calling ",(0,i.jsx)(n.code,{children:"attachEventManager(eventManager)"})," after construction."]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>s});var t=r(6540);const i={},c=t.createContext(i);function a(e){const n=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(c.Provider,{value:n},e.children)}}}]);