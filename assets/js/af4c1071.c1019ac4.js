"use strict";(self.webpackChunkrouted=self.webpackChunkrouted||[]).push([[2642],{3480:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"tutorials/hardening-rest-apis-with-property-based-testing","title":"Hardening REST APIs with Property-Based Testing","description":"Stress test a Routed API with property_testing chaos generators, then fix the vulnerabilities","source":"@site/docs/tutorials/hardening-rest-apis-with-property-based-testing.mdx","sourceDirName":"tutorials","slug":"/tutorials/hardening-rest-apis","permalink":"/docs/tutorials/hardening-rest-apis","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/tutorials/hardening-rest-apis-with-property-based-testing.mdx","tags":[],"version":"current","frontMatter":{"title":"Hardening REST APIs with Property-Based Testing","description":"Stress test a Routed API with property_testing chaos generators, then fix the vulnerabilities","slug":"/tutorials/hardening-rest-apis"},"sidebar":"tutorialSidebar","previous":{"title":"Type & Value Assertions","permalink":"/docs/assertable json/type-value-assertions"},"next":{"title":"Build a REST API with Routed","permalink":"/docs/tutorials/routed-rest-api"}}');var r=t(4848),i=t(8453);const a={title:"Hardening REST APIs with Property-Based Testing",description:"Stress test a Routed API with property_testing chaos generators, then fix the vulnerabilities",slug:"/tutorials/hardening-rest-apis"},o=void 0,l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1: A na\xefve albums API",id:"step-1-a-na\xefve-albums-api",level:2},{value:"Step 2: Attack the API with chaos generators",id:"step-2-attack-the-api-with-chaos-generators",level:2},{value:"Step 3: Harden the routes",id:"step-3-harden-the-routes",level:2},{value:"Step 4: Update the property tests",id:"step-4-update-the-property-tests",level:2},{value:"Beyond validation",id:"beyond-validation",level:2},{value:"Next steps",id:"next-steps",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["Property-based testing flips traditional testing on its head: instead of hand-picking inputs, you describe the ",(0,r.jsx)(n.strong,{children:"properties"})," your code should obey. A runner then generates hundreds of random (often nasty) inputs trying to violate those properties."]}),"\n",(0,r.jsx)(n.p,{children:"In this guide you will:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Build a deliberately vulnerable albums API with Routed."}),"\n",(0,r.jsxs)(n.li,{children:["Attack it using chaos generators from ",(0,r.jsx)(n.code,{children:"property_testing"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Harden the routes with validation, typed parameters, and safer responses."}),"\n",(0,r.jsx)(n.li,{children:"Re-run the same property tests to confirm the fixes."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Dart SDK 3.0+"}),"\n",(0,r.jsxs)(n.li,{children:["Basic knowledge of Routed (see ",(0,r.jsx)(n.a,{href:"/docs/routed/getting-started",children:"Getting Started"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"curl"})," or a similar HTTP client"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Create a fresh workspace and add the dependencies we will use:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mkdir routed_security_demo\ncd routed_security_demo\ndart create -t console-full .\n\n# Runtime\ndart pub add routed\n\n# Testing & fuzzing\ndart pub add --dev test server_testing routed_testing property_testing\n"})}),"\n",(0,r.jsxs)(n.p,{children:["We will keep the engine definition in ",(0,r.jsx)(n.code,{children:"lib/api.dart"})," so the server and the tests can share it. Replace the generated file with the following na\xefve implementation."]}),"\n",(0,r.jsx)(n.h2,{id:"step-1-a-na\xefve-albums-api",children:"Step 1: A na\xefve albums API"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:'title="lib/api.dart"',children:"import 'package:routed/routed.dart';\n\nEngine buildInsecureEngine() {\n  final engine = Engine();\n  final albums = <String, Map<String, dynamic>>{};\n\n  engine.get('/albums/{id}', (ctx) {\n    return ctx.json({'id': ctx.param('id')});\n  });\n\n  engine.post('/albums', (ctx) async {\n    final payload = <String, dynamic>{};\n    await ctx.bindJSON(payload); // No validation!\n    final id = DateTime.now().microsecondsSinceEpoch.toString();\n    albums[id] = payload;\n    return ctx.json(payload);\n  });\n\n  engine.get('/search', (ctx) {\n    return ctx.json({'q': ctx.query('q')});\n  });\n\n  return engine;\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Wire it up in ",(0,r.jsx)(n.code,{children:"bin/server.dart"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:'title="bin/server.dart"',children:"import 'dart:io';\n\nimport 'package:routed_security_demo/api.dart';\n\nFuture<void> main() async {\n  final engine = buildInsecureEngine();\n  await engine.serve(host: '127.0.0.1', port: 8080);\n  stdout.writeln('Listening on http://127.0.0.1:8080');\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"This server works for \u201chappy path\u201d requests, but it happily echoes whatever string appears in the URL, accepts any JSON payload, and never validates search queries. Let\u2019s see how quickly property-based testing can break it."}),"\n",(0,r.jsx)(n.h2,{id:"step-2-attack-the-api-with-chaos-generators",children:"Step 2: Attack the API with chaos generators"}),"\n",(0,r.jsxs)(n.p,{children:["Property tests live in ",(0,r.jsx)(n.code,{children:"test/albums_property_test.dart"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:'title="test/albums_property_test.dart"',children:"import 'dart:io';\n\nimport 'package:property_testing/property_testing.dart';\nimport 'package:routed_security_demo/api.dart';\nimport 'package:routed_testing/routed_testing.dart';\nimport 'package:server_testing/server_testing.dart';\nimport 'package:test/test.dart';\n\nFuture<TestClient> _clientFromEngine(Engine engine) async {\n  return TestClient.inMemory(RoutedRequestHandler(engine, true));\n}\n\nvoid main() {\n  group('Vulnerable API', () {\n    test('Non-numeric album IDs should not return 200', () async {\n      final runner = PropertyTestRunner(\n        Chaos.string(maxLength: 120),\n        (id) async {\n          final client = await _clientFromEngine(buildInsecureEngine());\n          final response = await client.get('/albums/$id');\n          await client.close();\n\n          if (!RegExp(r'^\\d+\n$').hasMatch(id)) {\n            expect(response.statusCode, isNot(HttpStatus.ok));\n          }\n        },\n        const PropertyConfig(numTests: 200),\n      );\n\n      final result = await runner.run();\n      expect(result.success, isFalse, reason: result.report);\n    });\n\n    test('Suspicious POST payloads should be rejected', () async {\n      final runner = PropertyTestRunner(\n        Chaos.string(maxLength: 120),\n        (chaos) async {\n          final client = await _clientFromEngine(buildInsecureEngine());\n          final response = await client.postJson('/albums', {\n            'title': chaos,\n            'artist': chaos,\n            'price': chaos,\n          });\n          await client.close();\n\n          final looksDangerous = chaos.contains(RegExp(r\"['\\\\/]|\\.\\.\")) || chaos.length > 80;\n          if (looksDangerous) {\n            expect(response.statusCode, isNot(HttpStatus.ok));\n          }\n        },\n        const PropertyConfig(numTests: 120),\n      );\n\n      final result = await runner.run();\n      expect(result.success, isFalse, reason: result.report);\n    });\n  });\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Run the tests:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dart test test/albums_property_test.dart\n"})}),"\n",(0,r.jsx)(n.p,{children:"You should see failures similar to:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Failure after 5 tests with seed 0xD2C4F3891DF5F991.\nCounterexample: \"' OR '1'='1\"\nExpected: status code not equal to 200\n  Actual: <200>\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The property runner quickly finds payloads such as SQL injection strings and directory traversal attempts that still return ",(0,r.jsx)(n.code,{children:"200 OK"}),". Time to tighten the engine."]}),"\n",(0,r.jsx)(n.h2,{id:"step-3-harden-the-routes",children:"Step 3: Harden the routes"}),"\n",(0,r.jsxs)(n.p,{children:["Replace the contents of ",(0,r.jsx)(n.code,{children:"lib/api.dart"})," with a secure version:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:'title="lib/api.dart"',children:"import 'dart:io';\n\nimport 'package:routed/middlewares.dart';\nimport 'package:routed/routed.dart';\n\nEngine buildSecureEngine() {\n  final engine = Engine(\n    config: EngineConfig(\n      security: const EngineSecurityFeatures(\n        maxRequestSize: 5 * 1024 * 1024,\n        xContentTypeOptionsNoSniff: true,\n        cors: CorsConfig(enabled: true),\n      ),\n    ),\n    options: [withMiddleware([timeoutMiddleware(const Duration(seconds: 10))])],\n  );\n\n  final albums = <int, Map<String, dynamic>>{\n    1: {'id': 1, 'title': 'Blue Train', 'artist': 'John Coltrane', 'price': 56.99},\n    2: {'id': 2, 'title': 'Jeru', 'artist': 'Gerry Mulligan', 'price': 17.99},\n  };\n  var nextId = 2;\n\n  engine.get('/albums/{id:int}', (ctx) {\n    final id = int.parse(ctx.param('id')!);\n    final album = albums[id];\n    if (album == null) {\n      return ctx.json({'error': 'Album not found'}, statusCode: HttpStatus.notFound);\n    }\n    return ctx.json(album);\n  });\n\n  engine.post('/albums', (ctx) async {\n    await ctx.validate({\n      'title': 'required|string|min_length:1|max_length:120|not_regex:/[\\\\\\\\]/',\n      'artist': 'required|string|min_length:1|max_length:120|not_regex:/[\\\\\\\\]/',\n      'price': 'required|numeric|min:0',\n    }, bail: true);\n\n    final payload = <String, dynamic>{};\n    await ctx.bindJSON(payload);\n    final price = double.parse(payload['price'].toString());\n\n    final result = {\n      'id': ++nextId,\n      'title': payload['title'],\n      'artist': payload['artist'],\n      'price': price,\n    };\n    albums[nextId] = result;\n    return ctx.json(result, statusCode: HttpStatus.created);\n  });\n\n  engine.get('/search', (ctx) {\n    final query = ctx.query('q');\n    if (query != null && query.contains(RegExp(r\"['\\\\/]|\\.\\.\"))) {\n      return ctx.json({'error': 'Invalid search query'}, statusCode: HttpStatus.badRequest);\n    }\n    return ctx.json({'q': query});\n  });\n\n  return engine;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Key changes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/albums/{id:int}"})," now relies on a typed route parameter so non-digits never reach the handler."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ctx.validate"})," rejects malicious JSON before we try to store it."]}),"\n",(0,r.jsx)(n.li,{children:"The search endpoint sanity-checks its query."}),"\n",(0,r.jsxs)(n.li,{children:["Security features (timeout, CORS, ",(0,r.jsx)(n.code,{children:"X-Content-Type-Options"}),") are enabled in one place."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"step-4-update-the-property-tests",children:"Step 4: Update the property tests"}),"\n",(0,r.jsxs)(n.p,{children:["Modify the test file so it targets ",(0,r.jsx)(n.code,{children:"buildSecureEngine()"})," and tightens expectations:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:'title="test/albums_property_test.dart" diff',children:"@@\n-          final client = await _clientFromEngine(buildInsecureEngine());\n+          final client = await _clientFromEngine(buildSecureEngine());\n@@\n-          if (!RegExp(r'^\\d+$').hasMatch(id)) {\n-            expect(response.statusCode, isNot(HttpStatus.ok));\n-          }\n+          if (!RegExp(r'^\\d+$').hasMatch(id)) {\n+            expect(response.statusCode, isNot(HttpStatus.ok));\n+          }\n@@\n-      expect(result.success, isFalse, reason: result.report);\n+      expect(result.success, isTrue, reason: result.report);\n@@\n-          final client = await _clientFromEngine(buildInsecureEngine());\n+          final client = await _clientFromEngine(buildSecureEngine());\n@@\n-          final looksDangerous = chaos.contains(RegExp(r\"['\\\\/]|\\.\\.\")) || chaos.length > 80;\n-          if (looksDangerous) {\n-            expect(response.statusCode, isNot(HttpStatus.ok));\n-          }\n+          final looksDangerous = chaos.contains(RegExp(r\"['\\\\/]|\\.\\.\")) || chaos.length > 80;\n+          if (looksDangerous) {\n+            expect(response.statusCode, greaterThanOrEqualTo(HttpStatus.badRequest));\n+          }\n@@\n-      expect(result.success, isFalse, reason: result.report);\n+      expect(result.success, isTrue, reason: result.report);\n"})}),"\n",(0,r.jsx)(n.p,{children:"Re-run the tests:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dart test test/albums_property_test.dart\n"})}),"\n",(0,r.jsx)(n.p,{children:"This time everything should pass. The same chaotic inputs no longer slip through because we enforce strict typing and validation."}),"\n",(0,r.jsx)(n.h2,{id:"beyond-validation",children:"Beyond validation"}),"\n",(0,r.jsx)(n.p,{children:"Property-based tests complement \u2014 but do not replace \u2014 other security measures. Consider adding:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Authentication and authorisation around sensitive routes."}),"\n",(0,r.jsx)(n.li,{children:"Logging and rate limiting to catch brute-force attempts."}),"\n",(0,r.jsxs)(n.li,{children:["Consistent error handlers so stack traces never leak (see ",(0,r.jsx)(n.a,{href:"/docs/routed/fundamentals/error-handling",children:"Error handling"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["CSRF, CORS, and security headers (see ",(0,r.jsx)(n.a,{href:"/docs/routed/security",children:"Security"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Learn more about chaos generators in the ",(0,r.jsx)(n.a,{href:"/docs/property-testing/chaos-testing",children:"property testing docs"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Explore composing custom generators in ",(0,r.jsx)(n.a,{href:"/docs/property-testing/generators",children:"Property-testing fundamentals"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Integrate these tests into CI so every change keeps the API hardened."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"By combining Routed\u2019s validation layer with property-based testing, you can discover whole classes of bugs and vulnerabilities before they ever reach production."})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var s=t(6540);const r={},i=s.createContext(r);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);