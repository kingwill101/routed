"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[4418],{6329:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"fundamentals/middleware","title":"Middleware","description":"Intercept requests globally, per group, or per route","source":"@site/docs/routed/fundamentals/middleware.mdx","sourceDirName":"fundamentals","slug":"/fundamentals/middleware","permalink":"/docs/routed/fundamentals/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/fundamentals/middleware.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Middleware","description":"Intercept requests globally, per group, or per route","sidebar_position":2},"sidebar":"routedSidebar","previous":{"title":"Engine Lifecycle","permalink":"/docs/routed/fundamentals/engine"},"next":{"title":"Request Handling","permalink":"/docs/routed/fundamentals/requests"}}');var i=r(4848),d=r(8453);const a={title:"Middleware",description:"Intercept requests globally, per group, or per route",sidebar_position:2},s="Middleware",l={},o=[{value:"Global middleware",id:"global-middleware",level:2},{value:"Group middleware",id:"group-middleware",level:2},{value:"Route middleware",id:"route-middleware",level:2},{value:"Named middleware references",id:"named-middleware-references",level:2},{value:"Custom middleware patterns",id:"custom-middleware-patterns",level:2},{value:"Authentication example",id:"authentication-example",level:3},{value:"CORS pre-flight",id:"cors-pre-flight",level:3},{value:"Rate limiting with cache",id:"rate-limiting-with-cache",level:3},{value:"Aborting the pipeline",id:"aborting-the-pipeline",level:2},{value:"Execution order",id:"execution-order",level:2},{value:"Best practices",id:"best-practices",level:2}];function c(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"middleware",children:"Middleware"})}),"\n",(0,i.jsxs)(n.p,{children:["Middleware run before (and after) a route handler. Each middleware receives the current ",(0,i.jsx)(n.code,{children:"EngineContext"})," and a ",(0,i.jsx)(n.code,{children:"Next"})," callback. Use ",(0,i.jsx)(n.code,{children:"await next()"})," to continue the pipeline, and always return a ",(0,i.jsx)(n.code,{children:"Response"}),". When adding headers or timing information around a handler, wrap ",(0,i.jsx)(n.code,{children:"await next()"})," in a try/finally so your cleanup runs even if the handler throws."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"Future<Response> loggerMiddleware(EngineContext ctx, Next next) async {\n  final started = DateTime.now();\n  try {\n    return await next();\n  } finally {\n    final elapsed = DateTime.now().difference(started);\n    print('[${ctx.request.method}] ${ctx.request.path} (${elapsed.inMilliseconds}ms)');\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["Import ",(0,i.jsx)(n.code,{children:"dart:io"})," to access the ",(0,i.jsx)(n.code,{children:"HttpStatus"})," constants referenced later in this guide."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"global-middleware",children:"Global middleware"}),"\n",(0,i.jsx)(n.p,{children:"Pass middleware to the engine to run them for every request:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  middlewares: [\n    timeoutMiddleware(const Duration(seconds: 30)),\n    requestTrackerMiddleware(),\n  ],\n);\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",metastring:'title="Import built-in middleware"',children:"import 'package:routed/middleware.dart';\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The barrel exports helpers such as ",(0,i.jsx)(n.code,{children:"timeoutMiddleware"}),", ",(0,i.jsx)(n.code,{children:"basicAuth"}),", and ",(0,i.jsx)(n.code,{children:"requestTrackerMiddleware"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Prefer configuration? Populate the manifest and let providers merge the stacks:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="config/http.yaml"',children:"http:\n  middleware:\n    global:\n      - routed.logging        # IDs registered by providers (MiddlewareRef.of)\n      - routed.security.csrf\n    groups:\n      api:\n        - auth.ensure_authenticated\n        - rate.limit_api\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Global IDs run before every request, while group entries apply when you call ",(0,i.jsx)(n.code,{children:"router.group(name: 'api', ...)"}),". The CLI (",(0,i.jsx)(n.code,{children:"dart run routed provider:list --config"}),") prints every registered middleware ID and surfaces validation errors (for example, unknown references). Providers contribute defaults via ",(0,i.jsx)(n.code,{children:"http.middleware_sources.*"}),", keeping the manifest declarative."]}),"\n",(0,i.jsx)(n.h2,{id:"group-middleware",children:"Group middleware"}),"\n",(0,i.jsx)(n.p,{children:"Attach middleware to router groups. Group middleware run after global middleware and before route-level middleware."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"engine.group(\n  path: '/admin',\n  middlewares: [authMiddleware],\n  builder: (admin) {\n    admin.get('/dashboard', dashboardHandler);\n    admin.get('/users', listUsersHandler);\n  },\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"route-middleware",children:"Route middleware"}),"\n",(0,i.jsx)(n.p,{children:"Supply middleware when defining a single route:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"router.get(\n  '/profile',\n  profileHandler,\n  middlewares: [authMiddleware, ensureProfileCompleteMiddleware],\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"named-middleware-references",children:"Named middleware references"}),"\n",(0,i.jsxs)(n.p,{children:["Service providers can register middleware with the shared ",(0,i.jsx)(n.code,{children:"MiddlewareRegistry"}),". Routes, groups, and mounts may then reference middleware by name instead of importing the implementation:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",metastring:'title="provider registration"',children:"class AuthServiceProvider extends ServiceProvider {\n  @override\n  void register(Container container) {\n    final registry = container.get<MiddlewareRegistry>();\n    registry.register('auth', (_) => authMiddleware);\n    registry.register('routed.sessions.start', (_) => sessionMiddleware());\n  }\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",metastring:'title="using references"',children:"router.get(\n  '/admin',\n  dashboardHandler,\n  middlewares: [\n    MiddlewareRef.of('auth'),\n    MiddlewareRef.of('routed.sessions.start'),\n  ],\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["References are resolved once when the engine builds routes (not per request). If a referenced middleware is not registered, a ",(0,i.jsx)(n.code,{children:"StateError"})," lists the unknown ID and the available middleware, helping you spot configuration issues quickly."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["Import ",(0,i.jsx)(n.code,{children:"package:routed/middlewares.dart"})," to access ",(0,i.jsx)(n.code,{children:"MiddlewareRef"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The built-in providers (",(0,i.jsx)(n.code,{children:"routed.sessions"}),", ",(0,i.jsx)(n.code,{children:"routed.security"}),", ",(0,i.jsx)(n.code,{children:"routed.cors"}),", etc.) register their middleware IDs in the registry when enabled via the manifest. Run ",(0,i.jsx)(n.code,{children:"dart run routed provider:list --config"})," to inspect which providers are active and which middleware IDs they contribute."]}),"\n",(0,i.jsx)(n.h2,{id:"custom-middleware-patterns",children:"Custom middleware patterns"}),"\n",(0,i.jsx)(n.h3,{id:"authentication-example",children:"Authentication example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"Future<Response> authMiddleware(EngineContext ctx, Next next) async {\n  final token = ctx.requestHeader('Authorization');\n\n  if (token == null) {\n    ctx.abortWithStatus(HttpStatus.unauthorized, 'Missing token');\n    return ctx.response;\n  }\n\n  try {\n    final user = await validateToken(token);\n    ctx.set('user', user);\n    return await next();\n  } catch (_) {\n    ctx.abortWithStatus(HttpStatus.unauthorized, 'Invalid token');\n    return ctx.response;\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"cors-pre-flight",children:"CORS pre-flight"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"Future<Response> corsMiddleware(EngineContext ctx, Next next) async {\n  ctx.setHeader('Access-Control-Allow-Origin', '*');\n  ctx.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\n  ctx.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n\n  if (ctx.request.method == 'OPTIONS') {\n    ctx.status(HttpStatus.ok);\n    return ctx.response;\n  }\n\n  return await next();\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"rate-limiting-with-cache",children:"Rate limiting with cache"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"Future<Response> rateLimiter(EngineContext ctx, Next next) async {\n  final clientKey = 'rate:${ctx.request.clientIP}';\n  final hits = await ctx.getCache(clientKey) ?? 0;\n\n  if (hits >= 100) {\n    ctx.abortWithStatus(HttpStatus.tooManyRequests, 'Slow down');\n    return ctx.response;\n  }\n\n  await ctx.incrementCache(clientKey, 1);\n  return await next();\n}\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["Ensure a cache manager is configured via ",(0,i.jsx)(n.code,{children:"withCacheManager"})," before using the cache helpers."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"aborting-the-pipeline",children:"Aborting the pipeline"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"ctx.abortWithStatus"})," (or related helpers) to stop processing immediately. Always return the response afterwards."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"Future<Response> maintenanceMiddleware(EngineContext ctx, Next next) async {\n  if (!isOnline) {\n    ctx.abortWithStatus(HttpStatus.serviceUnavailable, 'Scheduled maintenance');\n    return ctx.response;\n  }\n\n  return await next();\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"execution-order",children:"Execution order"}),"\n",(0,i.jsx)(n.p,{children:"Middleware run in the following sequence:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Engine-level middleware"}),"\n",(0,i.jsx)(n.li,{children:"Group middleware (outer \u2192 inner)"}),"\n",(0,i.jsx)(n.li,{children:"Route middleware"}),"\n",(0,i.jsx)(n.li,{children:"Route handler"}),"\n",(0,i.jsx)(n.li,{children:"Middleware unwind in reverse order"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"request \u2192\n  engine middleware\n    \u2192 group middleware\n      \u2192 route middleware\n        \u2192 handler\n      \u2190 route middleware cleanup\n    \u2190 group middleware cleanup\n  \u2190 engine middleware cleanup\nresponse\n"})}),"\n",(0,i.jsx)(n.p,{children:"Understanding the order helps when composing logging, authentication, and post-processing behaviours."}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best practices"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Keep middleware small and focused; compose multiple middleware instead of handling many unrelated concerns in one."}),"\n",(0,i.jsxs)(n.li,{children:["Prefer ",(0,i.jsx)(n.code,{children:"try { final res = await next(); } finally { /* cleanup/logging */ }"})," for logic that must run regardless of handler success."]}),"\n",(0,i.jsxs)(n.li,{children:["Avoid expensive I/O before ",(0,i.jsx)(n.code,{children:"await next()"})," unless it\u2019s strictly required to admit the request; do it after ",(0,i.jsx)(n.code,{children:"next()"})," when possible."]}),"\n",(0,i.jsxs)(n.li,{children:["If you abort the pipeline with ",(0,i.jsx)(n.code,{children:"ctx.abortWithStatus(...)"}),", immediately return ",(0,i.jsx)(n.code,{children:"ctx.response"})," and avoid writing additional headers/body later."]}),"\n",(0,i.jsxs)(n.li,{children:["Use named middleware IDs (via ",(0,i.jsx)(n.code,{children:"MiddlewareRef.of('id')"}),") in config/manifests to decouple routing from implementations and ease swaps."]}),"\n",(0,i.jsx)(n.li,{children:"Be mindful of order: engine \u2192 group \u2192 route \u2192 handler, then unwind; put broad cross-cutting concerns (logging, request IDs) early and narrow checks (authorization) later."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>s});var t=r(6540);const i={},d=t.createContext(i);function a(e){const n=t.useContext(d);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(d.Provider,{value:n},e.children)}}}]);