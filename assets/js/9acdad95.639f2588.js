"use strict";(self.webpackChunkrouted=self.webpackChunkrouted||[]).push([[3721],{133:(e,i,s)=>{s.r(i),s.d(i,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"routed/security/upload-hardening","title":"Securing file uploads","description":"Configure Routed\u2019s uploads provider for safe defaults, extension filtering, and predictable storage.","source":"@site/docs/routed/security/uploads.mdx","sourceDirName":"routed/security","slug":"/routed/security/upload-hardening","permalink":"/docs/routed/security/upload-hardening","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/security/uploads.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"id":"upload-hardening","title":"Securing file uploads","sidebar_position":3,"description":"Configure Routed\u2019s uploads provider for safe defaults, extension filtering, and predictable storage."},"sidebar":"tutorialSidebar","previous":{"title":"Rate limiting","permalink":"/docs/routed/security/rate-limit"},"next":{"title":"Auth Providers & Adapters","permalink":"/docs/routed/security/auth-providers"}}');var n=s(4848),r=s(8453);const o={id:"upload-hardening",title:"Securing file uploads",sidebar_position:3,description:"Configure Routed\u2019s uploads provider for safe defaults, extension filtering, and predictable storage."},a=void 0,d={},l=[{value:"Configure the whitelist",id:"configure-the-whitelist",level:2},{value:"Pin uploads to a storage directory",id:"pin-uploads-to-a-storage-directory",level:2},{value:"Enforce limits and cleanup",id:"enforce-limits-and-cleanup",level:2},{value:"Operational checklist",id:"operational-checklist",level:2},{value:"Looking ahead",id:"looking-ahead",level:2}];function c(e){const i={a:"a",blockquote:"blockquote",br:"br",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.p,{children:"Routed\u2019s uploads provider streams multipart bodies efficiently, but you still need to guard against unsafe files and runaway disk usage. This guide walks through the hardened defaults landing in the next release and how to adopt them."}),"\n",(0,n.jsxs)(i.blockquote,{children:["\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.strong,{children:"TL;DR"}),(0,n.jsx)(i.br,{}),"\n","Start with a strict extension whitelist, pin uploads to a dedicated storage directory backed by a Routed disk, and let the provider clean up partial files automatically."]}),"\n"]}),"\n",(0,n.jsx)(i.h2,{id:"configure-the-whitelist",children:"Configure the whitelist"}),"\n",(0,n.jsxs)(i.p,{children:["Define the extensions your application accepts in ",(0,n.jsx)(i.code,{children:"config/uploads.yaml"})," (or the equivalent manifest block). Routed normalises values so you can supply ",(0,n.jsx)(i.code,{children:"jpg"})," (config) or ",(0,n.jsx)(i.code,{children:".jpg"})," (code) interchangeably."]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-yaml",metastring:'title="config/uploads.yaml"',children:"allowed_extensions:\n  - jpg\n  - png\n  - pdf\n"})}),"\n",(0,n.jsx)(i.p,{children:"If a request uploads a file with an extension not on the list, the framework rejects the stream before persisting any bytes and surfaces a 4xx error you can translate to your preferred response shape."}),"\n",(0,n.jsx)(i.h2,{id:"pin-uploads-to-a-storage-directory",children:"Pin uploads to a storage directory"}),"\n",(0,n.jsxs)(i.p,{children:["Hardened uploads write every accepted file to the directory configured under ",(0,n.jsx)(i.code,{children:"uploads.directory"}),". Point that directory at a storage disk so uploads share permissions, quota configuration, and observability with the rest of your storage layer."]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-yaml",metastring:'title="config/uploads.yaml"',children:"directory: uploads\nfile_permissions: 0o640\ndisk: app_uploads\n"})}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-yaml",metastring:'title="config/storage.yaml"',children:"disks:\n  app_uploads:\n    driver: local\n    root: /srv/app/uploads\n    visibility: private\n"})}),"\n",(0,n.jsx)(i.p,{children:"Key behaviours:"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"The provider refuses to use system temp directories once an override is supplied."}),"\n",(0,n.jsx)(i.li,{children:"Files inherit the configured permission mask so web servers cannot accidentally serve private content."}),"\n",(0,n.jsx)(i.li,{children:"Static assets or views can reuse the same disk, keeping IO consistent across subsystems."}),"\n"]}),"\n",(0,n.jsx)(i.h2,{id:"enforce-limits-and-cleanup",children:"Enforce limits and cleanup"}),"\n",(0,n.jsx)(i.p,{children:"Set per-file and aggregate quotas to prevent exhaustion attacks:"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-yaml",metastring:'title="config/uploads.yaml"',children:"max_file_size: 5242880   # 5 MiB per file\nmax_memory: 16777216     # 16 MiB request body buffer\nmax_disk_usage: 6291456  # 6 MiB total written to disk per request\n"})}),"\n",(0,n.jsx)(i.p,{children:"Routed streams multipart payloads and enforces these limits as data arrives:"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.code,{children:"max_memory"})," keeps the overall request size in check."]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.code,{children:"max_file_size"})," aborts a single part once it grows beyond the configured size."]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.code,{children:"max_disk_usage"})," bounds the bytes written to disk across every file in the request. As soon as the quota is exceeded the framework closes the current stream, deletes partial files, and rejects the upload before it can consume additional storage."]}),"\n"]}),"\n",(0,n.jsx)(i.p,{children:"If the client disconnects early or hits any limit, every partially written file is removed immediately\u2014no background sweeps required."}),"\n",(0,n.jsx)(i.h2,{id:"operational-checklist",children:"Operational checklist"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:["Audit ",(0,n.jsx)(i.code,{children:"allowed_extensions"})," regularly; accept the smallest useful list and prefer content-type validation in business logic where possible."]}),"\n",(0,n.jsxs)(i.li,{children:["Monitor the upload directory\u2019s disk usage. A simple ",(0,n.jsx)(i.code,{children:"du"})," alert tied to your storage disk catches unexpected growth."]}),"\n",(0,n.jsxs)(i.li,{children:["Run ",(0,n.jsx)(i.code,{children:"dart run routed_cli provider:list --config"})," to inspect the merged configuration and ensure extensions, directory, and limit values loaded as expected."]}),"\n",(0,n.jsxs)(i.li,{children:["Combine uploads with ",(0,n.jsx)(i.a,{href:"/docs/routed/security#security-headers",children:"security headers"})," so browsers avoid caching sensitive responses."]}),"\n"]}),"\n",(0,n.jsx)(i.h2,{id:"looking-ahead",children:"Looking ahead"}),"\n",(0,n.jsx)(i.p,{children:"The hardened defaults in this roadmap milestone pave the way for:"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"Drive-by scanning hooks so you can plug in antivirus or content validation filters."}),"\n",(0,n.jsx)(i.li,{children:"Storage driver quotas shared across uploads, static assets, and user-generated content."}),"\n",(0,n.jsx)(i.li,{children:"Operator-facing dashboards (via the CLI) that report rejected uploads and cleanup statistics."}),"\n"]}),"\n",(0,n.jsx)(i.p,{children:"Adopting the settings above keeps you aligned with the upcoming release while leaving room for these future additions."})]})}function u(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,n.jsx)(i,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},8453:(e,i,s)=>{s.d(i,{R:()=>o,x:()=>a});var t=s(6540);const n={},r=t.createContext(n);function o(e){const i=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function a(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),t.createElement(r.Provider,{value:i},e.children)}}}]);