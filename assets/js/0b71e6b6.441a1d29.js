"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[8524],{2222:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"websocket-hub","title":"WebSocket Hub","description":"The WebSocket hub enables real-time broadcasting of Turbo Stream fragments to connected clients. It follows a topic-based pub/sub model: clients subscribe to topics when they connect, and your server code broadcasts fragments to a topic to push updates to all subscribers.","source":"@site/docs/routed_hotwire/websocket-hub.mdx","sourceDirName":".","slug":"/websocket-hub","permalink":"/docs/routed_hotwire/websocket-hub","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed_hotwire/websocket-hub.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"WebSocket Hub","sidebar_position":3},"sidebar":"routedHotwireSidebar","previous":{"title":"Requests & Responses","permalink":"/docs/routed_hotwire/requests-responses"},"next":{"title":"Stream Signing","permalink":"/docs/routed_hotwire/stream-signing"}}');var o=t(4848),r=t(8453);const c={title:"WebSocket Hub",sidebar_position:3},i="WebSocket Hub",a={},d=[{value:"Architecture",id:"architecture",level:2},{value:"Setup",id:"setup",level:2},{value:"1. Create the Hub and Handler",id:"1-create-the-hub-and-handler",level:3},{value:"2. Register a WebSocket Route",id:"2-register-a-websocket-route",level:3},{value:"3. Broadcast From Your Routes",id:"3-broadcast-from-your-routes",level:3},{value:"4. Client-Side Connection",id:"4-client-side-connection",level:3},{value:"TurboStreamHub API",id:"turbostreamhub-api",level:2},{value:"<code>subscribe(connection, topics)</code>",id:"subscribeconnection-topics",level:3},{value:"<code>unsubscribe(connection, {topics})</code>",id:"unsubscribeconnection-topics",level:3},{value:"<code>broadcast(topic, fragments)</code>",id:"broadcasttopic-fragments",level:3},{value:"TurboStreamSocketHandler",id:"turbostreamsockethandler",level:2},{value:"Custom Topic Resolver",id:"custom-topic-resolver",level:3},{value:"Custom Message Handler",id:"custom-message-handler",level:3},{value:"Signed Topics",id:"signed-topics",level:2},{value:"Custom Connection Implementations",id:"custom-connection-implementations",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"websocket-hub",children:"WebSocket Hub"})}),"\n",(0,o.jsxs)(n.p,{children:["The WebSocket hub enables real-time broadcasting of Turbo Stream fragments to connected clients. It follows a ",(0,o.jsx)(n.strong,{children:"topic-based pub/sub"})," model: clients subscribe to topics when they connect, and your server code broadcasts fragments to a topic to push updates to all subscribers."]}),"\n",(0,o.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'Client A \u2500\u2500ws\u2500\u2500\u2510                 \u250c\u2500\u2500 Client A (subscribed to "chat:1")\nClient B \u2500\u2500ws\u2500\u2500\u2524  TurboStreamHub \u251c\u2500\u2500 Client B (subscribed to "chat:1", "chat:2")\nClient C \u2500\u2500ws\u2500\u2500\u2518                 \u2514\u2500\u2500 Client C (subscribed to "chat:2")\n\nhub.broadcast("chat:1", fragments)  \u2192  delivers to Client A and Client B\nhub.broadcast("chat:2", fragments)  \u2192  delivers to Client B and Client C\n'})}),"\n",(0,o.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,o.jsx)(n.h3,{id:"1-create-the-hub-and-handler",children:"1. Create the Hub and Handler"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"import 'package:routed/routed.dart';\nimport 'package:routed_hotwire/routed_hotwire.dart';\n\nfinal hub = TurboStreamHub();\nfinal handler = TurboStreamSocketHandler(hub: hub);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"2-register-a-websocket-route",children:"2. Register a WebSocket Route"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"final engine = await Engine.create();\n\nengine.ws('/turbo-streams', handler);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"3-broadcast-from-your-routes",children:"3. Broadcast From Your Routes"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"engine.post('/messages', (ctx) async {\n  final body = ctx.input('body');\n  final roomId = ctx.input('room_id');\n\n  // Build the Turbo Stream fragment\n  final fragment = turboStreamAppend(\n    target: 'messages',\n    html: '<div class=\"message\">$body</div>',\n  );\n\n  // Broadcast to all WebSocket clients subscribed to this room\n  hub.broadcast('chat:$roomId', [fragment]);\n\n  // Also respond to the HTTP request\n  return ctx.turboStream(fragment);\n});\n"})}),"\n",(0,o.jsx)(n.h3,{id:"4-client-side-connection",children:"4. Client-Side Connection"}),"\n",(0,o.jsx)(n.p,{children:"On the client side, connect to the WebSocket with topic query parameters:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// Subscribe to a single topic\nconst ws = new WebSocket('ws://localhost:8080/turbo-streams?topic=chat:1');\n\n// Subscribe to multiple topics\nconst ws = new WebSocket('ws://localhost:8080/turbo-streams?topic=chat:1&topic=chat:2');\n\n// Comma-separated topics also work\nconst ws = new WebSocket('ws://localhost:8080/turbo-streams?topic=chat:1,chat:2');\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Turbo Stream fragments arrive as WebSocket messages and can be processed by Turbo's ",(0,o.jsx)(n.code,{children:"StreamActions"})," on the client."]}),"\n",(0,o.jsx)(n.h2,{id:"turbostreamhub-api",children:"TurboStreamHub API"}),"\n",(0,o.jsx)(n.h3,{id:"subscribeconnection-topics",children:(0,o.jsx)(n.code,{children:"subscribe(connection, topics)"})}),"\n",(0,o.jsx)(n.p,{children:"Register a connection under one or more topics."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"hub.subscribe(connection, ['chat:1', 'chat:2']);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"unsubscribeconnection-topics",children:(0,o.jsx)(n.code,{children:"unsubscribe(connection, {topics})"})}),"\n",(0,o.jsx)(n.p,{children:"Remove a connection from all topics, or from a specific subset:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"// Remove from all topics\nhub.unsubscribe(connection);\n\n// Remove from specific topics only\nhub.unsubscribe(connection, topics: ['chat:1']);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"broadcasttopic-fragments",children:(0,o.jsx)(n.code,{children:"broadcast(topic, fragments)"})}),"\n",(0,o.jsx)(n.p,{children:"Send Turbo Stream fragments to every subscriber of a topic. Fragments are joined into a single payload before sending."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"hub.broadcast('notifications', [\n  turboStreamAppend(target: 'alerts', html: '<div>New alert</div>'),\n  turboStreamUpdate(target: 'badge', html: '5'),\n]);\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The hub automatically detects and removes disconnected clients (connections with a non-null ",(0,o.jsx)(n.code,{children:"closeCode"})," or that throw on ",(0,o.jsx)(n.code,{children:"send"}),")."]}),"\n",(0,o.jsx)(n.h2,{id:"turbostreamsockethandler",children:"TurboStreamSocketHandler"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"TurboStreamSocketHandler"})," extends routed's ",(0,o.jsx)(n.code,{children:"WebSocketHandler"})," and manages the full WebSocket lifecycle:"]}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"Callback"}),(0,o.jsx)(n.th,{children:"Behavior"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"onOpen"})}),(0,o.jsx)(n.td,{children:"Resolves topics from query parameters, subscribes the connection. Closes with code 1008 if no topics are found."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"onMessage"})}),(0,o.jsxs)(n.td,{children:["Delegates to an optional ",(0,o.jsx)(n.code,{children:"messageHandler"})," callback."]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"onClose"})}),(0,o.jsx)(n.td,{children:"Unsubscribes the connection from the hub."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"onError"})}),(0,o.jsx)(n.td,{children:"Unsubscribes the connection from the hub."})]})]})]}),"\n",(0,o.jsx)(n.h3,{id:"custom-topic-resolver",children:"Custom Topic Resolver"}),"\n",(0,o.jsxs)(n.p,{children:["By default, topics are extracted from ",(0,o.jsx)(n.code,{children:"?topic="})," query parameters. You can provide a custom ",(0,o.jsx)(n.code,{children:"TurboTopicResolver"})," to change this behavior:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"Iterable<String> myResolver(WebSocketContext context) {\n  // Extract topics from the path instead of query parameters\n  final roomId = context.initialContext.pathParameters['room'];\n  return roomId != null ? ['chat:$roomId'] : [];\n}\n\nfinal handler = TurboStreamSocketHandler(\n  hub: hub,\n  topicResolver: myResolver,\n);\n\nengine.ws('/rooms/{room}/stream', handler);\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"TurboTopicResolver"})," typedef is:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"typedef TurboTopicResolver = Iterable<String> Function(WebSocketContext context);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"custom-message-handler",children:"Custom Message Handler"}),"\n",(0,o.jsxs)(n.p,{children:["By default, incoming WebSocket messages are ignored. Pass a ",(0,o.jsx)(n.code,{children:"messageHandler"})," to process them:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"final handler = TurboStreamSocketHandler(\n  hub: hub,\n  messageHandler: (context, message) async {\n    // Handle incoming messages from clients\n    print('Received: $message');\n  },\n);\n"})}),"\n",(0,o.jsx)(n.h2,{id:"signed-topics",children:"Signed Topics"}),"\n",(0,o.jsxs)(n.p,{children:["The default topic resolver automatically verifies signed stream names. If a topic parameter contains a signed name (format ",(0,o.jsx)(n.code,{children:"base64payload--base64signature"}),"), it is verified and the original topic name is extracted. Unsigned topic strings are passed through as-is."]}),"\n",(0,o.jsxs)(n.p,{children:["See ",(0,o.jsx)(n.a,{href:"./stream-signing",children:"Stream Signing"})," for details on generating signed names."]}),"\n",(0,o.jsx)(n.h2,{id:"custom-connection-implementations",children:"Custom Connection Implementations"}),"\n",(0,o.jsxs)(n.p,{children:["The hub operates on the ",(0,o.jsx)(n.code,{children:"TurboStreamConnection"})," interface:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"abstract class TurboStreamConnection {\n  int? get closeCode;\n  void send(String payload);\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The built-in ",(0,o.jsx)(n.code,{children:"WebSocketTurboConnection"})," wraps a routed ",(0,o.jsx)(n.code,{children:"WebSocketContext"}),". You can implement this interface to integrate with other transports (SSE, long-polling, test doubles, etc.)."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>i});var s=t(6540);const o={},r=s.createContext(o);function c(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);