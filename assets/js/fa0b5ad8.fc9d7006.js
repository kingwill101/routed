"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[7156],{8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>o});var i=r(6540);const t={},s=i.createContext(t);function a(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}},8792:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"stream-signing","title":"Stream Signing","description":"Stream signing prevents unauthorized clients from subscribing to arbitrary topics. Topic names are HMAC-SHA256 signed server-side and verified when a WebSocket connection is established. This is analogous to Rails\' signed stream names in Action Cable.","source":"@site/docs/routed_hotwire/stream-signing.mdx","sourceDirName":".","slug":"/stream-signing","permalink":"/docs/routed_hotwire/stream-signing","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed_hotwire/stream-signing.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Stream Signing","sidebar_position":4},"sidebar":"routedHotwireSidebar","previous":{"title":"WebSocket Hub","permalink":"/docs/routed_hotwire/websocket-hub"}}');var t=r(4848),s=r(8453);const a={title:"Stream Signing",sidebar_position:4},o="Stream Signing",d={},c=[{value:"How It Works",id:"how-it-works",level:2},{value:"Signing a Stream Name",id:"signing-a-stream-name",level:2},{value:"<code>buildTurboStreamName</code>",id:"buildturbostreamname",level:3},{value:"<code>signTurboStreamName</code>",id:"signturbostreamname",level:3},{value:"<code>verifyTurboStreamName</code>",id:"verifyturbostreamname",level:3},{value:"Configuring the Signing Secret",id:"configuring-the-signing-secret",level:2},{value:"Generating HTML Source Tags",id:"generating-html-source-tags",level:2},{value:"Parameters",id:"parameters",level:3},{value:"<code>TurboStreamIdentifiable</code>",id:"turbostreamidentifiable",level:2},{value:"Integration with the WebSocket Hub",id:"integration-with-the-websocket-hub",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"stream-signing",children:"Stream Signing"})}),"\n",(0,t.jsx)(n.p,{children:"Stream signing prevents unauthorized clients from subscribing to arbitrary topics. Topic names are HMAC-SHA256 signed server-side and verified when a WebSocket connection is established. This is analogous to Rails' signed stream names in Action Cable."}),"\n",(0,t.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Server"})," builds a canonical stream name from identifiers (model IDs, channel names, etc.)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Server"})," signs the name with HMAC-SHA256 and base64url-encodes it: ",(0,t.jsx)(n.code,{children:"base64payload--base64signature"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Client"})," receives the signed name (e.g., embedded in HTML) and passes it as a topic query parameter when connecting via WebSocket"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Server"})," verifies the signature before allowing the subscription"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"signing-a-stream-name",children:"Signing a Stream Name"}),"\n",(0,t.jsx)(n.h3,{id:"buildturbostreamname",children:(0,t.jsx)(n.code,{children:"buildTurboStreamName"})}),"\n",(0,t.jsx)(n.p,{children:"Builds a canonical colon-separated name from a list of objects:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:'buildTurboStreamName([\'chat\', 42]);\n// => "chat:42"\n\nbuildTurboStreamName([\'notifications\', user]);\n// => "notifications:user-123" (if user.toString() returns "user-123")\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Objects implementing ",(0,t.jsx)(n.code,{children:"TurboStreamIdentifiable"})," use their ",(0,t.jsx)(n.code,{children:"turboStreamIdentifier"})," property:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"class Room implements TurboStreamIdentifiable {\n  final int id;\n  Room(this.id);\n\n  @override\n  String get turboStreamIdentifier => 'room-$id';\n}\n\nbuildTurboStreamName([Room(5), 'messages']);\n// => \"room-5:messages\"\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Nested ",(0,t.jsx)(n.code,{children:"Iterable"})," values are flattened. Null values are skipped. Empty strings are ignored."]}),"\n",(0,t.jsx)(n.h3,{id:"signturbostreamname",children:(0,t.jsx)(n.code,{children:"signTurboStreamName"})}),"\n",(0,t.jsx)(n.p,{children:"Builds the canonical name and returns the signed form:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"final signed = signTurboStreamName(['chat', 42]);\n// => \"Y2hhdDo0Mg==--3xK9f...\" (base64url payload + HMAC signature)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"verifyturbostreamname",children:(0,t.jsx)(n.code,{children:"verifyTurboStreamName"})}),"\n",(0,t.jsx)(n.p,{children:"Verifies a signed name and returns the original topic if valid:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:'final topic = verifyTurboStreamName(signed);\n// => "chat:42" (or null if signature is invalid)\n'})}),"\n",(0,t.jsx)(n.p,{children:"Verification uses constant-time comparison to prevent timing attacks."}),"\n",(0,t.jsx)(n.h2,{id:"configuring-the-signing-secret",children:"Configuring the Signing Secret"}),"\n",(0,t.jsxs)(n.p,{children:["By default, a 32-byte random secret is generated at startup. ",(0,t.jsx)(n.strong,{children:"This means signed names are only valid for the lifetime of the process."})," For production deployments with multiple instances or restarts, set a stable secret:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"turboStreamSigningSecret = 'your-stable-secret-key';\n"})}),"\n",(0,t.jsx)(n.p,{children:"Set this before any signing or verification calls. You might load it from environment variables or your application config:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"turboStreamSigningSecret = Platform.environment['TURBO_SIGNING_SECRET']\n    ?? 'development-secret';\n"})}),"\n",(0,t.jsx)(n.h2,{id:"generating-html-source-tags",children:"Generating HTML Source Tags"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"turboStreamSourceTag"})," generates a ",(0,t.jsx)(n.code,{children:"<turbo-cable-stream-source>"})," HTML element with a signed stream name. This tag tells the Turbo client to subscribe to the stream:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"final tag = turboStreamSourceTag(\n  streamables: ['chat', roomId],\n  channel: 'Turbo::StreamsChannel',\n  dataAttributes: {'controller': 'turbo-stream'},\n);\n"})}),"\n",(0,t.jsx)(n.p,{children:"Produces:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-html",children:'<turbo-cable-stream-source\n  channel="Turbo::StreamsChannel"\n  signed-stream-name="Y2hhdDox--..."\n  data-controller="turbo-stream"\n></turbo-cable-stream-source>\n'})}),"\n",(0,t.jsx)(n.h3,{id:"parameters",children:"Parameters"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Parameter"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Default"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"streamables"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"Iterable<Object?>"})," (required)"]}),(0,t.jsx)(n.td,{children:"\u2014"}),(0,t.jsx)(n.td,{children:"Objects to build the stream name from"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"channel"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"String"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"'Turbo::StreamsChannel'"})}),(0,t.jsx)(n.td,{children:"The channel name attribute"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"dataAttributes"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"Map<String, String>?"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"null"})}),(0,t.jsxs)(n.td,{children:["Extra ",(0,t.jsx)(n.code,{children:"data-*"})," attributes"]})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"Data attribute keys are normalized: underscores and spaces become hyphens. Values are HTML-escaped."}),"\n",(0,t.jsx)(n.h2,{id:"turbostreamidentifiable",children:(0,t.jsx)(n.code,{children:"TurboStreamIdentifiable"})}),"\n",(0,t.jsx)(n.p,{children:"Implement this interface on your model classes to provide stable identifiers for stream naming:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"abstract class TurboStreamIdentifiable {\n  String get turboStreamIdentifier;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"class User implements TurboStreamIdentifiable {\n  final int id;\n  final String name;\n  User({required this.id, required this.name});\n\n  @override\n  String get turboStreamIdentifier => 'user-$id';\n}\n\nclass Project implements TurboStreamIdentifiable {\n  final String slug;\n  Project({required this.slug});\n\n  @override\n  String get turboStreamIdentifier => slug;\n}\n\n// Sign a stream scoped to a user's project\nfinal signed = signTurboStreamName([user, project, 'updates']);\n// Canonical name: \"user-42:my-project:updates\"\n"})}),"\n",(0,t.jsx)(n.h2,{id:"integration-with-the-websocket-hub",children:"Integration with the WebSocket Hub"}),"\n",(0,t.jsxs)(n.p,{children:["The default ",(0,t.jsx)(n.code,{children:"TurboStreamSocketHandler"})," topic resolver automatically calls ",(0,t.jsx)(n.code,{children:"verifyTurboStreamName"})," on each ",(0,t.jsx)(n.code,{children:"?topic="})," query parameter. If verification succeeds, the original plain-text name is used as the topic. If verification fails (invalid signature), the raw string is used as-is."]}),"\n",(0,t.jsx)(n.p,{children:"This means you can use signed names for secure topics and plain names for public topics in the same application:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"// Server: broadcast to the verified topic name\nhub.broadcast('chat:42', [fragment]);\n\n// Client connects with a signed topic\n// ws://localhost:8080/turbo-streams?topic=Y2hhdDo0Mg==--3xK9f...\n// The handler verifies it to \"chat:42\" and subscribes\n"})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);