"use strict";(self.webpackChunkrouted=self.webpackChunkrouted||[]).push([[761],{4836:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"routed/state/sessions","title":"Sessions","description":"Configure cookie or file-based sessions and work with flash messages","source":"@site/docs/routed/state/sessions.mdx","sourceDirName":"routed/state","slug":"/routed/state/sessions","permalink":"/docs/routed/state/sessions","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/state/sessions.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Sessions","description":"Configure cookie or file-based sessions and work with flash messages","sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Caching","permalink":"/docs/routed/state/caching"},"next":{"title":"Views & Templates","permalink":"/docs/routed/views/"}}');var r=s(4848),o=s(8453);const t={title:"Sessions",description:"Configure cookie or file-based sessions and work with flash messages",sidebar_position:2},a="Session Management",c={},d=[{value:"Configuration",id:"configuration",level:2},{value:"Supported drivers",id:"supported-drivers",level:3},{value:"Driver registry &amp; documentation",id:"driver-registry--documentation",level:3},{value:"Cache-backed sessions",id:"cache-backed-sessions",level:3},{value:"Security Options",id:"security-options",level:3},{value:"Session Operations",id:"session-operations",level:2},{value:"Basic Operations",id:"basic-operations",level:3},{value:"Session Lifecycle",id:"session-lifecycle",level:3},{value:"Storage Backends",id:"storage-backends",level:2},{value:"Cookie Store",id:"cookie-store",level:3},{value:"File Store",id:"file-store",level:3},{value:"Cache-backed Store",id:"cache-backed-store",level:3},{value:"Array Store",id:"array-store",level:3},{value:"Custom Store",id:"custom-store",level:3},{value:"Flash Messages",id:"flash-messages",level:2},{value:"Session Internals",id:"session-internals",level:2},{value:"Session Object",id:"session-object",level:3},{value:"Store Configuration",id:"store-configuration",level:3}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"session-management",children:"Session Management"})}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Routed now mirrors Laravel's manifest, so the same ",(0,r.jsx)(n.code,{children:".env"})," switches carry straight across:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="config/http.yaml"',children:"session:\n  driver: cookie                    # cookie, file, array, database, redis, memcached, dynamodb\n  lifetime: 120                     # minutes\n  expire_on_close: false\n  encrypt: true                     # AES-GCM + HMAC\n  cookie: \"{{ env.APP_NAME | default: 'routed' | downcase | replace: ' ', '-' }}-session\"\n  path: /\n  domain: null\n  secure: ${SESSION_SECURE_COOKIE:true}\n  http_only: true\n  same_site: lax                    # lax, strict, none, or null\n  partitioned: ${SESSION_PARTITIONED_COOKIE:false}\n\n  files: storage/framework/sessions # file driver storage path\n  store: session                    # cache-backed drivers resolve via cache.stores\n  cache_prefix: sess:\n  lottery: [2, 100]\n\napp:\n  name: \"{{ env.APP_NAME | default: 'Routed App' }}\"\n  env: \"{{ env.APP_ENV | default: 'production' }}\"\n  debug: {{ env.APP_DEBUG | default: false }}\n  url: \"{{ env.APP_URL | default: 'http://localhost' }}\"\n  timezone: UTC\n  locale: en\n  fallback_locale: en\n  faker_locale: en_US\n  cipher: AES-256-CBC\n  key: \"{{ env.APP_KEY }}\"                     # generate with `dart run routed_cli key:generate`\n  previous_keys: {{ env.APP_PREVIOUS_KEYS | split: ',' }}\n  maintenance:\n    driver: \"{{ env.APP_MAINTENANCE_DRIVER | default: 'file' }}\"\n    store: \"{{ env.APP_MAINTENANCE_STORE | default: 'database' }}\"\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dotenv",metastring:'title=".env"',children:"SESSION_DRIVER=redis\nSESSION_LIFETIME=120\nSESSION_EXPIRE_ON_CLOSE=true\nSESSION_STORE=redis\nSESSION_FILES=storage/framework/sessions\nSESSION_LOTTERY=2,100\nSESSION_SAME_SITE=none\nSESSION_HTTP_ONLY=true\nSESSION_SECURE_COOKIE=true\nSESSION_COOKIE=myapp-session\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Double underscores still expand to dotted keys (",(0,r.jsx)(n.code,{children:"SESSION__CACHE__PREFIX"})," \u279c ",(0,r.jsx)(n.code,{children:"session.cache.prefix"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["The cache-backed drivers (",(0,r.jsx)(n.code,{children:"database"}),", ",(0,r.jsx)(n.code,{children:"redis"}),", ",(0,r.jsx)(n.code,{children:"memcached"}),", ",(0,r.jsx)(n.code,{children:"dynamodb"}),") reuse whichever repository you register under ",(0,r.jsx)(n.code,{children:"cache.stores[session.store]"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"app.previous_keys"})," lets you rotate secrets without signing out active users. New cookies are issued with ",(0,r.jsx)(n.code,{children:"app.key"})," while older ones remain readable via the fallback list."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Prefer code? Supply a ",(0,r.jsx)(n.code,{children:"SessionConfig"})," when creating the engine:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final codecs = [SecureCookie(key: SecureCookie.generateKey(), useEncryption: true, useSigning: true)];\nfinal engine = Engine(\n  config: EngineConfig(\n    sessionConfig: SessionConfig.cookie(\n      codecs: codecs,\n      cookieName: 'app_session',\n      maxAge: const Duration(hours: 1),\n      expireOnClose: false,\n    ),\n  ),\n);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"withSessionConfig"})," engine option applies the same configuration and automatically inserts the session middleware as the first global middleware."]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"routed.sessions"})," provider validates manifest overrides for ",(0,r.jsx)(n.code,{children:"session.*"}),". If a value has the wrong shape (for example, an unknown cache store) a ",(0,r.jsx)(n.code,{children:"ProviderConfigException"})," is thrown during boot. Use ",(0,r.jsx)(n.code,{children:"dart run routed_cli provider:list --config"})," to inspect the merged config before deploying."]}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Keys & rotation:"})," Every driver still needs ",(0,r.jsx)(n.code,{children:"app.key"})," (or ",(0,r.jsx)(n.code,{children:"session.app_key"}),"). Keep it secret, rotate it with ",(0,r.jsx)(n.code,{children:"dart run routed_cli key:generate"}),", then append the previous value to ",(0,r.jsx)(n.code,{children:"APP_PREVIOUS_KEYS"})," so existing cookies continue to decode while new ones are issued with the replacement key."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"supported-drivers",children:"Supported drivers"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cookie"})," \u2013 stores the entire payload in the cookie using layered ",(0,r.jsx)(n.code,{children:"SecureCookie"})," codecs when ",(0,r.jsx)(n.code,{children:"encrypt: true"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"file"})," \u2013 persists JSON blobs under ",(0,r.jsx)(n.code,{children:"session.files"}),". Use ",(0,r.jsx)(n.code,{children:"session.lottery"})," or ",(0,r.jsx)(n.code,{children:"FilesystemStore.pruneOnStartup"})," to clear expired sessions opportunistically."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"array"})," \u2013 process-local, in-memory storage that resets on every restart."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"database"}),", ",(0,r.jsx)(n.code,{children:"redis"}),", ",(0,r.jsx)(n.code,{children:"memcached"}),", ",(0,r.jsx)(n.code,{children:"dynamodb"})," \u2013 delegate to the cache manager and respect both ",(0,r.jsx)(n.code,{children:"session.cache_prefix"})," and the global ",(0,r.jsx)(n.code,{children:"cache.prefix"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"partitioned"})," is accepted for forward compatibility (the current ",(0,r.jsx)(n.code,{children:"dart:io"})," ",(0,r.jsx)(n.code,{children:"Cookie"})," API does not emit the Partitioned attribute yet)."]}),"\n",(0,r.jsx)(n.h3,{id:"driver-registry--documentation",children:"Driver registry & documentation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:'title="Import registry helpers"',children:"import 'package:routed/drivers.dart';\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"SessionServiceProvider.registerDriver"})," is the single entrypoint for adding or overriding drivers. The built-ins use this method, so any custom driver you publish rides the same resolution path:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"SessionServiceProvider.registerDriver(\n  'dropbox',\n  (context) => SessionConfig(\n    cookieName: context.cookieName,\n    store: DropboxSessionStore(\n      root: context.raw['root'] ?? '/sessions',\n      token: context.raw['token'] as String,\n    ),\n    maxAge: context.lifetime,\n    defaultOptions: context.options,\n    expireOnClose: context.expireOnClose,\n  ),\n  documentation: (ctx) => <ConfigDocEntry>[\n    ConfigDocEntry(\n      path: ctx.path('token'),\n      type: 'string',\n      description: 'Access token required for the dropbox session driver.',\n    ),\n    ConfigDocEntry(\n      path: ctx.path('root'),\n      type: 'string',\n      description: 'Remote folder for storing session payloads.',\n    ),\n  ],\n);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Provide a ",(0,r.jsx)(n.code,{children:"documentation"})," callback to advertise config keys in ",(0,r.jsx)(n.code,{children:"provider:list --config"})," output and in the table above. This keeps built-in and custom drivers equally discoverable; the docs list everything under ",(0,r.jsx)(n.code,{children:"session.*"}),", including the entries contributed by your driver. See ",(0,r.jsx)(n.a,{href:"/docs/routed/advanced/driver-registries",children:"Driver Registries"})," for additional guidance."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"routed provider:driver --type cache session_cache\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Need a starting point? The CLI generates driver skeletons (storage or cache) in ",(0,r.jsx)(n.code,{children:"lib/drivers/<type>/"}),", mirroring the patterns described above."]}),"\n",(0,r.jsx)(n.h3,{id:"cache-backed-sessions",children:"Cache-backed sessions"}),"\n",(0,r.jsxs)(n.p,{children:["Declare the cache store and point ",(0,r.jsx)(n.code,{children:"session.store"})," at it:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="config/http.yaml"',children:"cache:\n  stores:\n    session:\n      driver: redis\n      endpoint: {{ env.REDIS_URL }}\n\nsession:\n  driver: redis\n  store: session\n  cache_prefix: sess:\n"})}),"\n",(0,r.jsx)(n.h3,{id:"security-options",children:"Security Options"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final store = CookieStore(\n  codecs: [\n    SecureCookie(\n      key: SecureCookie.generateKey(),\n      useEncryption: true,\n      useSigning: true,\n    ),\n    SecureCookie(\n      key: previousKey,\n      useEncryption: true,\n      useSigning: true,\n    ),\n  ],\n  defaultOptions: Options(\n    path: '/',\n    maxAge: 86400,\n    secure: true,\n    httpOnly: true,\n    sameSite: SameSite.lax,\n  ),\n);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Each encrypted cookie uses a unique 12-byte nonce (IV). The nonce is sent alongside the ciphertext and validated by the GCM authentication tag\u2014never reuse a ",(0,r.jsx)(n.code,{children:"(key, nonce)"})," pair."]}),"\n",(0,r.jsx)(n.h2,{id:"session-operations",children:"Session Operations"}),"\n",(0,r.jsx)(n.h3,{id:"basic-operations",children:"Basic Operations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"router.get('/profile', (ctx) async {\n  // Get session values\n  final userId = ctx.getSession<String>('user_id');\n  final role = ctx.getSessionOrDefault('role', 'guest');\n  \n  // Set values\n  ctx.setSession('last_visit', DateTime.now());\n  \n  // Check existence\n  if (ctx.hasSession('preferences')) {\n    // Access preferences\n  }\n  \n  // Remove value\n  ctx.removeSession('temp_data');\n  \n  // Clear all data\n  ctx.clearSession();\n  \n  // Get all session data\n  final allData = ctx.sessionData;\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"session-lifecycle",children:"Session Lifecycle"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"router.post('/auth', (ctx) async {\n  // Session metadata\n  final info = {\n    'id': ctx.sessionId,\n    'created': ctx.sessionCreatedAt,\n    'last_accessed': ctx.sessionLastAccessed,\n    'age_seconds': ctx.sessionAge,\n    'idle_seconds': ctx.sessionIdleTime\n  };\n\n  // Security operations\n  // Regenerate after login or privilege changes to prevent fixation\n  ctx.regenerateSession();  // New session ID\n  ctx.destroySession();     // End session\n  \n  // Check state\n  if (ctx.isSessionDestroyed) {\n    return ctx.json({'error': 'Session expired'});\n  }\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"storage-backends",children:"Storage Backends"}),"\n",(0,r.jsx)(n.h3,{id:"cookie-store",children:"Cookie Store"}),"\n",(0,r.jsx)(n.p,{children:"Store sessions in encrypted cookies (good for stateless apps; constrained by cookie size limits):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"SessionConfig.cookie(\n  appKey: 'your-secret-key',\n  cookieName: 'app_session',\n  maxAge: Duration(hours: 1)\n)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"file-store",children:"File Store"}),"\n",(0,r.jsx)(n.p,{children:"Store sessions on filesystem (server-side storage; supports pruning; centralize or share for multi-instance deployments):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"SessionConfig.file(\n  appKey: 'your-secret-key',\n  storagePath: 'storage/sessions',\n  cookieName: 'app_session',\n  maxAge: Duration(hours: 1)\n)\n"})}),"\n",(0,r.jsx)(n.p,{children:"Advanced options (explicit store to enable pruning and security options):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final config = SessionConfig(\n  cookieName: 'app_session',\n  store: FilesystemStore(\n    storageDir: 'storage/sessions',\n    useEncryption: true,   // AES-GCM for cookie value\n    useSigning: true,      // HMAC signing for cookie value\n    pruneOnStartup: true,  // remove expired files on startup\n    lottery: [2, 100],     // 2% chance to sweep on each write\n  ),\n  maxAge: Duration(hours: 1),\n  path: '/',\n  secure: true,\n  httpOnly: true\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"cache-backed-store",children:"Cache-backed Store"}),"\n",(0,r.jsx)(n.p,{children:"Reuse the cache manager for server-side sessions:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final cacheManager = await engine.make<CacheManager>();\nfinal config = SessionConfig(\n  cookieName: 'app_session',\n  store: CacheSessionStore(\n    repository: cacheManager.store('session'),\n    codecs: [\n      SecureCookie(\n        key: 'base64:...',\n        useEncryption: true,\n        useSigning: true,\n      ),\n    ],\n    defaultOptions: Options(path: '/', maxAge: 7200, secure: true, httpOnly: true),\n    cachePrefix: 'sess:',\n  ),\n  maxAge: const Duration(minutes: 120),\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"array-store",children:"Array Store"}),"\n",(0,r.jsx)(n.p,{children:"Ephemeral, process-local sessions that reset whenever the process restarts:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final config = SessionConfig(\n  cookieName: 'app_session',\n  store: MemorySessionStore(\n    codecs: [\n      SecureCookie(\n        key: 'base64:...',\n        useEncryption: true,\n        useSigning: true,\n      ),\n    ],\n    defaultOptions: Options(path: '/', maxAge: 0, secure: false, httpOnly: true),\n  ),\n  maxAge: const Duration(minutes: 30),\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"custom-store",children:"Custom Store"}),"\n",(0,r.jsx)(n.p,{children:"Implement custom storage backend:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"class CustomStore implements Store {\n  @override\n  Future<Session> read(Request request, String name) async {\n    // Load session data\n  }\n\n  @override\n  Future<void> write(\n    Request request, \n    Response response, \n    Session session\n  ) async {\n    // Save session data\n  }\n}\n\nTo bundle a custom store as a provider, register it with the `ProviderRegistry` and add it to `http.providers`:\n\n```dart\nclass RedisSessionProvider extends ServiceProvider with ProvidesDefaultConfig {\n  @override\n  Map<String, dynamic> get defaultConfig => const {\n    'session': {\n      'driver': 'redis',\n      'store': 'session',\n    },\n    'cache': {\n      'stores': {\n        'session': {\n          'driver': 'redis',\n          'endpoint': '{{ env.REDIS_URL }}',\n        },\n      },\n    },\n  };\n\n  @override\n  void register(Container container) {\n    container.singleton<SessionConfig>((c) async {\n      final config = await c.make<Config>();\n      final cacheManager = await c.make<CacheManager>();\n      final appKey = config.get('app.key') as String;\n      return SessionConfig(\n        cookieName: 'app_session',\n        store: CacheSessionStore(\n          repository: cacheManager.store('session'),\n          codecs: [\n            SecureCookie(\n              key: appKey,\n              useEncryption: true,\n              useSigning: true,\n            ),\n          ],\n          defaultOptions: Options(path: '/', maxAge: 7200, secure: true, httpOnly: true),\n          cachePrefix: 'sess:',\n        ),\n        maxAge: const Duration(minutes: 120),\n      );\n    });\n  }\n}\n\nProviderRegistry.instance.register(\n  'app.sessions.redis',\n  factory: () => RedisSessionProvider(),\n  description: 'Redis-backed session store',\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"flash-messages",children:"Flash Messages"}),"\n",(0,r.jsx)(n.p,{children:"Temporary session data that auto-clears after being read:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"// Set messages\nctx.flash('Profile updated', 'success');\nctx.flash('Fix these errors', 'error');\n\n// Get all messages\nfinal messages = ctx.getFlashMessages();\n\n// Get filtered messages\nfinal errors = ctx.getFlashMessages(\n  withCategories: true,\n  categoryFilter: ['error']\n);\n\n// Check for messages\nif (ctx.hasFlashMessages()) {\n  // Handle pending messages\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Flash data is removed when you call ",(0,r.jsx)(n.code,{children:"getFlashMessages"}),", so store the result if you need to reference it more than once during the same request."]}),"\n",(0,r.jsx)(n.h2,{id:"session-internals",children:"Session Internals"}),"\n",(0,r.jsx)(n.h3,{id:"session-object",children:"Session Object"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final session = Session(\n  name: 'app_session',\n  options: Options(\n    path: '/',\n    maxAge: 3600,\n    secure: true\n  ),\n  values: {\n    'user_id': '123',\n    'role': 'admin'\n  }\n);\n\n// Session properties\nprint(session.id);          // Unique ID\nprint(session.createdAt);   // Creation time\nprint(session.lastAccessed);// Last access time\nprint(session.age);         // Session age in seconds\nprint(session.idleTime);    // Idle time in seconds\nprint(session.isDestroyed); // Destroyed state\n"})}),"\n",(0,r.jsx)(n.h3,{id:"store-configuration",children:"Store Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final config = SessionConfig(\n  cookieName: 'app_session',\n  store: CustomStore(),\n  maxAge: Duration(hours: 1),\n  path: '/',\n  secure: true,\n  httpOnly: true\n);\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>a});var i=s(6540);const r={},o=i.createContext(r);function t(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);