"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[7207],{7056:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"fundamentals/providers","title":"Building Providers","description":"Create custom Routed service providers, wire configuration defaults, and plug them into the CLI + manifest tooling.","source":"@site/docs/routed/fundamentals/providers.mdx","sourceDirName":"fundamentals","slug":"/fundamentals/providers","permalink":"/docs/routed/fundamentals/providers","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/fundamentals/providers.mdx","tags":[],"version":"current","frontMatter":{"title":"Building Providers","description":"Create custom Routed service providers, wire configuration defaults, and plug them into the CLI + manifest tooling."},"sidebar":"routedSidebar","previous":{"title":"Routed CLI Reference","permalink":"/docs/routed/fundamentals/cli"},"next":{"title":"State & Persistence","permalink":"/docs/routed/state/"}}');var t=i(4848),s=i(8453);const o={title:"Building Providers",description:"Create custom Routed service providers, wire configuration defaults, and plug them into the CLI + manifest tooling."},d=void 0,a={},c=[{value:"Provider lifecycle",id:"provider-lifecycle",level:2},{value:"Ordering and pre-registration hooks",id:"ordering-and-pre-registration-hooks",level:3},{value:"Shipping configuration defaults",id:"shipping-configuration-defaults",level:2},{value:"Documenting dynamic defaults",id:"documenting-dynamic-defaults",level:3},{value:"CLI integration",id:"cli-integration",level:3},{value:"Provider manifests",id:"provider-manifests",level:2},{value:"Testing providers",id:"testing-providers",level:2},{value:"Cheatsheet",id:"cheatsheet",level:2}];function l(e){const n={blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Routed\u2019s core features (logging, cache, storage, uploads, etc.) are all implemented as ",(0,t.jsx)(n.em,{children:"providers"}),". A provider boots dependencies into the container, exposes configuration defaults, and participates in reloads + shutdown. You can author your own providers to encapsulate services or framework extensions."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["TL;DR: Implement ",(0,t.jsx)(n.code,{children:"ServiceProvider"}),", register it with ",(0,t.jsx)(n.code,{children:"Engine.registerProvider"}),", and (optionally) mix in ",(0,t.jsx)(n.code,{children:"ProvidesDefaultConfig"})," so the CLI and manifests can surface your documentation."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"provider-lifecycle",children:"Provider lifecycle"}),"\n",(0,t.jsxs)(n.p,{children:["Every provider extends the ",(0,t.jsx)(n.code,{children:"ServiceProvider"})," base class:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",metastring:'title="lib/services/email_service_provider.dart"',children:"import 'package:routed/src/container/container.dart';\nimport 'package:routed/src/provider/provider.dart';\n\nclass EmailServiceProvider extends ServiceProvider {\n  @override\n  void register(Container container) {\n    container.singleton<Mailer>((c) async {\n      final config = await c.make<Config>();\n      final settings = config.get('mail') as Map<String, dynamic>;\n      return Mailer.fromConfig(settings);\n    });\n  }\n\n  @override\n  Future<void> boot(Container container) async {\n    final mailer = await container.make<Mailer>();\n    await mailer.verifyConnection();\n  }\n\n  @override\n  Future<void> cleanup(Container container) async {\n    if (container.has<Mailer>()) {\n      final mailer = await container.make<Mailer>();\n      await mailer.close();\n    }\n  }\n}\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"register"})," is synchronous and should only declare bindings (no I/O)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"boot"})," runs after all providers register, so you can resolve other bindings safely."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cleanup"})," runs when the engine shuts down (or a request-scoped container is disposed)."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Register providers via the constructor or before ",(0,t.jsx)(n.code,{children:"engine.initialize()"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"// Option 1: Pass providers to the constructor (recommended)\nfinal engine = Engine(\n  providers: [\n    ...Engine.builtins,\n    EmailServiceProvider(),\n  ],\n);\nawait engine.initialize();\n\n// Option 2: Register after construction\nfinal engine = Engine(providers: Engine.builtins);\nengine.registerProvider(EmailServiceProvider());\nawait engine.initialize();\n\n// Option 3: Use Engine.create() for convenience\nfinal engine = await Engine.create(\n  providers: [\n    ...Engine.builtins,\n    EmailServiceProvider(),\n  ],\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"ordering-and-pre-registration-hooks",children:"Ordering and pre-registration hooks"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Providers run ",(0,t.jsx)(n.code,{children:"register"})," immediately when ",(0,t.jsx)(n.code,{children:"Engine.registerProvider"})," is called.\nIf one provider depends on bindings from another, register them in that order\n(",(0,t.jsx)(n.code,{children:"engine.registerProvider(CacheProvider())"})," before\n",(0,t.jsx)(n.code,{children:"engine.registerProvider(EmailProvider())"}),", etc.)."]}),"\n",(0,t.jsxs)(n.li,{children:["Built-in providers are registered when you pass them to the ",(0,t.jsx)(n.code,{children:"providers"})," parameter.\nTo seed registries or add container services ",(0,t.jsx)(n.em,{children:"before"})," those providers finish\nwiring defaults, pass an ",(0,t.jsx)(n.code,{children:"Engine"})," option:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"final engine = Engine(\n  providers: [\n    ...Engine.builtins,\n  ],\n  options: [\n    (engine) {\n      final registry = engine.container.get<LocaleResolverRegistry>();\n      registry.register('preview', (_) => PreviewLocaleResolver());\n    },\n  ],\n);\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Engine options execute right after the engine is created but before\n",(0,t.jsx)(n.code,{children:"engine.initialize()"})," (and before provider boot hooks fire). Use them when you\nneed to ensure something exists in the container\u2014custom locale resolvers,\ndriver registrations, feature flags\u2014before providers rely on that state."]}),"\n",(0,t.jsx)(n.h2,{id:"shipping-configuration-defaults",children:"Shipping configuration defaults"}),"\n",(0,t.jsxs)(n.p,{children:["Mix in ",(0,t.jsx)(n.code,{children:"ProvidesDefaultConfig"})," to contribute config defaults + documentation. Use ",(0,t.jsx)(n.code,{children:"ConfigDefaults"})," and ",(0,t.jsx)(n.code,{children:"ConfigDocEntry"})," so the CLI (",(0,t.jsx)(n.code,{children:"provider:list --config"}),") and generator (",(0,t.jsx)(n.code,{children:"config:init"}),") can surface the metadata."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",metastring:'title="EmailServiceProvider with defaults"',children:"class EmailServiceProvider extends ServiceProvider with ProvidesDefaultConfig {\n  @override\n  ConfigDefaults get defaultConfig => const ConfigDefaults(\n        docs: [\n          ConfigDocEntry(\n            path: 'mail.default',\n            type: 'string',\n            description: 'Transport used when none is specified.',\n            defaultValue: 'smtp',\n            metadata: {configDocMetaInheritFromEnv: 'MAIL_MAILER'},\n          ),\n          ConfigDocEntry(\n            path: 'mail.mailers.smtp.host',\n            type: 'string',\n            description: 'SMTP server hostname.',\n            defaultValue: \"{{ env.MAIL_HOST | default: 'smtp.example.com' }}\",\n          ),\n          // \u2026\n        ],\n      );\n\n  @override\n  void register(Container container) {\n    // bindings\n  }\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Providers that implement ",(0,t.jsx)(n.code,{children:"ProvidesDefaultConfig"})," must also implement ",(0,t.jsx)(n.code,{children:"onConfigReload"})," if they cache configuration, because the engine calls it whenever ",(0,t.jsx)(n.code,{children:".env"})," or ",(0,t.jsx)(n.code,{children:"config/*.yaml"})," changes in watch mode."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"  @override\n  Future<void> onConfigReload(Container container, Config config) async {\n    if (container.has<Mailer>()) {\n      final mailer = await container.make<Mailer>();\n      mailer.updateSettings(config.get('mail'));\n    }\n  }\n"})}),"\n",(0,t.jsx)(n.h3,{id:"documenting-dynamic-defaults",children:"Documenting dynamic defaults"}),"\n",(0,t.jsxs)(n.p,{children:["If defaults depend on runtime state (e.g., registered drivers), use ",(0,t.jsx)(n.code,{children:"defaultValueBuilder"})," and ",(0,t.jsx)(n.code,{children:"optionsBuilder"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",children:"ConfigDocEntry(\n  path: 'mail.mailers.*.driver',\n  type: 'string',\n  description: 'Registered mail driver.',\n  optionsBuilder: MailDriverRegistry.instance.names,\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"cli-integration",children:"CLI integration"}),"\n",(0,t.jsx)(n.p,{children:"Once the provider ships defaults, the CLI automatically displays them:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"dart run routed provider:list --config | grep mail\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"config:init"})," also inlines the doc comments above each ",(0,t.jsx)(n.code,{children:"config/*.yaml"})," entry, so ",(0,t.jsx)(n.code,{children:"ConfigDocEntry.description"})," + ",(0,t.jsx)(n.code,{children:"metadata"})," show up in generated files."]}),"\n",(0,t.jsx)(n.h2,{id:"provider-manifests",children:"Provider manifests"}),"\n",(0,t.jsxs)(n.p,{children:["When you toggle providers in ",(0,t.jsx)(n.code,{children:"config/http.yaml"})," (for example via ",(0,t.jsx)(n.code,{children:"providers: [routed.logging, my.custom.email]"}),"), Routed resolves those IDs through ",(0,t.jsx)(n.code,{children:"ProviderRegistry"}),". To make your provider manifest-friendly, export a factory from a package and register it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",metastring:'title="lib/providers.dart"',children:"import 'package:routed/src/provider/registry.dart';\n\nvoid registerProviders() {\n  ProviderRegistry.instance.register(\n    id: 'custom.mail',\n    description: 'Application mailer',\n    factory: () => EmailServiceProvider(),\n  );\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Call ",(0,t.jsx)(n.code,{children:"registerProviders()"})," near ",(0,t.jsx)(n.code,{children:"main()"})," before the engine boots. The CLI and ",(0,t.jsx)(n.code,{children:"provider:list"})," will now show ",(0,t.jsx)(n.code,{children:"custom.mail"})," alongside the built-ins, and manifests can reference it by ID."]}),"\n",(0,t.jsx)(n.h2,{id:"testing-providers",children:"Testing providers"}),"\n",(0,t.jsxs)(n.p,{children:["Because providers are plain Dart classes, you can spin up an ",(0,t.jsx)(n.code,{children:"Engine"})," (or just a ",(0,t.jsx)(n.code,{children:"Container"}),") inside tests:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dart",metastring:'title="test/providers/email_provider_test.dart"',children:"test('Email provider registers Mailer binding', () async {\n  final engine = Engine(\n    providers: [\n      CoreServiceProvider(configItems: {\n        'mail': {'default': 'log'},\n      }),\n      RoutingServiceProvider(),\n      EmailServiceProvider(),\n    ],\n  );\n  await engine.initialize();\n\n  final mailer = await engine.make<Mailer>();\n  expect(mailer, isA<Mailer>());\n\n  await engine.close();\n});\n"})}),"\n",(0,t.jsxs)(n.p,{children:["If the provider exposes CLI docs, add an assertion against ",(0,t.jsx)(n.code,{children:"provider.defaultConfig.docs"})," to keep paths/descriptions accurate."]}),"\n",(0,t.jsx)(n.h2,{id:"cheatsheet",children:"Cheatsheet"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Need"}),(0,t.jsx)(n.th,{children:"API"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Register bindings"}),(0,t.jsxs)(n.td,{children:["Override ",(0,t.jsx)(n.code,{children:"register"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Perform async setup"}),(0,t.jsxs)(n.td,{children:["Override ",(0,t.jsx)(n.code,{children:"boot"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Release resources"}),(0,t.jsxs)(n.td,{children:["Override ",(0,t.jsx)(n.code,{children:"cleanup"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"React to config reloads"}),(0,t.jsxs)(n.td,{children:["Implement ",(0,t.jsx)(n.code,{children:"onConfigReload"})," (only when using ",(0,t.jsx)(n.code,{children:"ProvidesDefaultConfig"}),")"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Contribute defaults/docs"}),(0,t.jsxs)(n.td,{children:["Return ",(0,t.jsx)(n.code,{children:"ConfigDefaults"})," with ",(0,t.jsx)(n.code,{children:"ConfigDocEntry"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Offer CLI/manifest ID"}),(0,t.jsxs)(n.td,{children:["Register with ",(0,t.jsx)(n.code,{children:"ProviderRegistry"})]})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"With these building blocks you can package reusable integrations (queues, telemetry, payment gateways) that feel identical to the providers shipped by Routed.***"})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>d});var r=i(6540);const t={},s=r.createContext(t);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);