"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[2281],{4198:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"examples/shelf-router-chaos-testing","title":"Shelf Router Chaos Testing","description":"This walkthrough shows how to combine property_testing, server_testing, and server_testing_shelf to harden a Shelf API built with shelf_router. We exercise the router with randomly generated requests and ensure the service never crashes, even when hit with adversarial payloads.","source":"@site/docs/property-testing/examples/shelf-router-chaos-testing.mdx","sourceDirName":"examples","slug":"/examples/shelf-router-chaos-testing","permalink":"/docs/property_testing/examples/shelf-router-chaos-testing","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/property-testing/examples/shelf-router-chaos-testing.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Shelf Router Chaos Testing","sidebar_position":4},"sidebar":"propertyTestingSidebar","previous":{"title":"Stateful Counter Invariant","permalink":"/docs/property_testing/examples/stateful-counter-invariant"}}');var r=s(4848),i=s(8453);const a={title:"Shelf Router Chaos Testing",sidebar_position:4},o=void 0,l={},d=[{value:"Dependencies",id:"dependencies",level:2},{value:"Define the Shelf router",id:"define-the-shelf-router",level:2},{value:"Wrap the router for testing",id:"wrap-the-router-for-testing",level:2},{value:"Property tests in action",id:"property-tests-in-action",level:2},{value:"Key takeaways",id:"key-takeaways",level:3}];function c(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["This walkthrough shows how to combine ",(0,r.jsx)(n.strong,{children:"property_testing"}),", ",(0,r.jsx)(n.strong,{children:"server_testing"}),", and ",(0,r.jsx)(n.strong,{children:"server_testing_shelf"})," to harden a Shelf API built with ",(0,r.jsx)(n.code,{children:"shelf_router"}),". We exercise the router with randomly generated requests and ensure the service never crashes, even when hit with adversarial payloads."]}),"\n",(0,r.jsx)(n.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,r.jsxs)(n.p,{children:["Add the relevant packages to your ",(0,r.jsx)(n.code,{children:"dev_dependencies"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"dev_dependencies:\n  property_testing: ^0.3.0\n  server_testing: ^0.3.0\n  server_testing_shelf: ^0.2.1\n  shelf: ^1.4.0\n  shelf_router: ^1.1.0\n  test: ^1.25.0\n"})}),"\n",(0,r.jsx)(n.h2,{id:"define-the-shelf-router",children:"Define the Shelf router"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'dart:convert';\n\nimport 'package:shelf/shelf.dart' as shelf;\nimport 'package:shelf_router/shelf_router.dart';\n\nRouter buildRouter() {\n  final router = Router();\n\n  router\n    ..get('/users/<id>', (shelf.Request request, String id) {\n      final parsed = int.tryParse(id);\n      if (parsed == null || parsed <= 0) {\n        return shelf.Response.notFound(jsonEncode({\n          'error': 'User id must be a positive integer',\n        }), headers: {'content-type': 'application/json'});\n      }\n\n      return shelf.Response.ok(\n        jsonEncode({\n          'id': parsed,\n          'name': parsed == 1 ? 'Alice' : 'Guest $parsed',\n          'role': parsed == 1 ? 'admin' : 'user',\n        }),\n        headers: {'content-type': 'application/json'},\n      );\n    })\n    ..post('/login', (shelf.Request request) async {\n      final body = jsonDecode(await request.readAsString())\n          as Map<String, dynamic>;\n\n      final username = (body['username'] ?? '').toString();\n      final password = (body['password'] ?? '').toString();\n\n      if (username == 'admin' && password == 'password123') {\n        return shelf.Response.ok(\n          jsonEncode({'token': 'mock-jwt-token', 'success': true}),\n          headers: {'content-type': 'application/json'},\n        );\n      }\n\n      return shelf.Response(\n        401,\n        body: jsonEncode({'error': 'Invalid credentials', 'success': false}),\n        headers: {'content-type': 'application/json'},\n      );\n    })\n    ..get('/search', (shelf.Request request) {\n      final query = request.requestedUri.queryParameters['q'] ?? '';\n      return shelf.Response.ok(\n        jsonEncode({'query': query, 'results': []}),\n        headers: {'content-type': 'application/json'},\n      );\n    });\n\n  return router;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"wrap-the-router-for-testing",children:"Wrap the router for testing"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"server_testing_shelf"})," adapts the Shelf router into a ",(0,r.jsx)(n.code,{children:"RequestHandler"})," that server_testing and property_testing can drive in-memory:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'package:server_testing/server_testing.dart';\nimport 'package:server_testing_shelf/server_testing_shelf.dart';\n\nlate TestClient client;\n\nsetUp(() {\n  final router = buildRouter();\n  final handler = ShelfRequestHandler(router.call);\n  client = TestClient.inMemory(handler);\n});\n\ntearDown(() => client.close());\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"TestClient"})," gives the familiar fluent assertion API (",(0,r.jsx)(n.code,{children:"assertStatus"}),", ",(0,r.jsx)(n.code,{children:"assertJson"}),", ",(0,r.jsx)(n.code,{children:"postJson"}),", etc.) but never spawns a real HTTP server."]}),"\n",(0,r.jsx)(n.h2,{id:"property-tests-in-action",children:"Property tests in action"}),"\n",(0,r.jsxs)(n.p,{children:["Below is a complete test file that mixes generators from ",(0,r.jsx)(n.code,{children:"property_testing"})," with the in-memory client. Each property run reuses the same client instance, so requests remain cheap while still covering hundreds of cases."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'package:property_testing/property_testing.dart';\nimport 'package:server_testing/server_testing.dart';\nimport 'package:server_testing_shelf/server_testing_shelf.dart';\nimport 'package:test/test.dart';\n\n// Assumes buildRouter() from the earlier snippet is available in scope.\nvoid main() {\n  late TestClient client;\n\n  setUp(() {\n    final router = buildRouter();\n    client = TestClient.inMemory(ShelfRequestHandler(router.call));\n  });\n\n  tearDown(() => client.close());\n\n  test('GET /users/<id> tolerates chaotic ids', () async {\n    final runner = PropertyTestRunner(\n      Chaos.string(maxLength: 32),\n      (id) async {\n        final response = await client.get('/users/$id');\n        // Invariant: The API should never crash with a 5xx.\n        expect(response.statusCode, lessThan(500), reason: 'id=$id');\n\n        // Valid ids respond with JSON; invalid ones provide a JSON error.\n        if (int.tryParse(id) != null && int.parse(id) > 0) {\n          response\n              .assertStatus(200)\n              .assertJson((json) => json.where('id', int.parse(id)));\n        } else {\n          expect(response.statusCode, anyOf(400, 404));\n          response.assertJson((json) => json.has('error'));\n        }\n      },\n      PropertyConfig(numTests: 300, seed: 1337),\n    );\n\n    final result = await runner.run();\n    expect(result.success, isTrue, reason: result.report);\n  });\n\n  test('POST /login handles random credentials', () async {\n    final credentialsGen = Gen.string(minLength: 3, maxLength: 24)\n        .flatMap((username) => Gen.string(minLength: 6, maxLength: 32).map(\n              (password) => {\n                'username': username,\n                'password': password,\n              },\n            ));\n\n    final runner = PropertyTestRunner(\n      credentialsGen,\n      (credentials) async {\n        final response = await client.postJson('/login', credentials);\n        // The handler should respond with either 200 (valid) or 401 (invalid).\n        expect(response.statusCode, anyOf(200, 401));\n\n        response.assertJson((json) {\n          json.has('success');\n          if (response.statusCode == 200) {\n            json.has('token');\n          }\n        });\n      },\n      PropertyConfig(numTests: 200),\n    );\n\n    final result = await runner.run();\n    expect(result.success, isTrue, reason: result.report);\n  });\n\n  test('GET /search sanitises chaotic queries', () async {\n    final runner = PropertyTestRunner(\n      Chaos.string(maxLength: 120),\n      (query) async {\n        final response = await client.get('/search?q=$query');\n        response\n            .assertStatus(200)\n            .assertJson((json) => json.where('query', query));\n      },\n      PropertyConfig(numTests: 250),\n    );\n\n    final result = await runner.run();\n    expect(result.success, isTrue, reason: result.report);\n  });\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"key-takeaways",children:"Key takeaways"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ShelfRequestHandler"})," keeps property tests fast by avoiding real sockets."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Chaos"})," generators drive the router with edge-case strings so unexpected code paths surface quickly."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PropertyTestRunner"})," gives shrinking for free\u2014if an assertion fails, the report highlights the minimal counterexample and the seed to reproduce it."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"From here you can add stateful properties (e.g. sequences of admin/user actions) or extend the generator library with domain-specific shapes while still reusing the same testing harness."})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var t=s(6540);const r={},i=t.createContext(r);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);