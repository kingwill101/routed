"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[3072],{364:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"stateful-testing","title":"Stateful Testing","description":"Property-based testing shines when you verify behaviours across sequences of operations. The stateful module models your system under test (SUT) with Command objects and compares it against an expected Model.","source":"@site/docs/property-testing/stateful-testing.mdx","sourceDirName":".","slug":"/stateful-testing","permalink":"/docs/property_testing/stateful-testing","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/property-testing/stateful-testing.mdx","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Stateful Testing","sidebar_position":6},"sidebar":"propertyTestingSidebar","previous":{"title":"Chaos & Adversarial Inputs","permalink":"/docs/property_testing/chaos-testing"},"next":{"title":"Running & Reporting","permalink":"/docs/property_testing/runner-and-reporting"}}');var o=t(4848),r=t(8453);const i={title:"Stateful Testing",sidebar_position:6},a=void 0,d={},c=[{value:"Command basics",id:"command-basics",level:2},{value:"StatefulPropertyBuilder",id:"statefulpropertybuilder",level:2},{value:"Invariant-only runners",id:"invariant-only-runners",level:2},{value:"Filtering commands with preconditions",id:"filtering-commands-with-preconditions",level:2},{value:"Configuration knobs",id:"configuration-knobs",level:2}];function l(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["Property-based testing shines when you verify behaviours across sequences of operations. The stateful module models your system under test (SUT) with ",(0,o.jsx)(n.code,{children:"Command"})," objects and compares it against an expected ",(0,o.jsx)(n.code,{children:"Model"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"command-basics",children:"Command basics"}),"\n",(0,o.jsx)(n.p,{children:"Create a command per operation you want to exercise. Each command can:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["check a ",(0,o.jsx)(n.code,{children:"precondition(model)"})," before it runs,"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"run(sut)"})," (sync or async),"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"update(model)"})," to reflect the expected state, and"]}),"\n",(0,o.jsxs)(n.li,{children:["assert ",(0,o.jsx)(n.code,{children:"postcondition(model, sut)"})," afterwards."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"class Deposit extends Command<AccountBalance, BankAccount> {\n  final int amount;\n  Deposit(this.amount);\n\n  @override\n  bool precondition(AccountBalance balance) => amount > 0;\n\n  @override\n  Future<void> run(BankAccount sut) => sut.deposit(amount);\n\n  @override\n  AccountBalance update(AccountBalance model) =>\n      model.copyWith(cents: model.cents + amount);\n\n  @override\n  Future<void> postcondition(AccountBalance model, BankAccount sut) async {\n    expect(await sut.balance(), equals(model.cents));\n  }\n\n  @override\n  String toString() => 'Deposit($amount)';\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"CommandSequence"})," simply wraps a list of commands and executes the precondition \u2192 run \u2192 update \u2192 postcondition cycle for each step."]}),"\n",(0,o.jsx)(n.h2,{id:"statefulpropertybuilder",children:"StatefulPropertyBuilder"}),"\n",(0,o.jsx)(n.p,{children:"Use the builder when you need to set up a fresh SUT per test case and combine multiple command generators."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"final builder = StatefulPropertyBuilder<AccountBalance, BankAccount>.create(\n  initialModel: () => AccountBalance.zero(),\n  setupSut: () async => BankAccount.withInMemoryStore(),\n  teardownSut: (account) async => account.dispose(),\n)\n    .withCommands(\n      Gen.integer(min: 1, max: 10).map((dollars) => Deposit(dollars * 100)),\n    )\n    .withCommands(\n      Gen.integer(min: 1, max: 10).map((dollars) => Withdraw(dollars * 100)),\n    ) // Withdraw is another Command that mirrors Deposit with overdraft checks\n    .withConfig(StatefulPropertyConfig(\n      numTests: 200,\n      maxCommandSequenceLength: 25,\n    ));\n\nfinal result = await builder.run();\nexpect(result.success, isTrue, reason: result.report);\n"})}),"\n",(0,o.jsx)(n.p,{children:"Behind the scenes the builder:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Picks a random sequence length up to ",(0,o.jsx)(n.code,{children:"maxCommandSequenceLength"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Chooses commands from your registered generators (using ",(0,o.jsx)(n.code,{children:"Gen.oneOfGen"}),")."]}),"\n",(0,o.jsx)(n.li,{children:"Runs the sequence against a fresh SUT and model."}),"\n",(0,o.jsx)(n.li,{children:"Shrinks by trimming the command list and shrinking the commands themselves."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"invariant-only-runners",children:"Invariant-only runners"}),"\n",(0,o.jsxs)(n.p,{children:["Some scenarios only need to check that a model invariant holds after applying commands. ",(0,o.jsx)(n.code,{children:"StatefulPropertyRunner"})," provides a lighter interface:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"final counterRunner = StatefulPropertyRunner<int, int>(\n  Gen.oneOf([1, -1]),\n  () => 0,\n  (value) => value >= 0, // invariant: counter never goes negative\n  (state, command) => state + command,\n  StatefulPropertyConfig(\n    numTests: 300,\n    maxCommandSequenceLength: 20,\n  ),\n);\n\nfinal result = await counterRunner.run();\nexpect(result.success, isTrue, reason: result.report);\n"})}),"\n",(0,o.jsx)(n.p,{children:"This variant focuses on shrinking command lists and validating the invariant after every update. It is handy for pure model simulations or lower-level data structures."}),"\n",(0,o.jsx)(n.h2,{id:"filtering-commands-with-preconditions",children:"Filtering commands with preconditions"}),"\n",(0,o.jsxs)(n.p,{children:["Use the ",(0,o.jsx)(n.code,{children:"StatefulPropertyTestingExtensions.whereValid"})," helper when you want to discard commands that do not meet a predicate evaluated against a model snapshot (often your initial model)."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dart",children:"final withdrawGen = Gen.integer(min: 1, max: 10)\n    .map((dollars) => Withdraw(dollars * 100))\n    .whereValid(\n      () => AccountBalance.zero(),\n      (command, model) => command.amount <= model.cents,\n    );\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Because the extension builds on the standard ",(0,o.jsx)(n.code,{children:"where"})," combinator, shrinking only keeps values that continue to satisfy the predicate."]}),"\n",(0,o.jsx)(n.h2,{id:"configuration-knobs",children:"Configuration knobs"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"StatefulPropertyConfig"})," extends ",(0,o.jsx)(n.code,{children:"PropertyConfig"})," and adds:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"maxCommandSequenceLength"})," \u2013 upper bound on randomly generated sequence length (default: 100)."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["All other knobs (",(0,o.jsx)(n.code,{children:"numTests"}),", ",(0,o.jsx)(n.code,{children:"maxShrinks"}),", ",(0,o.jsx)(n.code,{children:"timeout"}),", ",(0,o.jsx)(n.code,{children:"random"}),") behave exactly like they do for stateless properties."]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var s=t(6540);const o={},r=s.createContext(o);function i(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);