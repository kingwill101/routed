"use strict";(globalThis.webpackChunkrouted=globalThis.webpackChunkrouted||[]).push([[7487],{8453:(e,r,t)=>{t.d(r,{R:()=>o,x:()=>a});var n=t(6540);const s={},i=n.createContext(s);function o(e){const r=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),n.createElement(i.Provider,{value:r},e.children)}},8698:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"fundamentals/observability","title":"Observability","description":"Enable tracing, metrics, health endpoints, and error observers","source":"@site/docs/routed/fundamentals/observability.mdx","sourceDirName":"fundamentals","slug":"/fundamentals/observability","permalink":"/docs/routed/fundamentals/observability","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/routed/tree/main/docs/docs/routed/fundamentals/observability.mdx","tags":[],"version":"current","sidebarPosition":12,"frontMatter":{"title":"Observability","description":"Enable tracing, metrics, health endpoints, and error observers","sidebar_position":12},"sidebar":"routedSidebar","previous":{"title":"Contracts","permalink":"/docs/routed/fundamentals/contracts"},"next":{"title":"Routed CLI Reference","permalink":"/docs/routed/fundamentals/cli"}}');var s=t(4848),i=t(8453);const o={title:"Observability",description:"Enable tracing, metrics, health endpoints, and error observers",sidebar_position:12},a="Observability",l={},d=[{value:"OpenTelemetry tracing",id:"opentelemetry-tracing",level:2},{value:"Prometheus metrics",id:"prometheus-metrics",level:2},{value:"Sample dashboards",id:"sample-dashboards",level:3},{value:"Health and readiness endpoints",id:"health-and-readiness-endpoints",level:2},{value:"Error observers",id:"error-observers",level:2},{value:"Sentry integration",id:"sentry-integration",level:2},{value:"Logging defaults",id:"logging-defaults",level:2},{value:"Putting it together",id:"putting-it-together",level:2}];function c(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"observability",children:"Observability"})}),"\n",(0,s.jsx)(r.p,{children:"Routed ships with an observability service provider that wires together tracing, metrics, health endpoints, and error observers. The provider is enabled by default and exposes configuration switches so you can opt into the pieces you need without touching application code."}),"\n",(0,s.jsxs)(r.p,{children:["The defaults live under the ",(0,s.jsx)(r.code,{children:"observability"})," section of your configuration:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",metastring:'title="config/app.yaml"',children:"observability:\n  enabled: true\n  tracing:\n    enabled: false\n    exporter: none          # none, console, or otlp\n    service_name: routed-service\n    endpoint: null          # OTLP collector URI when exporter=otlp\n    headers: {}             # Optional OTLP headers (for auth tokens, etc.)\n  metrics:\n    enabled: false\n    path: /metrics\n    buckets: [0.01, 0.05, 0.1, 0.25, 0.5, 1.0, 2.0, 5.0]\n  health:\n    enabled: true\n    readiness_path: /readyz\n    liveness_path: /livez\n  errors:\n    enabled: false          # Reserve for future error reporter hooks\n  sentry:\n    enabled: false\n    dsn: null               # Sentry DSN\n    send_default_pii: false\n    traces_sample_rate: 0.0\n"})}),"\n",(0,s.jsxs)(r.p,{children:["When the provider boots it automatically registers tracing and metrics middleware, attaches Prometheus-style routes, and exposes a health service you can extend at runtime. Toggle the granular ",(0,s.jsx)(r.code,{children:"observability.*.enabled"})," flags (for example ",(0,s.jsx)(r.code,{children:"observability.tracing.enabled: true"}),") to switch individual features on or off."]}),"\n",(0,s.jsx)(r.h2,{id:"opentelemetry-tracing",children:"OpenTelemetry tracing"}),"\n",(0,s.jsxs)(r.p,{children:["Set ",(0,s.jsx)(r.code,{children:"observability.tracing.enabled: true"})," to instrument request spans with the ",(0,s.jsx)(r.a,{href:"https://opentelemetry.io/",children:"OpenTelemetry"})," SDK. Routed extracts incoming W3C Trace Context headers and creates server spans named after HTTP method and route label. Each span includes attributes for method, route, target, and status code, and records exceptions automatically."]}),"\n",(0,s.jsx)(r.p,{children:"Supported exporters:"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"none"})," (default): disables span export while keeping request handling cheap."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"console"}),": prints spans to stdout, useful for local debugging."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"otlp"}),": sends spans to an OTLP collector. Provide ",(0,s.jsx)(r.code,{children:"observability.tracing.endpoint"})," (for example, ",(0,s.jsx)(r.code,{children:"http://collector:4318/v1/traces"}),") and optional ",(0,s.jsx)(r.code,{children:"headers"})," for authentication."]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",metastring:'title="config/app.yaml"',children:"observability:\n  tracing:\n    enabled: true\n    exporter: otlp\n    service_name: checkout-api\n    endpoint: https://otel.example.com/v1/traces\n    headers:\n      authorization: Bearer ${OTEL_TOKEN}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["Routed injects the tracing middleware ahead of other middleware so handlers and downstream middleware all see the active span. If you need to customise ordering, override ",(0,s.jsx)(r.code,{children:"http.middleware_sources.routed.observability.global"})," and reorder the generated IDs (",(0,s.jsx)(r.code,{children:"routed.observability.tracing"}),", ",(0,s.jsx)(r.code,{children:"routed.observability.metrics"}),", ",(0,s.jsx)(r.code,{children:"routed.observability.health"}),")."]}),"\n",(0,s.jsx)(r.h2,{id:"prometheus-metrics",children:"Prometheus metrics"}),"\n",(0,s.jsxs)(r.p,{children:["Enable ",(0,s.jsx)(r.code,{children:"observability.metrics.enabled"})," to expose an HTTP ",(0,s.jsx)(r.code,{children:"/metrics"})," endpoint that emits Prometheus exposition format. Metrics collected out of the box:"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"routed_requests_total{method,route,status}"})," \u2013 counter of completed requests."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"routed_request_duration_seconds_bucket|sum|count{method,route,status}"})," \u2013 histogram timing data using the configured buckets."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"routed_active_requests"})," \u2013 gauge of in-flight requests."]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",metastring:'title="config/app.yaml"',children:"observability:\n  metrics:\n    enabled: true\n    path: /metrics   # customise the exposure path\n    buckets: [0.05, 0.1, 0.25, 0.5, 1, 2]  # seconds\n"})}),"\n",(0,s.jsxs)(r.p,{children:["The metrics middleware runs before handlers, recording timings even when a request throws. You can register additional metrics by pulling the ",(0,s.jsx)(r.code,{children:"MetricsService"})," out of the container during boot."]}),"\n",(0,s.jsx)(r.h3,{id:"sample-dashboards",children:"Sample dashboards"}),"\n",(0,s.jsx)(r.p,{children:"Start with these PromQL snippets when wiring Grafana:"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Request throughput:"})," ",(0,s.jsx)(r.code,{children:"sum(rate(routed_requests_total[5m])) by (route)"})]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Latency percentiles:"})," ",(0,s.jsx)(r.code,{children:"histogram_quantile(0.95, sum(rate(routed_request_duration_seconds_bucket[5m])) by (le, route))"})]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Error rate:"})," ",(0,s.jsx)(r.code,{children:'sum(rate(routed_requests_total{status=~"5.."}[5m])) / sum(rate(routed_requests_total[5m]))'})]}),"\n"]}),"\n",(0,s.jsxs)(r.p,{children:["Adjust the range window (",(0,s.jsx)(r.code,{children:"[5m]"}),") to match your traffic profile."]}),"\n",(0,s.jsx)(r.h2,{id:"health-and-readiness-endpoints",children:"Health and readiness endpoints"}),"\n",(0,s.jsx)(r.p,{children:"The health service exposes two JSON endpoints:"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"GET /readyz"})," (readiness) \u2013 returns ",(0,s.jsx)(r.code,{children:"503"})," until registered checks report healthy."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"GET /livez"})," (liveness) \u2013 returns ",(0,s.jsx)(r.code,{children:"200"})," by default unless you register failing checks."]}),"\n"]}),"\n",(0,s.jsxs)(r.p,{children:["Register extra checks at runtime via ",(0,s.jsx)(r.code,{children:"HealthService"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-dart",children:"final health = engine.container.make<HealthService>();\nhealth.registerReadinessCheck('database', () async {\n  final ok = await db.isHealthy();\n  return ok\n      ? HealthCheckResult.ok({'pong': true})\n      : HealthCheckResult.failure({'error': 'timeout'});\n});\n"})}),"\n",(0,s.jsxs)(r.p,{children:["Each check name becomes a key inside the JSON payload, and failures automatically flip the response status to ",(0,s.jsx)(r.code,{children:"503 Service Unavailable"}),". Adjust paths with ",(0,s.jsx)(r.code,{children:"observability.health.readiness_path"})," and ",(0,s.jsx)(r.code,{children:"observability.health.liveness_path"})," when you need to comply with platform probes."]}),"\n",(0,s.jsx)(r.h2,{id:"error-observers",children:"Error observers"}),"\n",(0,s.jsxs)(r.p,{children:["The provider exposes an ",(0,s.jsx)(r.code,{children:"ErrorObserverRegistry"})," you can use to forward unhandled request errors to external systems (error trackers, paging tools, etc.). Observers receive the ",(0,s.jsx)(r.code,{children:"EngineContext"}),", error, and stack trace so they can enrich reports with request metadata."]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-dart",children:"class SentryObserver implements ErrorObserver {\n  @override\n  Future<void> onError(\n    EngineContext context,\n    Object error,\n    StackTrace stackTrace,\n  ) async {\n    await sentry.captureException(\n      error,\n      stackTrace: stackTrace,\n      withScope: (scope) {\n        scope.setContext('request', context.loggerContext);\n      },\n    );\n  }\n}\n\nengine.container.make<ErrorObserverRegistry>().addObserver(SentryObserver());\n"})}),"\n",(0,s.jsx)(r.p,{children:"Observer failures are swallowed so they never break the request pipeline\u2014log them internally if you need to monitor integration health."}),"\n",(0,s.jsx)(r.h2,{id:"sentry-integration",children:"Sentry integration"}),"\n",(0,s.jsxs)(r.p,{children:["Enable ",(0,s.jsx)(r.code,{children:"observability.sentry.enabled"})," to initialize the Sentry SDK and forward routing errors automatically. This is wired through the observability provider, so you only need to supply the DSN and (optionally) enable tracing."]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",metastring:'title="config/app.yaml"',children:"observability:\n  sentry:\n    enabled: true\n    dsn: https://examplePublicKey@o0.ingest.sentry.io/0\n    send_default_pii: true\n    traces_sample_rate: 0.2\n"})}),"\n",(0,s.jsxs)(r.p,{children:["When enabled, routed will call ",(0,s.jsx)(r.code,{children:"Sentry.captureException"})," for ",(0,s.jsx)(r.code,{children:"RoutingErrorEvent"})," failures. Use ",(0,s.jsx)(r.code,{children:"traces_sample_rate"})," to enable Sentry performance sampling if you want transaction visibility."]}),"\n",(0,s.jsx)(r.h2,{id:"logging-defaults",children:"Logging defaults"}),"\n",(0,s.jsxs)(r.p,{children:["When ",(0,s.jsx)(r.code,{children:"observability.logging.format"})," is ",(0,s.jsx)(r.code,{children:"json"})," (the default), the provider configures ",(0,s.jsx)(r.code,{children:"RoutedLogger"})," to emit JSON across the application. Switch to ",(0,s.jsx)(r.code,{children:"text"})," for local development or attach your own logger factory for custom sinks."]}),"\n",(0,s.jsx)(r.p,{children:"Combine log formatting with tracing and metrics so each request yields structured telemetry alongside spans and Prometheus counters. All components read from the same configuration scope, making it easy to toggle behaviour per environment (for example, JSON logs with OTLP spans in production, plain text with console spans locally)."}),"\n",(0,s.jsx)(r.h2,{id:"putting-it-together",children:"Putting it together"}),"\n",(0,s.jsx)(r.p,{children:"Most deployments start with:"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:["Enable tracing with either ",(0,s.jsx)(r.code,{children:"console"})," or ",(0,s.jsx)(r.code,{children:"otlp"})," exporter."]}),"\n",(0,s.jsx)(r.li,{children:"Turn on metrics and point your Prometheus scraper at the exposed path."}),"\n",(0,s.jsx)(r.li,{children:"Register readiness checks for backing services (databases, queues, external APIs)."}),"\n",(0,s.jsx)(r.li,{children:"Add an error observer that forwards critical errors to your alerting stack."}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Because the provider reacts to configuration reloads, you can change options (for example, toggling tracing or metrics) without recreating the engine\u2014handy during incident response when you need deeper visibility temporarily."})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);