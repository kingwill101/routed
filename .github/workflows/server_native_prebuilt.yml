name: server_native_prebuilt Native Libraries

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.0). If empty, uploads artifacts only."
        required: false
        type: string
      save_to_repo:
        description: "Commit built prebuilts into packages/server_native/native/prebuilt."
        required: false
        type: boolean
        default: false
      target_branch:
        description: "Branch to commit prebuilts to when save_to_repo=true."
        required: false
        type: string
        default: master
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  RUST_VERSION: "1.92.0"
  PREBUILT_PACKAGE: "server_native"

jobs:
  native:
    name: "${{ matrix.os_label }}"
    runs-on: ${{ matrix.runner }}
    continue-on-error: ${{ matrix.allow_failure }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - runner: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
            binary_name: librouted_ffi_native.so
            os_label: linux-x64
            use_cross: false
            android_abi: ""
            allow_failure: false
          - runner: ubuntu-latest
            rust_target: aarch64-unknown-linux-gnu
            binary_name: librouted_ffi_native.so
            os_label: linux-arm64
            use_cross: true
            android_abi: ""
            allow_failure: false

          # macOS
          - runner: macos-latest
            rust_target: aarch64-apple-darwin
            binary_name: librouted_ffi_native.dylib
            os_label: macos-arm64
            use_cross: false
            android_abi: ""
            allow_failure: false
          - runner: macos-latest
            rust_target: x86_64-apple-darwin
            binary_name: librouted_ffi_native.dylib
            os_label: macos-x64
            use_cross: false
            android_abi: ""
            allow_failure: false

          # Windows
          - runner: windows-latest
            rust_target: x86_64-pc-windows-msvc
            binary_name: routed_ffi_native.dll
            os_label: windows-x64
            use_cross: false
            android_abi: ""
            allow_failure: false
          - runner: windows-latest
            rust_target: aarch64-pc-windows-msvc
            binary_name: routed_ffi_native.dll
            os_label: windows-arm64
            use_cross: false
            android_abi: ""
            allow_failure: true

          # Android (cross-compiled from Linux with NDK)
          - runner: ubuntu-latest
            rust_target: aarch64-linux-android
            binary_name: librouted_ffi_native.so
            os_label: android-arm64
            use_cross: false
            android_abi: arm64-v8a
            allow_failure: false
          - runner: ubuntu-latest
            rust_target: armv7-linux-androideabi
            binary_name: librouted_ffi_native.so
            os_label: android-armv7
            use_cross: false
            android_abi: armeabi-v7a
            allow_failure: false
          - runner: ubuntu-latest
            rust_target: x86_64-linux-android
            binary_name: librouted_ffi_native.so
            os_label: android-x64
            use_cross: false
            android_abi: x86_64
            allow_failure: false

          # iOS static libraries
          - runner: macos-latest
            rust_target: aarch64-apple-ios
            binary_name: librouted_ffi_native.a
            os_label: ios-arm64
            use_cross: false
            android_abi: ""
            allow_failure: false
          - runner: macos-latest
            rust_target: aarch64-apple-ios-sim
            binary_name: librouted_ffi_native.a
            os_label: ios-sim-arm64
            use_cross: false
            android_abi: ""
            allow_failure: false
          - runner: macos-latest
            rust_target: x86_64-apple-ios
            binary_name: librouted_ffi_native.a
            os_label: ios-sim-x64
            use_cross: false
            android_abi: ""
            allow_failure: false

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.rust_target }}

      - name: Install cross
        if: matrix.use_cross
        shell: bash
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Install Android NDK
        if: matrix.android_abi != ''
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r27c

      - name: Install cargo-ndk
        if: matrix.android_abi != ''
        shell: bash
        run: cargo install cargo-ndk

      - name: Build routed_ffi native library
        working-directory: packages/server_native/native
        shell: bash
        run: |
          set -euxo pipefail
          if [ -n "${{ matrix.android_abi }}" ]; then
            cargo ndk -t ${{ matrix.android_abi }} build --release
          elif [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.rust_target }}
          else
            cargo build --release --target ${{ matrix.rust_target }}
          fi
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Locate artifact
        id: locate
        working-directory: packages/server_native/native
        shell: bash
        run: |
          set -euxo pipefail
          base="target/${{ matrix.rust_target }}/release"
          artifact_path="$base/${{ matrix.binary_name }}"
          if [ ! -f "$artifact_path" ]; then
            artifact_path="$(find "$base" -maxdepth 3 -type f -name "${{ matrix.binary_name }}" | head -1 || true)"
          fi
          if [ -z "$artifact_path" ] || [ ! -f "$artifact_path" ]; then
            echo "::error::Could not find ${{ matrix.binary_name }} under $base"
            find "$base" -maxdepth 4 -type f \( -name '*.so' -o -name '*.dylib' -o -name '*.dll' -o -name '*.a' \) || true
            exit 1
          fi
          echo "path=$artifact_path" >> "$GITHUB_OUTPUT"
          ls -lh "$artifact_path"

      - name: Package artifact
        shell: bash
        run: |
          set -euxo pipefail
          target_dir="packages/server_native/native/prebuilt/${{ matrix.os_label }}"
          mkdir -p "$target_dir"
          cp "packages/server_native/native/${{ steps.locate.outputs.path }}" "$target_dir/${{ matrix.binary_name }}"
          ls -lh "$target_dir/${{ matrix.binary_name }}"
          tar czf "${{ env.PREBUILT_PACKAGE }}-${{ matrix.os_label }}.tar.gz" -C "$target_dir" "${{ matrix.binary_name }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PREBUILT_PACKAGE }}-${{ matrix.os_label }}
          path: ${{ env.PREBUILT_PACKAGE }}-${{ matrix.os_label }}.tar.gz

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.tag != ''
    needs: [native]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Determine tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          files: artifacts/**/*.tar.gz

  save-prebuilts:
    name: Save Prebuilts To Repo
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.save_to_repo == 'true'
    needs: [native]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Expand prebuilts into package tree
        shell: bash
        run: |
          set -euxo pipefail
          root="packages/server_native/native/prebuilt"
          mkdir -p "$root"

          shopt -s globstar nullglob
          for tarball in artifacts/**/*.tar.gz; do
            name="$(basename "$tarball")"
            platform="${name#${{ env.PREBUILT_PACKAGE }}-}"
            platform="${platform%.tar.gz}"
            target="$root/$platform"
            mkdir -p "$target"
            tar xzf "$tarball" -C "$target"
            find "$target" -maxdepth 2 -type f | sort
          done

      - name: Commit prebuilts (if changed)
        shell: bash
        run: |
          set -euxo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add packages/server_native/native/prebuilt
          if git diff --cached --quiet; then
            echo "No prebuilt changes to commit."
            exit 0
          fi
          git commit -m "chore(server_native): update prebuilt native libraries"
          git push origin "HEAD:${{ github.event.inputs.target_branch }}"
