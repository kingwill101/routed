name: Benchmark Suite

on:
  push:
    branches:
      - master
      - feat/**
    paths:
      - 'benchmarks/**'
      - 'packages/routed/**'
      - '.github/workflows/benchmark.yml'
  pull_request:
    branches:
      - master
    paths:
      - 'benchmarks/**'
      - 'packages/routed/**'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Benchmark mode (aot, jit, both)'
        required: false
        default: 'aot'
        type: choice
        options:
          - aot
          - jit
          - both
      runs:
        description: 'Number of runs per endpoint'
        required: false
        default: '3'

jobs:
  benchmark:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        dart-version: ['stable']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ matrix.dart-version }}

      - name: Get dependencies
        run: dart pub get

      - name: Get benchmark dependencies
        run: |
          cd benchmarks/servers/dart_io && dart pub get
          cd ../relic && dart pub get
          cd ../serinus && dart pub get
          cd ../shelf && dart pub get
          cd ../routed && dart pub get

      - name: Install wrk
        if: runner.os != 'Windows'
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y wrk
          elif [ "$RUNNER_OS" = "macOS" ]; then
            brew install wrk
          fi
        shell: bash

      - name: Run benchmark (AOT mode - Ubuntu only)
        if: runner.os == 'Linux'
        run: |
          cd benchmarks
          MODE=aot RUNS=2 DURATION=5s ./scripts/full_benchmark.sh
        shell: bash

      - name: Run benchmark (JIT mode)
        if: runner.os != 'Windows'
        run: |
          cd benchmarks
          MODE=jit RUNS=2 DURATION=5s ./scripts/full_benchmark.sh
        shell: bash

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ matrix.os }}-${{ matrix.dart-version }}
          path: benchmarks/results/
          if-no-files-found: ignore
          retention-days: 30

  benchmark-summary:
    runs-on: ubuntu-latest
    needs: benchmark
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate summary
        run: |
          echo "# Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Benchmark runs completed across multiple platforms." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "all-results" ]; then
            for dir in all-results/benchmark-results-*/; do
              platform=$(basename "$dir" | sed 's/benchmark-results-//')
              echo "- [$platform]()" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "No benchmark results found (wrk may not be available on this platform)" >> $GITHUB_STEP_SUMMARY
          fi
